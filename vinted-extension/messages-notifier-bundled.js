
// ==========================================
// VINTED MESSAGE NOTIFIER - BUNDLED VERSION
// Auto-generated by build-messages-notifier.js
// ==========================================

(function() {
  'use strict';
  
  // ==========================================
  // messagesApi.js
  // ==========================================
  
  // Gestion de l'API des messages Vinted

/**
 * Récupère les messages depuis l'API Vinted
 * @param {number} page - Numéro de page
 * @param {number} perPage - Nombre de messages par page
 * @returns {Promise<Object>} - Données des conversations
 */
async function fetchInbox(page = 1, perPage = 20) {
  const url = `https://www.vinted.fr/api/v2/inbox?page=${page}&per_page=${perPage}`;
  
  try {
    const response = await fetch(url, {
      credentials: "include",
      headers: {
        "accept": "application/json, text/plain, */*",
        "accept-language": "fr",
        "sec-fetch-dest": "empty",
        "sec-fetch-mode": "cors",
        "sec-fetch-site": "same-origin",
      },
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    return data;
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de la récupération des messages:", error);
    throw error;
  }
}

/**
 * Filtre les conversations non lues
 * @param {Array} conversations - Liste des conversations
 * @returns {Array} - Conversations non lues
 */
function getUnreadConversations(conversations) {
  return conversations.filter(conv => conv.unread === true);
}

/**
 * Extrait les informations essentielles d'une conversation
 * @param {Object} conversation - Objet conversation
 * @returns {Object} - Informations formatées
 */
function formatConversationInfo(conversation) {
  return {
    id: conversation.id,
    description: conversation.description,
    unread: conversation.unread,
    updated_at: conversation.updated_at,
    opposite_user: {
      id: conversation.opposite_user.id,
      login: conversation.opposite_user.login,
      photo_url: conversation.opposite_user.photo?.thumbnails?.find(t => t.type === "thumb100")?.url || 
                 conversation.opposite_user.photo?.url
    },
    item_photo: conversation.item_photos?.[0]?.thumbnails?.find(t => t.type === "thumb70x100")?.url || 
                conversation.item_photos?.[0]?.url,
    conversation_url: `https://www.vinted.fr/inbox/${conversation.id}`
  };
}

/**
 * Récupère une conversation spécifique depuis l'API Vinted
 * @param {string|number} conversationId - ID de la conversation
 * @returns {Promise<Object>} - Données de la conversation
 */
async function fetchConversation(conversationId, page = 1, perPage = 50) {
  // Essayer d'abord avec la pagination pour récupérer plus de messages
  const url = `https://www.vinted.fr/api/v2/conversations/${conversationId}?page=${page}&per_page=${perPage}`;
  
  try {
    const response = await fetch(url, {
      credentials: "include",
      headers: {
        "accept": "application/json, text/plain, */*",
        "accept-language": "fr",
        "sec-fetch-dest": "empty",
        "sec-fetch-mode": "cors",
        "sec-fetch-site": "same-origin",
      },
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    const conversation = data.conversation || data;
    
    // Si on a récupéré des messages et qu'il y en a plus, essayer de récupérer la page suivante
    if (conversation.messages && conversation.messages.length === perPage) {
      console.log(`[Vinted Messages] ${conversation.messages.length} messages récupérés, tentative de récupérer plus...`);
      try {
        const nextPageResponse = await fetch(`${url}&page=${page + 1}`, {
          credentials: "include",
          headers: {
            "accept": "application/json, text/plain, */*",
            "accept-language": "fr",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "same-origin",
          },
        });
        
        if (nextPageResponse.ok) {
          const nextPageData = await nextPageResponse.json();
          const nextPageConversation = nextPageData.conversation || nextPageData;
          if (nextPageConversation.messages && nextPageConversation.messages.length > 0) {
            // Fusionner les messages (les plus récents en premier dans l'API)
            conversation.messages = [...(nextPageConversation.messages || []), ...conversation.messages];
            console.log(`[Vinted Messages] Total de ${conversation.messages.length} messages récupérés`);
          }
        }
      } catch (e) {
        // Ignorer les erreurs de pagination
        console.log(`[Vinted Messages] Pas de messages supplémentaires disponibles`);
      }
    }
    
    return conversation;
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de la récupération de la conversation:", error);
    throw error;
  }
}

// Variable globale pour stocker le token CSRF intercepté
let cachedCsrfToken = null;
let csrfTokenCacheTime = 0;
const CSRF_TOKEN_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

/**
 * Intercepte les requêtes fetch pour récupérer le token CSRF
 */
function interceptFetchForCsrfToken() {
  if (window._vintedCsrfIntercepted) return;
  window._vintedCsrfIntercepted = true;
  
  const originalFetch = window.fetch;
  window.fetch = function(...args) {
    const [url, options = {}] = args;
    
    // Si c'est une requête vers l'API Vinted avec un header x-csrf-token
    if (typeof url === 'string' && url.includes('vinted.fr/api') && options.headers) {
      // Vérifier différents formats de headers
      let csrfToken = null;
      
      if (options.headers instanceof Headers) {
        csrfToken = options.headers.get('x-csrf-token') || options.headers.get('X-CSRF-Token');
      } else if (typeof options.headers === 'object') {
        csrfToken = options.headers['x-csrf-token'] || 
                   options.headers['X-CSRF-Token'] ||
                   options.headers['X-Csrf-Token'];
      }
      
      if (csrfToken) {
        cachedCsrfToken = csrfToken;
        csrfTokenCacheTime = Date.now();
      }
    }
    
    // Intercepter aussi les réponses de scripts JavaScript pour chercher CSRF_TOKEN
    if (typeof url === 'string' && (url.includes('.js') || url.includes('chunks'))) {
      const promise = originalFetch.apply(this, args);
      promise.then(async response => {
        if (response.ok) {
          try {
            const text = await response.clone().text();
            // Chercher CSRF_TOKEN dans le contenu du script
            const patterns = [
              /CSRF_TOKEN["\s:=]+["']([a-f0-9-]{36,})["']/i,
              /csrf[_-]?token["\s:=]+["']([a-f0-9-]{36,})["']/i
            ];
            
            for (const pattern of patterns) {
              const match = text.match(pattern);
              if (match && match[1] && match[1].length > 20 && !cachedCsrfToken) {
                cachedCsrfToken = match[1];
                csrfTokenCacheTime = Date.now();
                break;
              }
            }
          } catch (e) {
            // Ignorer les erreurs de lecture
          }
        }
      }).catch(() => {});
      return promise;
    }
    
    return originalFetch.apply(this, args);
  };
  
  // Intercepter aussi XMLHttpRequest
  if (window.XMLHttpRequest) {
    const originalOpen = XMLHttpRequest.prototype.open;
    const originalSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;
    
    XMLHttpRequest.prototype.setRequestHeader = function(header, value) {
      if (header.toLowerCase() === 'x-csrf-token' && value) {
        cachedCsrfToken = value;
      }
      return originalSetRequestHeader.apply(this, arguments);
    };
  }
}

/**
 * Récupère le token CSRF depuis les cookies ou les meta tags
 * @returns {Promise<string|null>} - Token CSRF
 */
async function getCsrfToken() {
  // Méthode 1: Depuis le cache (intercepté depuis une requête) - avec expiration
  const now = Date.now();
  if (cachedCsrfToken && (now - csrfTokenCacheTime) < CSRF_TOKEN_CACHE_DURATION) {
    return cachedCsrfToken;
  }
  // Cache expiré, le vider
  if (cachedCsrfToken && (now - csrfTokenCacheTime) >= CSRF_TOKEN_CACHE_DURATION) {
    cachedCsrfToken = null;
    csrfTokenCacheTime = 0;
  }
  
  // Méthode 2: Extraire le token CSRF depuis les scripts inline de la page
  // Le token est dans un script avec pattern: "CSRF_TOKEN":"[token]" dans __next_f.push
  try {
    const scripts = document.querySelectorAll('script:not([src])');
    for (const script of scripts) {
      const scriptContent = script.textContent || script.innerHTML;
      if (scriptContent && scriptContent.includes('CSRF_TOKEN')) {
        // Pattern principal: "CSRF_TOKEN":"[token]" ou CSRF_TOKEN":"[token]" (avec/sans guillemets)
        const patterns = [
          /"CSRF_TOKEN"\s*:\s*"([a-f0-9-]{36,})"/i,
          /CSRF_TOKEN"\s*:\s*"([a-f0-9-]{36,})"/i,
          /CSRF_TOKEN[\\"]*:\s*[\\"]*([a-f0-9-]{36,})/i
        ];
        
        for (const pattern of patterns) {
          const match = scriptContent.match(pattern);
          if (match && match[1] && match[1].length > 20) {
            cachedCsrfToken = match[1];
            csrfTokenCacheTime = Date.now();
            return match[1];
          }
        }
      }
    }
    
    // Fallback: Chercher dans le HTML complet
    const htmlContent = document.documentElement.outerHTML || document.body.innerHTML;
    if (htmlContent.includes('CSRF_TOKEN')) {
      const htmlMatch = htmlContent.match(/"CSRF_TOKEN"\s*:\s*"([a-f0-9-]{36,})"/i);
      if (htmlMatch && htmlMatch[1] && htmlMatch[1].length > 20) {
        cachedCsrfToken = htmlMatch[1];
        csrfTokenCacheTime = Date.now();
        return htmlMatch[1];
      }
    }
  } catch (e) {
    // Ignorer les erreurs
  }
  
  // Méthode 3: Depuis window.__NEXT_DATA__?.env (fallback)
  if (window.__NEXT_DATA__?.env?.CSRF_TOKEN) {
    const token = window.__NEXT_DATA__.env.CSRF_TOKEN;
    if (token && typeof token === 'string' && token.length > 20) {
      cachedCsrfToken = token;
      csrfTokenCacheTime = Date.now();
      return token;
    }
  }
  
  return null;
}

// Initialiser l'interception au chargement
if (typeof window !== 'undefined') {
  interceptFetchForCsrfToken();
}

/**
 * Récupère l'anon_id depuis les cookies
 * @returns {string|null} - Anon ID
 */
function getAnonId() {
  const cookies = document.cookie.split(';');
  for (const cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'anon_id') {
      return decodeURIComponent(value);
    }
  }
  return null;
}

/**
 * Envoie un message dans une conversation
 * @param {string|number} conversationId - ID de la conversation
 * @param {string} messageBody - Corps du message
 * @returns {Promise<Object>} - Réponse de l'API
 */
async function sendMessage(conversationId, messageBody) {
  console.log("[Vinted Messages] sendMessage appelé avec conversationId:", conversationId, "messageBody:", messageBody?.substring(0, 50));
  
  const url = `https://www.vinted.fr/api/v2/conversations/${conversationId}/replies`;
  console.log("[Vinted Messages] URL de la requête:", url);
  
  // Récupérer le token CSRF et l'anon_id
  console.log("[Vinted Messages] Récupération du token CSRF...");
  let csrfToken = await getCsrfToken();
  console.log("[Vinted Messages] Token CSRF récupéré:", csrfToken ? csrfToken.substring(0, 8) + '...' : 'null');
  
  const anonId = getAnonId();
  console.log("[Vinted Messages] Anon ID:", anonId || 'non trouvé');
  
  // Si pas de token, essayer de le récupérer depuis la page inbox
  if (!csrfToken) {
    console.warn("[Vinted Messages] Token CSRF non trouvé, tentative de récupération depuis la page...");
    csrfToken = await tryGetCsrfTokenFromPage();
    if (csrfToken) {
      cachedCsrfToken = csrfToken;
      csrfTokenCacheTime = Date.now();
      console.log("[Vinted Messages] Token CSRF récupéré depuis la page");
    }
  }
  
  if (!csrfToken) {
    const error = "Impossible de récupérer le token CSRF. Veuillez recharger la page et réessayer.";
    console.error("[Vinted Messages]", error);
    throw new Error(error);
  }
  
  console.log("[Vinted Messages] Envoi du message avec token CSRF:", csrfToken.substring(0, 8) + '...');
  
  const payload = {
    reply: {
      body: messageBody,
      photo_temp_uuids: null,
      is_personal_data_sharing_check_skipped: false
    }
  };
  
  try {
    // Récupérer le cookie DataDome si disponible
    const getCookie = (name) => {
      const cookies = document.cookie.split(';');
      for (const cookie of cookies) {
        const [cookieName, value] = cookie.trim().split('=');
        if (cookieName === name) {
          return decodeURIComponent(value);
        }
      }
      return null;
    };
    
    const headers = {
      "content-type": "application/json",
      "x-csrf-token": csrfToken,
    };
    
    // Ajouter l'anon_id si disponible (optionnel mais peut aider)
    if (anonId) {
      headers["x-anon-id"] = anonId;
    }
    
    // S'assurer que les cookies (y compris DataDome) sont inclus
    const fetchOptions = {
      method: "POST",
      credentials: "include", // Inclut automatiquement les cookies (y compris DataDome)
      headers: headers,
      body: JSON.stringify(payload),
      mode: "cors",
      cache: "no-cache",
    };
    
    const response = await fetch(url, fetchOptions);

    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch {
        const errorText = await response.text();
        errorData = { message: errorText };
      }
      console.error("[Vinted Messages] Erreur API:", errorData);
      
      // Si c'est une erreur d'accès refusé, essayer de récupérer le token depuis la page
      if (errorData.code === 106 || response.status === 403) {
        console.warn("[Vinted Messages] Accès refusé, tentative de récupération du token CSRF depuis la page");
        
        // Recharger la page pour récupérer le token (ou essayer une autre méthode)
        const newCsrfToken = await tryGetCsrfTokenFromPage();
        if (newCsrfToken && newCsrfToken !== csrfToken) {
          headers["x-csrf-token"] = newCsrfToken;
          // Réessayer avec le nouveau token
          const retryResponse = await fetch(url, {
            method: "POST",
            credentials: "include",
            headers: headers,
            body: JSON.stringify(payload),
          });
          
          if (!retryResponse.ok) {
            let retryError;
            try {
              retryError = await retryResponse.json();
            } catch {
              const retryErrorText = await retryResponse.text();
              retryError = { message: retryErrorText };
            }
            throw new Error(`HTTP ${retryResponse.status}: ${JSON.stringify(retryError)}`);
          }
          
          return await retryResponse.json();
        }
      }
      
      throw new Error(`HTTP ${response.status}: ${JSON.stringify(errorData)}`);
    }

    const data = await response.json();
    return data;
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de l'envoi du message:", error);
    throw error;
  }
}

/**
 * Essaie de récupérer le token CSRF depuis la page en faisant une requête
 */
async function tryGetCsrfTokenFromPage() {
  try {
    // Essayer de récupérer depuis la page inbox
    const inboxResponse = await fetch('https://www.vinted.fr/inbox', {
      credentials: "include",
      headers: {
        "accept": "text/html,application/xhtml+xml",
      },
    });
    
    if (inboxResponse.ok) {
      const html = await inboxResponse.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // Chercher dans les meta tags (tous les variants)
      const metaSelectors = [
        'meta[name="csrf-token"]',
        'meta[name="csrf_token"]',
        'meta[name="CSRF-Token"]',
        'meta[property="csrf-token"]'
      ];
      
      for (const selector of metaSelectors) {
        const metaTag = doc.querySelector(selector);
        if (metaTag) {
          const token = metaTag.getAttribute('content');
          if (token && token.length > 20) {
            return token;
          }
        }
      }
      
      // Chercher dans les attributs data
      const dataTag = doc.querySelector('[data-csrf-token], body[data-csrf-token], html[data-csrf-token]');
      if (dataTag) {
        const token = dataTag.getAttribute('data-csrf-token') || 
                     dataTag.getAttribute('data-csrf_token') ||
                     dataTag.getAttribute('data-csrf');
        if (token && token.length > 20) {
          return token;
        }
      }
      
      // Chercher dans le HTML avec des patterns améliorés
      const patterns = [
        /csrf[_-]?token["\s:=]+["']?([a-f0-9-]{36,})["']?/i,
        /["']x-csrf-token["']\s*:\s*["']([a-f0-9-]{36,})["']/i,
        /x-csrf-token["\s:=]+["']?([a-f0-9-]{36,})["']?/i,
        /csrfToken["\s:=]+["']?([a-f0-9-]{36,})["']?/i,
        /csrf_token["\s:=]+["']?([a-f0-9-]{36,})["']?/i
      ];
      
      for (const pattern of patterns) {
        const match = html.match(pattern);
        if (match && match[1] && match[1].length > 20) {
          return match[1];
        }
      }
    }
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de la récupération du token:", error);
  }
  
  return null;
}

/**
 * Envoie une demande d'offre pour une transaction
 * @param {string|number} transactionId - ID de la transaction
 * @param {string} price - Prix de l'offre
 * @param {string} currency - Devise (par défaut: EUR)
 * @returns {Promise<Object>} - Réponse de l'API
 */
async function sendOfferRequest(transactionId, price, currency = "EUR") {
  const url = `https://www.vinted.fr/api/v2/transactions/${transactionId}/offer_requests`;
  
  let csrfToken = await getCsrfToken();
  const anonId = getAnonId();
  
  if (!csrfToken) {
    csrfToken = await tryGetCsrfTokenFromPage();
    if (csrfToken) {
      cachedCsrfToken = csrfToken;
      csrfTokenCacheTime = Date.now();
    }
  }
  
  if (!csrfToken) {
    throw new Error("Impossible de récupérer le token CSRF. Veuillez recharger la page et réessayer.");
  }
  
  const payload = {
    offer_request: {
      price: price.toString(),
      currency: currency
    }
  };
  
  const headers = {
    "content-type": "application/json",
    "x-csrf-token": csrfToken,
  };
  
  if (anonId) {
    headers["x-anon-id"] = anonId;
  }
  
  const fetchOptions = {
    method: "POST",
    credentials: "include",
    headers: headers,
    body: JSON.stringify(payload),
    mode: "cors",
    cache: "no-cache",
  };
  
  try {
    const response = await fetch(url, fetchOptions);
    
    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch (e) {
        errorData = { message: await response.text() };
      }
      
      if (response.status === 403 || (errorData.code === 106)) {
        cachedCsrfToken = null;
        csrfTokenCacheTime = 0;
        const newToken = await tryGetCsrfTokenFromPage();
        if (newToken) {
          cachedCsrfToken = newToken;
          csrfTokenCacheTime = Date.now();
          headers["x-csrf-token"] = newToken;
          const retryResponse = await fetch(url, fetchOptions);
          if (!retryResponse.ok) {
            throw new Error(`HTTP ${retryResponse.status}: ${JSON.stringify(await retryResponse.json())}`);
          }
          return await retryResponse.json();
        }
      }
      
      throw new Error(`HTTP ${response.status}: ${JSON.stringify(errorData)}`);
    }
    
    const data = await response.json();
    return data;
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de l'envoi de l'offre:", error);
    throw error;
  }
}

/**
 * Récupère les détails d'un produit depuis la page Vinted
 * @param {string|number} itemId - ID du produit
 * @param {string} itemSlug - Nom/slug du produit (optionnel)
 * @returns {Promise<Object>} - Données du produit
 */
/**
 * Crée une conversation pour un item
 * @param {string|number} itemId - ID du produit
 * @param {string|number} userId - ID du vendeur (opposite_user_id)
 * @param {string} messageBody - Corps du message (optionnel, pour envoyer un message après création)
 * @param {Object} item - Données du produit (optionnel)
 * @returns {Promise<Object>} - Données de la conversation créée avec l'ID
 */
async function createConversationForItem(itemId, userId, messageBody, item) {
  // Utiliser la nouvelle API pour créer une conversation
  const url = `https://www.vinted.fr/api/v2/conversations`;
  
  let csrfToken = await getCsrfToken();
  if (!csrfToken) {
    csrfToken = await tryGetCsrfTokenFromPage();
    if (csrfToken) {
      cachedCsrfToken = csrfToken;
      csrfTokenCacheTime = Date.now();
    }
  }
  
  if (!csrfToken) {
    throw new Error("Impossible de récupérer le token CSRF. Veuillez recharger la page et réessayer.");
  }
  
  // Payload selon la nouvelle API
  const payload = {
    initiator: "ask_seller",
    item_id: String(itemId),
    opposite_user_id: String(userId)
  };
  
  const headers = {
    "content-type": "application/json",
    "x-csrf-token": csrfToken,
    "accept": "application/json, text/plain, */*",
  };
  
  const anonId = getAnonId();
  if (anonId) {
    headers["x-anon-id"] = anonId;
  }
  
  try {
    const response = await fetch(url, {
      method: "POST",
      credentials: "include",
      headers: headers,
      body: JSON.stringify(payload),
      mode: "cors",
      cache: "no-cache",
    });
    
    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch (e) {
        errorData = { message: await response.text() };
      }
      
      if (response.status === 403 || (errorData.code === 106)) {
        cachedCsrfToken = null;
        csrfTokenCacheTime = 0;
        const newToken = await tryGetCsrfTokenFromPage();
        if (newToken) {
          cachedCsrfToken = newToken;
          csrfTokenCacheTime = Date.now();
          headers["x-csrf-token"] = newToken;
          const retryResponse = await fetch(url, {
            method: "POST",
            credentials: "include",
            headers: headers,
            body: JSON.stringify(payload),
          });
          if (!retryResponse.ok) {
            throw new Error(`HTTP ${retryResponse.status}: ${JSON.stringify(await retryResponse.json())}`);
          }
          const retryData = await retryResponse.json();
          const conversation = retryData.conversation || retryData;
          
          // Si un message est fourni, l'envoyer après la création de la conversation
          if (messageBody && conversation.id) {
            try {
              await sendMessage(conversation.id, messageBody);
            } catch (msgError) {
              console.warn("[Vinted Messages] Conversation créée mais échec de l'envoi du message initial:", msgError);
            }
          }
          
          return conversation;
        }
      }
      
      throw new Error(`HTTP ${response.status}: ${JSON.stringify(errorData)}`);
    }
    
    const data = await response.json();
    console.log("[Vinted Messages] Réponse de création de conversation:", data);
    const conversation = data.conversation || data;
    console.log("[Vinted Messages] Conversation extraite:", conversation);
    
    if (!conversation || !conversation.id) {
      console.error("[Vinted Messages] La conversation créée n'a pas d'ID:", conversation);
      throw new Error("La conversation créée n'a pas d'ID valide");
    }
    
    // Si un message est fourni, l'envoyer après la création de la conversation
    if (messageBody && conversation.id) {
      try {
        await sendMessage(conversation.id, messageBody);
        console.log("[Vinted Messages] Message initial envoyé avec succès");
      } catch (msgError) {
        console.warn("[Vinted Messages] Conversation créée mais échec de l'envoi du message initial:", msgError);
      }
    }
    
    return conversation;
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de la création de la conversation:", error);
    throw error;
  }
}

/**
 * Crée une transaction pour un item afin de pouvoir faire une offre
 * @param {string|number} itemId - ID du produit
 * @param {number} price - Prix proposé
 * @returns {Promise<Object>} - Données de la transaction créée
 */
async function createTransactionForItem(itemId, price) {
  // Utiliser l'API de transaction de Vinted
  const url = `https://www.vinted.fr/api/v2/items/${itemId}/transactions`;
  
  let csrfToken = await getCsrfToken();
  if (!csrfToken) {
    csrfToken = await tryGetCsrfTokenFromPage();
    if (csrfToken) {
      cachedCsrfToken = csrfToken;
      csrfTokenCacheTime = Date.now();
    }
  }
  
  if (!csrfToken) {
    throw new Error("Impossible de récupérer le token CSRF. Veuillez recharger la page et réessayer.");
  }
  
  const payload = {
    transaction: {
      price: price.toString(),
      currency: "EUR"
    }
  };
  
  const headers = {
    "content-type": "application/json",
    "x-csrf-token": csrfToken,
    "accept": "application/json, text/plain, */*",
  };
  
  const anonId = getAnonId();
  if (anonId) {
    headers["x-anon-id"] = anonId;
  }
  
  try {
    const response = await fetch(url, {
      method: "POST",
      credentials: "include",
      headers: headers,
      body: JSON.stringify(payload),
      mode: "cors",
      cache: "no-cache",
    });
    
    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch (e) {
        errorData = { message: await response.text() };
      }
      
      if (response.status === 403 || (errorData.code === 106)) {
        cachedCsrfToken = null;
        csrfTokenCacheTime = 0;
        const newToken = await tryGetCsrfTokenFromPage();
        if (newToken) {
          cachedCsrfToken = newToken;
          csrfTokenCacheTime = Date.now();
          headers["x-csrf-token"] = newToken;
          const retryResponse = await fetch(url, {
            method: "POST",
            credentials: "include",
            headers: headers,
            body: JSON.stringify(payload),
          });
          if (!retryResponse.ok) {
            throw new Error(`HTTP ${retryResponse.status}: ${JSON.stringify(await retryResponse.json())}`);
          }
          return await retryResponse.json();
        }
      }
      
      throw new Error(`HTTP ${response.status}: ${JSON.stringify(errorData)}`);
    }
    
    const data = await response.json();
    return data.transaction || data;
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de la création de la transaction:", error);
    throw error;
  }
}

async function fetchItemDetails(itemId, itemSlug = '') {
  console.log(`[Vinted Item] Début de la récupération des détails pour l'item ${itemId}${itemSlug ? ` (slug: ${itemSlug})` : ''}`);
  
  // Construire l'URL de la page avec l'ID et le slug si disponible
  const url = itemSlug 
    ? `https://www.vinted.fr/items/${itemId}-${itemSlug}`
    : `https://www.vinted.fr/items/${itemId}`;
  
  console.log(`[Vinted Item] URL de la requête: ${url}`);
  
  try {
    console.log(`[Vinted Item] Envoi de la requête HTTP...`);
    const response = await fetch(url, {
      credentials: "include",
      headers: {
        "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "accept-language": "fr",
        "sec-fetch-dest": "document",
        "sec-fetch-mode": "navigate",
        "sec-fetch-site": "same-origin",
      },
    });

    console.log(`[Vinted Item] Réponse reçue - Status: ${response.status} ${response.statusText}`);

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    console.log(`[Vinted Item] Récupération du HTML...`);
    const html = await response.text();
    console.log(`[Vinted Item] HTML récupéré - Taille: ${(html.length / 1024).toFixed(2)} KB`);
    
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    console.log(`[Vinted Item] HTML parsé en DOM`);
    
    // Initialiser l'objet item
    const itemData = {
      id: parseInt(itemId),
      title: '',
      description: '',
      price: null,
      currency: 'EUR',
      size: null,
      size_title: null,
      condition: null,
      condition_title: null,
      brand: null,
      brand_title: null,
      color: null,
      photos: [],
      user: null,
      status: null,
      is_sold: false
    };
    
    // Extraire les informations depuis le DOM de la page
    console.log(`[Vinted Item] Extraction depuis le DOM de la page...`);
    
    // Titre depuis data-testid="item-page-summary-plugin"
    const summaryPlugin = doc.querySelector('[data-testid="item-page-summary-plugin"]');
    if (summaryPlugin) {
      const titleElement = summaryPlugin.querySelector('h1.web_ui__Text__title');
      if (titleElement && !itemData.title) {
        itemData.title = titleElement.textContent?.trim() || '';
        console.log(`[Vinted Item] ✓ Titre extrait depuis DOM: "${itemData.title}"`);
      }
      
      // Taille, État, Marque depuis les spans dans summaryPlugin
      // La structure est : [Taille] · [État] · [Marque (lien)]
      const summarySpans = summaryPlugin.querySelectorAll('span.web_ui__Text__body');
      const summaryTexts = [];
      
      // Parcourir les spans et extraire les textes (en excluant les séparateurs "·")
      for (const span of summarySpans) {
        const text = span.textContent?.trim();
        // Ignorer les séparateurs "·" et les espaces vides
        if (text && text !== '·' && text.length > 0) {
          summaryTexts.push({ text, element: span });
        }
      }
      
      // La taille est généralement le premier élément qui n'est pas dans un lien et qui n'est pas l'état
      // Format possible : "W31 | FR 40", "XL", "42", etc.
      for (const { text, element } of summaryTexts) {
        // Ignorer si c'est dans un lien (c'est la marque)
        if (element.closest('a')) {
          continue;
        }
        
        // Ignorer si c'est l'état (contient "état", "neuf", "bon", etc.)
        if (/état|neuf|bon|moyen|satisfaisant/i.test(text)) {
          continue;
        }
        
        // Si ce n'est ni un lien ni l'état, c'est probablement la taille
        if (!itemData.size_title) {
          itemData.size_title = text;
          itemData.size = { title: text, localized_title: text };
          console.log(`[Vinted Item] ✓ Taille extraite depuis DOM: "${text}"`);
          break;
        }
      }
      
      // Chercher l'état (généralement contient "état" ou des valeurs comme "Neuf", "Très bon état", etc.)
      for (const { text, element } of summaryTexts) {
        // Ignorer si c'est dans un lien
        if (element.closest('a')) {
          continue;
        }
        
        if (/état|neuf|bon|moyen|satisfaisant/i.test(text) && !itemData.condition_title) {
          itemData.condition_title = text;
          itemData.condition = { title: text, translated_title: text };
          console.log(`[Vinted Item] ✓ État extrait depuis DOM: "${text}"`);
          break;
        }
      }
      
      // Marque depuis le lien <a>
      const brandLink = summaryPlugin.querySelector('a[href*="/brand/"]');
      if (brandLink) {
        const brandText = brandLink.textContent?.trim();
        if (brandText && !itemData.brand_title) {
          itemData.brand_title = brandText;
          // Extraire l'ID de la marque depuis l'URL
          const brandHref = brandLink.getAttribute('href');
          const brandIdMatch = brandHref?.match(/\/brand\/(\d+)-/);
          if (brandIdMatch) {
            itemData.brand = {
              id: parseInt(brandIdMatch[1]),
              title: brandText,
              name: brandText
            };
          } else {
            itemData.brand = {
              title: brandText,
              name: brandText
            };
          }
          console.log(`[Vinted Item] ✓ Marque extraite depuis DOM: "${brandText}"`);
        }
      }
    }
    
    // Prix depuis data-testid="item-price"
    const priceContainer = doc.querySelector('[data-testid="item-price"]');
    if (priceContainer) {
      const priceElement = priceContainer.querySelector('p.web_ui__Text__subtitle');
      if (priceElement) {
        const priceText = priceElement.textContent?.trim();
        // Extraire le montant (ex: "18,00 €")
        const priceMatch = priceText?.match(/([\d\s,]+)\s*([€$£]|EUR|USD|GBP)/);
        if (priceMatch) {
          const amount = priceMatch[1].replace(/\s/g, '').replace(',', '.');
          const currency = priceMatch[2] === '€' ? 'EUR' : (priceMatch[2] || 'EUR');
          if (!itemData.price) {
            itemData.price = {
              amount: amount,
              currency_code: currency
            };
            itemData.currency = currency;
            console.log(`[Vinted Item] ✓ Prix extrait depuis DOM: ${amount} ${currency}`);
          }
        }
      }
    }
    
    // Prix avec protection depuis le button avec aria-label
    const priceWithProtectionButton = doc.querySelector('button[aria-label*="Protection acheteurs incluse"]');
    if (priceWithProtectionButton) {
      const priceWithProtectionText = priceWithProtectionButton.querySelector('.web_ui__Text__title')?.textContent?.trim();
      if (priceWithProtectionText) {
        const priceMatch = priceWithProtectionText.match(/([\d\s,]+)\s*([€$£]|EUR|USD|GBP)/);
        if (priceMatch) {
          const amount = priceMatch[1].replace(/\s/g, '').replace(',', '.');
          itemData.price_with_protection = {
            amount: amount,
            currency_code: itemData.currency || 'EUR'
          };
          console.log(`[Vinted Item] ✓ Prix avec protection extrait depuis DOM: ${amount} ${itemData.currency || 'EUR'}`);
        }
      }
    }
    
    // Prix avec frais depuis le sélecteur spécifique
    const priceWithFeesElement = doc.querySelector('.web_ui__Text__text.web_ui__Text__title.web_ui__Text__left.web_ui__Text__clickable.web_ui__Text__underline-none');
    if (priceWithFeesElement) {
      const priceWithFeesText = priceWithFeesElement.textContent?.trim();
      if (priceWithFeesText) {
        const priceMatch = priceWithFeesText.match(/([\d\s,]+)\s*([€$£]|EUR|USD|GBP)/);
        if (priceMatch) {
          const amount = priceMatch[1].replace(/\s/g, '').replace(',', '.');
          itemData.price_with_fees = {
            amount: amount,
            currency_code: itemData.currency || 'EUR',
            formatted: priceWithFeesText
          };
          console.log(`[Vinted Item] ✓ Prix avec frais extrait depuis DOM: ${priceWithFeesText}`);
        }
      }
    }
    
    // Récupérer les scripts une seule fois pour toutes les extractions
    const scripts = doc.querySelectorAll('script');
    
    // Informations du vendeur depuis le DOM
    const profileUsername = doc.querySelector('[data-testid="profile-username"]');
    if (profileUsername) {
      const username = profileUsername.textContent?.trim();
      if (username) {
        if (!itemData.user) {
          itemData.user = {};
        }
        itemData.user.login = username;
        itemData.user.username = username;
        console.log(`[Vinted Item] ✓ Nom d'utilisateur vendeur extrait depuis DOM: "${username}"`);
      }
    }
    
    // Essayer d'extraire l'ID du vendeur depuis le lien du profil
    if (!itemData.user?.id) {
      const profileLink = doc.querySelector('a[href*="/members/"]');
      if (profileLink) {
        const href = profileLink.getAttribute('href');
        const memberMatch = href.match(/\/members\/(\d+)/);
        if (memberMatch) {
          if (!itemData.user) {
            itemData.user = {};
          }
          itemData.user.id = parseInt(memberMatch[1]);
          console.log(`[Vinted Item] ✓ ID vendeur extrait depuis lien profil: ${itemData.user.id}`);
        }
      }
    }
    
    // Essayer d'extraire depuis les scripts avec d'autres patterns
    if (!itemData.user?.id) {
      for (const script of scripts) {
        const content = script.textContent || script.innerHTML;
        // Chercher "user_id" ou "seller_id" dans les scripts
        const userIdMatch = content.match(/(?:user_id|seller_id)["\s:]+(\d+)/);
        if (userIdMatch) {
          if (!itemData.user) {
            itemData.user = {};
          }
          itemData.user.id = parseInt(userIdMatch[1]);
          console.log(`[Vinted Item] ✓ ID vendeur extrait depuis scripts: ${itemData.user.id}`);
          break;
        }
      }
    }
    
    // Note du vendeur depuis aria-label du rating
    const ratingElement = doc.querySelector('.web_ui__Rating__rating[aria-label]');
    if (ratingElement) {
      const ariaLabel = ratingElement.getAttribute('aria-label');
      if (ariaLabel) {
        // Extraire la note depuis "Le membre est noté 5 sur 5"
        const ratingMatch = ariaLabel.match(/(\d+)\s+sur\s+(\d+)/i);
        if (ratingMatch) {
          const rating = parseFloat(ratingMatch[1]);
          const maxRating = parseFloat(ratingMatch[2]);
          if (!itemData.user) {
            itemData.user = {};
          }
          itemData.user.rating = rating;
          itemData.user.max_rating = maxRating;
          console.log(`[Vinted Item] ✓ Note vendeur extraite depuis DOM: ${rating}/${maxRating}`);
        }
      }
      
      // Nombre d'avis depuis .web_ui__Rating__label
      const ratingLabel = ratingElement.querySelector('.web_ui__Rating__label span');
      if (ratingLabel) {
        const reviewCountText = ratingLabel.textContent?.trim();
        if (reviewCountText) {
          const reviewCount = parseInt(reviewCountText);
          if (!isNaN(reviewCount)) {
            if (!itemData.user) {
              itemData.user = {};
            }
            itemData.user.review_count = reviewCount;
            console.log(`[Vinted Item] ✓ Nombre d'avis vendeur extrait depuis DOM: ${reviewCount}`);
          }
        }
      }
    }
    
    // 1. Extraire depuis __next_f.push avec la clé "15:"
    // Cette clé contient les plugins et l'objet item complet
    console.log(`[Vinted Item] Recherche de la section "15:[" dans les scripts...`);
    console.log(`[Vinted Item] Nombre de scripts trouvés: ${scripts.length}`);
    
    let section15Found = false;
    for (const script of scripts) {
      const content = script.textContent || script.innerHTML;
      
      // Chercher la ligne avec "15:[" qui contient les plugins et l'item
      if (content.includes('__next_f.push') && content.includes('"15:[')) {
        console.log(`[Vinted Item] Script avec __next_f.push et "15:[" trouvé`);
        try {
          // Extraire toute la section "15:[" jusqu'à la fin
          const match15 = content.match(/"15:\[([^\]]+)\]/);
          if (!match15) {
            console.log(`[Vinted Item] Pattern "15:[" non trouvé dans ce script`);
            continue;
          }
          
          console.log(`[Vinted Item] Section "15:[" trouvée - Taille: ${match15[0].length} caractères`);
          section15Found = true;
          const section15 = match15[0];
          
          // Extraire depuis plugins - chercher dans toute la section
          console.log(`[Vinted Item] Extraction des données depuis la section "15:["...`);
          
          // Titre depuis summary plugin
          const summaryTitleMatch = section15.match(/\{"name":"summary"[^}]*"value":"([^"]+)"[^}]*"style":"title"/);
          if (summaryTitleMatch && !itemData.title) {
            itemData.title = summaryTitleMatch[1];
            console.log(`[Vinted Item] ✓ Titre extrait depuis summary plugin: "${itemData.title.substring(0, 50)}..."`);
          }
          
          // Taille depuis attributes plugin
          const sizeAttrMatch = section15.match(/\{"type":"faq","code":"size"[^}]*"value":"([^"]+)"/);
          if (sizeAttrMatch) {
            itemData.size_title = sizeAttrMatch[1];
            itemData.size = { title: sizeAttrMatch[1], localized_title: sizeAttrMatch[1] };
            console.log(`[Vinted Item] ✓ Taille extraite: ${itemData.size_title}`);
          }
          
          // État depuis attributes plugin
          const statusAttrMatch = section15.match(/\{"type":"faq","code":"status"[^}]*"value":"([^"]+)"/);
          if (statusAttrMatch) {
            itemData.condition_title = statusAttrMatch[1];
            itemData.condition = { title: statusAttrMatch[1], translated_title: statusAttrMatch[1] };
            console.log(`[Vinted Item] ✓ État extrait: ${itemData.condition_title}`);
          }
          
          // Couleur depuis attributes plugin
          const colorAttrMatch = section15.match(/\{"type":"text","code":"color"[^}]*"value":"([^"]+)"/);
          if (colorAttrMatch) {
            itemData.color = colorAttrMatch[1];
            console.log(`[Vinted Item] ✓ Couleur extraite: ${itemData.color}`);
          }
          
          // Marque depuis attributes plugin
          const brandAttrMatch = section15.match(/\{"type":"favouritable","code":"brand"[^}]*"value":"([^"]+)"[^}]*"id":(\d+)/);
          if (brandAttrMatch) {
            itemData.brand = {
              id: parseInt(brandAttrMatch[2]),
              title: brandAttrMatch[1],
              name: brandAttrMatch[1]
            };
            itemData.brand_title = brandAttrMatch[1];
            console.log(`[Vinted Item] ✓ Marque extraite: ${itemData.brand_title} (ID: ${itemData.brand.id})`);
          }
          
          // Description depuis description plugin
          const descPluginMatch = section15.match(/\{"name":"description"[^}]*"description":"((?:[^"\\]|\\.)*)"/);
          if (descPluginMatch) {
            let desc = descPluginMatch[1];
            desc = desc.replace(/\\n/g, '\n');
            desc = desc.replace(/\\"/g, '"');
            desc = desc.replace(/\\\\/g, '\\');
            itemData.description = desc;
            console.log(`[Vinted Item] ✓ Description extraite - Longueur: ${itemData.description.length} caractères`);
          }
          
          // Extraire l'objet item complet - chercher "item":{...} dans toute la section
          console.log(`[Vinted Item] Extraction de l'objet item complet...`);
          
          // ID
          const idMatch = section15.match(/"item"\s*:\s*\{[^}]*"id"\s*:\s*(\d+)/);
          if (idMatch) {
            itemData.id = parseInt(idMatch[1]);
            console.log(`[Vinted Item] ✓ ID extrait: ${itemData.id}`);
          }
          
          // Titre depuis item
          const titleMatch = section15.match(/"item"\s*:\s*\{[^}]*"title"\s*:\s*"([^"]+)"/);
          if (titleMatch && !itemData.title) {
            itemData.title = titleMatch[1];
            console.log(`[Vinted Item] ✓ Titre extrait depuis item: "${itemData.title.substring(0, 50)}..."`);
          }
          
          // Prix depuis item
          const priceMatch = section15.match(/"price"\s*:\s*\{[^}]*"amount"\s*:\s*"([^"]+)"[^}]*"currency_code"\s*:\s*"([^"]+)"/);
          if (priceMatch) {
            itemData.price = {
              amount: priceMatch[1],
              currency_code: priceMatch[2] || 'EUR'
            };
            console.log(`[Vinted Item] ✓ Prix extrait: ${itemData.price.amount} ${itemData.price.currency_code}`);
          }
          
          // Photos depuis item - chercher toutes les occurrences
          // Utiliser un seul pattern qui capture à la fois l'URL et is_main dans le même objet JSON
          const photoMatches = section15.matchAll(/\{"url"\s*:\s*"([^"]+)"[^}]*"is_main"\s*:\s*(true|false)[^}]*\}/g);
          
          const photoArray = Array.from(photoMatches);
          console.log(`[Vinted Item] Photos trouvées dans la section: ${photoArray.length}`);
          
          if (photoArray.length > 0) {
            itemData.photos = photoArray.map(match => ({
              url: match[1],
              is_main: match[2] === 'true'
            }));
            console.log(`[Vinted Item] ✓ ${itemData.photos.length} photo(s) extraite(s)`);
          }
          
          // Marque (brand_dto) depuis item
          const brandDtoMatch = section15.match(/"brand_dto"\s*:\s*\{[^}]*"id"\s*:\s*(\d+)[^}]*"title"\s*:\s*"([^"]+)"/);
          if (brandDtoMatch && !itemData.brand) {
            itemData.brand = {
              id: parseInt(brandDtoMatch[1]),
              title: brandDtoMatch[2],
              name: brandDtoMatch[2]
            };
            itemData.brand_title = brandDtoMatch[2];
            console.log(`[Vinted Item] ✓ Marque (brand_dto) extraite: ${itemData.brand_title} (ID: ${itemData.brand.id})`);
          }
          
          // Vendeur depuis item - chercher plusieurs patterns
          let sellerIdMatch = section15.match(/"seller_id"\s*:\s*(\d+)/);
          // Si pas trouvé, chercher dans "user_id" ou "user":{..."id":...}
          if (!sellerIdMatch) {
            sellerIdMatch = section15.match(/"user_id"\s*:\s*(\d+)/);
          }
          if (!sellerIdMatch) {
            // Chercher dans "user":{..."id":123...}
            sellerIdMatch = section15.match(/"user"\s*:\s*\{[^}]*"id"\s*:\s*(\d+)/);
          }
          if (!sellerIdMatch) {
            // Chercher dans l'objet item complet avec user
            sellerIdMatch = section15.match(/"item"\s*:\s*\{[^}]*"user"\s*:\s*\{[^}]*"id"\s*:\s*(\d+)/);
          }
          
          const sellerLoginMatch = section15.match(/"login"\s*:\s*"([^"]+)"/);
          const sellerPhotoMatch = section15.match(/"seller_photo"\s*:\s*\{[^}]*"url"\s*:\s*"([^"]+)"/);
          
          if (sellerIdMatch || sellerLoginMatch) {
            if (!itemData.user) {
              itemData.user = {};
            }
            if (sellerIdMatch) {
              itemData.user.id = parseInt(sellerIdMatch[1]);
            }
            if (sellerLoginMatch) {
              itemData.user.login = sellerLoginMatch[1];
              itemData.user.username = sellerLoginMatch[1];
            }
            if (sellerPhotoMatch) {
              itemData.user.photo = { url: sellerPhotoMatch[1] };
            }
            console.log(`[Vinted Item] ✓ Vendeur extrait: ${itemData.user.login || 'N/A'} (ID: ${itemData.user.id || 'N/A'})`);
          }
          
          console.log(`[Vinted Item] Extraction depuis la section "15:[" terminée avec succès`);
          break; // On a trouvé les données, on peut arrêter
        } catch (e) {
          console.error("[Vinted Item] Erreur extraction __next_f.push (15:):", e);
        }
      }
    }
    
    if (!section15Found) {
      console.log(`[Vinted Item] ⚠ Section "15:[" non trouvée, utilisation des fallbacks`);
    }
    
    // 2. Fallback: Extraire depuis les meta tags og:*
    console.log(`[Vinted Item] Vérification des fallbacks (meta tags og:*)...`);
    if (!itemData.title) {
      const ogTitle = doc.querySelector('meta[property="og:title"]')?.getAttribute('content');
      if (ogTitle) {
        itemData.title = ogTitle.split('|')[0].trim();
        console.log(`[Vinted Item] ✓ Titre extrait depuis og:title: "${itemData.title.substring(0, 50)}..."`);
      } else {
        console.log(`[Vinted Item] ✗ og:title non trouvé`);
      }
    }
    
    if (!itemData.description) {
      const ogDescription = doc.querySelector('meta[property="og:description"]')?.getAttribute('content');
      if (ogDescription) {
        itemData.description = ogDescription;
        console.log(`[Vinted Item] ✓ Description extraite depuis og:description - Longueur: ${itemData.description.length} caractères`);
      } else {
        console.log(`[Vinted Item] ✗ og:description non trouvé`);
      }
    }
    
    // Extraire toutes les photos depuis le DOM (item-photos__container)
    console.log(`[Vinted Item] Extraction des photos depuis le DOM...`);
    const photosContainer = doc.querySelector('.item-photos__container');
    if (photosContainer) {
      // Récupérer toutes les images depuis les thumbnails (y compris celles cachées)
      const photoThumbnails = photosContainer.querySelectorAll('.item-thumbnail img[data-testid^="item-photo"]');
      const photoUrlsFromDom = new Set();
      
      photoThumbnails.forEach((img) => {
        const src = img.getAttribute('src');
        if (src) {
          // Convertir en format f800 si nécessaire
          let photoUrl = src;
          if (!photoUrl.includes('/f800/') && !photoUrl.includes('/f1024/')) {
            photoUrl = photoUrl.replace(/\/\d+x\d+\//, '/f800/');
          }
          photoUrlsFromDom.add(photoUrl);
        }
      });
      
      // Extraire aussi depuis les data-photoid pour récupérer toutes les photos
      const photoButtons = photosContainer.querySelectorAll('.item-thumbnail[data-photoid]');
      photoButtons.forEach(button => {
        const img = button.querySelector('img');
        if (img) {
          const src = img.getAttribute('src');
          if (src) {
            let photoUrl = src;
            if (!photoUrl.includes('/f800/') && !photoUrl.includes('/f1024/')) {
              photoUrl = photoUrl.replace(/\/\d+x\d+\//, '/f800/');
            }
            photoUrlsFromDom.add(photoUrl);
          }
        }
      });
      
      // Extraire depuis toutes les images dans item-photo
      const itemPhotos = photosContainer.querySelectorAll('.item-photo img');
      itemPhotos.forEach(img => {
        const src = img.getAttribute('src');
        if (src) {
          let photoUrl = src;
          if (!photoUrl.includes('/f800/') && !photoUrl.includes('/f1024/')) {
            photoUrl = photoUrl.replace(/\/\d+x\d+\//, '/f800/');
          }
          photoUrlsFromDom.add(photoUrl);
        }
      });
      
      // Ajouter les photos du DOM qui ne sont pas déjà dans itemData.photos
      const existingUrls = new Set(itemData.photos.map(p => p.url));
      let addedCount = 0;
      photoUrlsFromDom.forEach(url => {
        if (!existingUrls.has(url)) {
          itemData.photos.push({ url: url, is_main: false });
          addedCount++;
        }
      });
      
      if (addedCount > 0) {
        console.log(`[Vinted Item] ✓ ${addedCount} photo(s) supplémentaire(s) extraite(s) depuis le DOM`);
      }
      
      // Si aucune photo n'a été trouvée dans les scripts, utiliser celles du DOM
      if (itemData.photos.length === 0 && photoUrlsFromDom.size > 0) {
        itemData.photos = Array.from(photoUrlsFromDom).map((url, index) => ({
          url: url,
          is_main: index === 0
        }));
        console.log(`[Vinted Item] ✓ ${itemData.photos.length} photo(s) extraite(s) depuis le DOM (fallback)`);
      }
    } else {
      console.log(`[Vinted Item] ✗ Container item-photos__container non trouvé`);
    }
    
    if (itemData.photos.length === 0) {
      const ogImage = doc.querySelector('meta[property="og:image"]')?.getAttribute('content');
      if (ogImage) {
        itemData.photos.push({ url: ogImage, is_main: true });
        console.log(`[Vinted Item] ✓ Photo extraite depuis og:image`);
      } else {
        console.log(`[Vinted Item] ✗ og:image non trouvé`);
      }
    }
    
    // 3. Extraire le statut de vente (Vendu/Non vendu) depuis le HTML
    console.log(`[Vinted Item] Extraction du statut de vente...`);
    const statusElement = doc.querySelector('div[data-testid="item-status--content"]');
    if (statusElement) {
      const statusText = statusElement.textContent?.trim() || '';
      itemData.status = statusText;
      itemData.is_sold = statusText.toLowerCase().includes('vendu') || statusText.toLowerCase().includes('sold');
      console.log(`[Vinted Item] ✓ Statut extrait: "${statusText}" (Vendu: ${itemData.is_sold})`);
    } else {
      console.log(`[Vinted Item] ✗ Élément de statut non trouvé`);
      itemData.status = null;
      itemData.is_sold = false;
    }
    
    // 4. Fallback: Extraire le prix depuis le HTML (bouton avec le prix total)
    if (!itemData.price) {
      console.log(`[Vinted Item] Tentative d'extraction du prix depuis le HTML...`);
      const priceButton = doc.querySelector('button[aria-label*="Protection acheteurs incluse"]');
      if (priceButton) {
        const priceText = priceButton.querySelector('.web_ui__Text__title')?.textContent?.trim();
        if (priceText) {
          const priceMatch = priceText.match(/([\d,]+)\s*€/);
          if (priceMatch) {
            itemData.price = {
              amount: priceMatch[1].replace(',', '.'),
              currency_code: 'EUR'
            };
            console.log(`[Vinted Item] ✓ Prix extrait depuis le HTML: ${itemData.price.amount} ${itemData.price.currency_code}`);
          } else {
            console.log(`[Vinted Item] ✗ Pattern de prix non trouvé dans le texte: "${priceText}"`);
          }
        } else {
          console.log(`[Vinted Item] ✗ Texte de prix non trouvé dans le bouton`);
        }
      } else {
        console.log(`[Vinted Item] ✗ Bouton de prix non trouvé`);
      }
    }
    
    // Résumé final des données extraites
    console.log(`[Vinted Item] ========== RÉSUMÉ DES DONNÉES EXTRAITES ==========`);
    console.log(`[Vinted Item] ID: ${itemData.id}`);
    console.log(`[Vinted Item] Titre: ${itemData.title || 'NON TROUVÉ'}`);
    console.log(`[Vinted Item] Prix: ${itemData.price ? `${itemData.price.amount} ${itemData.price.currency_code}` : 'NON TROUVÉ'}`);
    console.log(`[Vinted Item] Description: ${itemData.description ? `${itemData.description.length} caractères` : 'NON TROUVÉE'}`);
    console.log(`[Vinted Item] Taille: ${itemData.size_title || 'NON TROUVÉE'}`);
    console.log(`[Vinted Item] État: ${itemData.condition_title || 'NON TROUVÉ'}`);
    console.log(`[Vinted Item] Marque: ${itemData.brand_title || 'NON TROUVÉE'}`);
    console.log(`[Vinted Item] Couleur: ${itemData.color || 'NON TROUVÉE'}`);
    console.log(`[Vinted Item] Photos: ${itemData.photos.length} photo(s)`);
    console.log(`[Vinted Item] Vendeur: ${itemData.user?.login || 'NON TROUVÉ'} (ID: ${itemData.user?.id || 'N/A'})`);
    console.log(`[Vinted Item] Statut: ${itemData.status || 'NON TROUVÉ'} (Vendu: ${itemData.is_sold})`);
    console.log(`[Vinted Item] ==================================================`);
    
    return itemData;
  } catch (error) {
    console.error("[Vinted Item] Erreur lors de la récupération des détails:", error);
    throw error;
  }
}


  
  // ==========================================
  // messagesNotifier.js
  // ==========================================
  
  // Système de notification pour les nouveaux messages

// Configuration
const CONFIG = {
  SHOW_EXISTING_UNREAD: true, // Afficher les notifications pour les messages déjà non lus au démarrage
};

// État du système de notifications
const notificationState = {
  knownConversationIds: new Set(),
  knownUnreadIds: new Set(), // IDs des conversations connues comme non lues
  isInitialized: false,
  pollInterval: null,
  activeNotifications: new Map(), // Map<conversationId, notificationElement>
};

/**
 * Crée ou récupère le conteneur de notifications
 * @returns {HTMLElement} - Conteneur de notifications
 */
function getNotificationContainer() {
  let container = document.getElementById('vinted-notif-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'vinted-notif-container';
    container.className = 'vinted-notif-container';
    document.body.appendChild(container);
  }
  return container;
}

/**
 * Crée une notification popup pour une conversation
 * @param {Object} conversationInfo - Informations de la conversation
 * @returns {HTMLElement} - Élément de notification
 */
function createNotificationElement(conversationInfo) {
  const notification = document.createElement('div');
  notification.className = 'vinted-message-notification';
  notification.dataset.conversationId = conversationInfo.id;
  notification.dataset.expanded = 'false';
  
  notification.innerHTML = `
    <button class="vinted-notif-close" aria-label="Fermer">×</button>
    <div class="vinted-notif-header">
      <img src="${conversationInfo.opposite_user.photo_url || 'https://via.placeholder.com/50'}" 
           alt="${conversationInfo.opposite_user.login}"
           class="vinted-notif-avatar">
    <div class="vinted-notif-content">
      <div class="vinted-notif-username">${conversationInfo.opposite_user.login}</div>
      <div class="vinted-notif-description">${conversationInfo.description}</div>
      </div>
      ${conversationInfo.item_photo ? `
        <img src="${conversationInfo.item_photo}" alt="Article" class="vinted-notif-item-photo">
      ` : ''}
    </div>
    <div class="vinted-notif-messages" style="display: none;">
      <div class="vinted-notif-messages-loading">Chargement...</div>
    </div>
  `;
  
  // Gestionnaire de clic pour déplier/replier la conversation
  const header = notification.querySelector('.vinted-notif-header');
  header.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('vinted-notif-close')) {
      e.preventDefault();
      e.stopPropagation();
      await toggleNotificationExpansion(notification, conversationInfo.id);
    }
  });
  
  // Gestionnaire pour fermer la notification
  const closeBtn = notification.querySelector('.vinted-notif-close');
  closeBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    removeNotification(conversationInfo.id);
  });
  
  return notification;
}

/**
 * Ajoute les styles CSS pour les notifications
 */
function injectNotificationStyles() {
  if (document.getElementById('vinted-notif-styles')) {
    return; // Styles déjà injectés
  }
  
  const style = document.createElement('style');
  style.id = 'vinted-notif-styles';
  style.textContent = `
    .vinted-notif-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      z-index: 10000;
      padding: 0;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 12px;
      overflow-x: auto;
      overflow-y: hidden;
      pointer-events: none;
    }
    
    /* Forcer la transparence du conteneur même en mode sombre */
    .vinted-dark-mode .vinted-notif-container,
    html.vinted-dark-mode .vinted-notif-container,
    body.vinted-dark-mode .vinted-notif-container {
      background: transparent !important;
      background-color: transparent !important;
    }
    
    .vinted-notif-container::-webkit-scrollbar {
      height: 6px;
    }
    
    .vinted-notif-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .vinted-notif-container::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }
    
    .vinted-notif-container::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .vinted-message-notification {
      flex-shrink: 0;
      width: 250px;
      max-width: 250px;
      min-width: 250px;
      height: auto;
      max-height: none;
      min-height: auto;
      background: transparent !important;
      background-color: transparent !important;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      transition: width 0.3s ease, max-width 0.3s ease, min-width 0.3s ease;
      position: relative;
      animation: popIn 0.3s ease;
      display: flex;
      flex-direction: column;
      align-self: flex-end;
      pointer-events: auto;
    }
    
    .vinted-message-notification.vinted-notif-expanded {
      width: 400px !important;
      max-width: 400px !important;
      min-width: 400px !important;
      max-height: 80vh !important;
      height: auto;
      align-self: flex-end;
    }
    
    .vinted-message-notification:not(.vinted-notif-expanded) {
      height: auto;
      max-height: none;
      align-self: flex-end;
    }
    
    .vinted-notif-header {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      background: rgba(30, 41, 59, 0.15) !important;
      background-color: rgba(30, 41, 59, 0.15) !important;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius: 12px;
      padding: 12px;
    }
    
    .vinted-notif-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #09B1BA;
      flex-shrink: 0;
    }
    
    .vinted-notif-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .vinted-notif-username {
      font-weight: 700;
      font-size: 13px;
      color: #1a1a1a;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .vinted-dark-mode .vinted-notif-username {
      color: #ffffff;
    }
    
    .vinted-notif-description {
      font-size: 11px;
      color: #666;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .vinted-dark-mode .vinted-notif-description {
      color: #aaa;
    }
    
    .vinted-notif-item-photo {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #f0f0f0;
      flex-shrink: 0;
    }
    
    .vinted-dark-mode .vinted-notif-item-photo {
      border-color: #333;
    }
    
    /* Forcer la transparence même en mode sombre */
    .vinted-dark-mode .vinted-message-notification,
    html.vinted-dark-mode .vinted-message-notification,
    body.vinted-dark-mode .vinted-message-notification {
      background: transparent !important;
      background-color: transparent !important;
    }
    
    .vinted-notif-messages {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      max-height: 400px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.15) !important;
      background-color: rgba(255, 255, 255, 0.15) !important;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius: 12px;
      padding: 12px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .vinted-notif-messages::-webkit-scrollbar {
      display: none;
    }
    
    .vinted-dark-mode .vinted-notif-messages {
      border-top-color: rgba(255, 255, 255, 0.1);
    }
    
    .vinted-dark-mode .vinted-notif-header,
    html.vinted-dark-mode .vinted-notif-header,
    body.vinted-dark-mode .vinted-notif-header {
      background: rgba(255, 255, 255, 0.25) !important;
      background-color: rgba(255, 255, 255, 0.25) !important;
    }
    
    .vinted-dark-mode .vinted-notif-messages,
    html.vinted-dark-mode .vinted-notif-messages,
    body.vinted-dark-mode .vinted-notif-messages {
      background: rgba(255, 255, 255, 0.25) !important;
      background-color: rgba(255, 255, 255, 0.25) !important;
    }
    
    
    .vinted-notif-messages-content {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .vinted-notif-messages-loading,
    .vinted-notif-messages-error {
      text-align: center;
      padding: 1rem;
      color: #666;
      font-size: 0.875rem;
    }
    
    .vinted-dark-mode .vinted-notif-messages-loading,
    .vinted-dark-mode .vinted-notif-messages-error {
      color: #aaa;
    }
    
    .vinted-notif-messages-input-container {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .vinted-dark-mode .vinted-notif-messages-input-container {
      border-top-color: rgba(255, 255, 255, 0.1);
    }
    
    .vinted-notif-messages-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 20px;
      font-size: 0.875rem;
      background: rgba(255, 255, 255, 0.5);
      color: #1a1a1a;
      outline: none;
      transition: all 0.2s;
    }
    
    .vinted-notif-messages-input:focus {
      border-color: #09B1BA;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 0 2px rgba(9, 177, 186, 0.2);
    }
    
    .vinted-notif-messages-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .vinted-dark-mode .vinted-notif-messages-input {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      color: #ffffff;
    }
    
    .vinted-dark-mode .vinted-notif-messages-input:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: #09B1BA;
    }
    
    .vinted-notif-messages-input::placeholder {
      color: #999;
    }
    
    .vinted-dark-mode .vinted-notif-messages-input::placeholder {
      color: #666;
    }
    
    .vinted-notif-messages-send {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #09B1BA;
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
      padding: 0;
    }
    
    .vinted-notif-messages-send:hover:not(:disabled) {
      background: #078a91;
      transform: scale(1.05);
    }
    
    .vinted-notif-messages-send:active:not(:disabled) {
      transform: scale(0.95);
    }
    
    .vinted-notif-messages-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .vinted-notif-messages-send svg {
      width: 18px;
      height: 18px;
    }
    
    /* Styles pour les messages dans la notification */
    .vinted-notif-messages .vinted-msg-item {
      max-width: 100%;
      font-size: 0.8125rem;
    }
    
    .vinted-notif-messages .vinted-msg-body {
      padding: 0.5rem 0.75rem;
      font-size: 0.8125rem;
    }
    
    .vinted-notif-messages .vinted-msg-time {
      font-size: 0.6875rem;
    }
    
    .vinted-notif-messages .vinted-msg-status,
    .vinted-notif-messages .vinted-msg-action,
    .vinted-notif-messages .vinted-msg-offer {
      padding: 0.5rem 0.75rem;
      font-size: 0.8125rem;
    }
    
    @keyframes popIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .vinted-message-notification:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }
    
    .vinted-notif-close {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.1);
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-weight: bold;
      z-index: 10;
    }
    
    .vinted-notif-close:hover {
      background: rgba(0, 0, 0, 0.2);
      color: #333;
      transform: scale(1.1);
    }
    
    
    /* Responsive */
    @media (max-width: 768px) {
      .vinted-message-notification {
        width: 160px;
      }
      
      .vinted-notif-avatar {
        width: 40px;
        height: 40px;
      }
      
      .vinted-notif-username {
        font-size: 12px;
      }
      
      .vinted-notif-description {
        font-size: 10px;
      }
      
      .vinted-notif-item-photo {
        height: 80px;
      }
    }
    
    /* Modal de conversation */
    .vinted-conversation-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease;
    }
    
    .vinted-conversation-container {
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      background: rgba(255, 255, 255, 0.95) !important;
      background-color: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }
    
    .vinted-dark-mode .vinted-conversation-container {
      background: rgba(30, 30, 30, 0.95) !important;
      background-color: rgba(30, 30, 30, 0.95) !important;
    }
    
    .vinted-conversation-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-height: 90vh;
    }
    
    .vinted-conversation-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .vinted-conversation-user {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .vinted-conversation-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .vinted-conversation-user-info {
      display: flex;
      flex-direction: column;
    }
    
    .vinted-conversation-username {
      font-weight: 600;
      font-size: 1rem;
      color: #1a1a1a;
    }
    
    .vinted-dark-mode .vinted-conversation-username {
      color: #ffffff;
    }
    
    .vinted-conversation-subtitle {
      font-size: 0.875rem;
      color: #666;
      margin-top: 0.25rem;
    }
    
    .vinted-dark-mode .vinted-conversation-subtitle {
      color: #aaa;
    }
    
    .vinted-conversation-close {
      background: transparent;
      border: none;
      font-size: 2rem;
      line-height: 1;
      color: #666;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .vinted-conversation-close:hover {
      background: rgba(0, 0, 0, 0.1);
      color: #333;
    }
    
    .vinted-dark-mode .vinted-conversation-close {
      color: #aaa;
    }
    
    .vinted-dark-mode .vinted-conversation-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    
    .vinted-conversation-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .vinted-conversation-messages::-webkit-scrollbar {
      width: 6px;
    }
    
    .vinted-conversation-messages::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
    }
    
    .vinted-conversation-messages::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }
    
    .vinted-msg-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      max-width: 70%;
    }
    
    .vinted-msg-current-user {
      align-self: flex-end;
      align-items: flex-end;
    }
    
    .vinted-msg-other-user {
      align-self: flex-start;
      align-items: flex-start;
    }
    
    .vinted-msg-body {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      background: #f0f0f0;
      color: #1a1a1a;
      word-wrap: break-word;
    }
    
    .vinted-msg-current-user .vinted-msg-body {
      background: #09B1BA;
      color: white;
    }
    
    .vinted-dark-mode .vinted-msg-other-user .vinted-msg-body {
      background: #2a2a2a;
      color: #e0e0e0;
    }
    
    .vinted-msg-status,
    .vinted-msg-action,
    .vinted-msg-offer {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      background: #f8f8f8;
      border: 1px solid #e0e0e0;
    }
    
    .vinted-dark-mode .vinted-msg-status,
    .vinted-dark-mode .vinted-msg-action,
    .vinted-dark-mode .vinted-msg-offer {
      background: #2a2a2a;
      border-color: #404040;
    }
    
    .vinted-msg-status-title,
    .vinted-msg-action-title,
    .vinted-msg-offer-title {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }
    
    .vinted-msg-status-subtitle,
    .vinted-msg-action-subtitle {
      font-size: 1.25rem;
      color: #black;
      font-weight: 600;
    }
    
    .vinted-dark-mode .vinted-msg-status-subtitle,
    .vinted-dark-mode .vinted-msg-action-subtitle {
      color: #black;
    }
    
    .vinted-msg-offer-price {
      font-weight: 700;
      font-size: 1.125rem;
      color: #09B1BA;
      margin-top: 0.5rem;
    }
    
    .vinted-msg-offer-original {
      font-size: 0.8125rem;
      color: #999;
      text-decoration: line-through;
      margin-top: 0.25rem;
    }
    
    .vinted-msg-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    
    .vinted-msg-action-btn {
      padding: 0.5rem 1rem;
      background: #09B1BA;
      color: white;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .vinted-msg-action-btn:hover {
      background: #078a91;
      transform: translateY(-1px);
    }
    
    .vinted-msg-time {
      font-size: 0.75rem;
      color: #999;
      margin-top: 0.25rem;
    }
    
    .vinted-dark-mode .vinted-msg-time {
      color: #666;
    }
    
    .vinted-conversation-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    
    .vinted-conversation-link {
      color: #09B1BA;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .vinted-conversation-link:hover {
      color: #078a91;
      text-decoration: underline;
    }
    
    .vinted-conversation-loading {
      padding: 2rem;
      text-align: center;
      color: #666;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .vinted-notif-offer-btn {
      margin: 12px;
      padding: 8px 16px;
      background: #09B1BA;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    
    .vinted-notif-offer-btn:hover {
      background: #078a91;
      transform: translateY(-1px);
    }
    
    .vinted-offer-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20000;
      animation: fadeIn 0.2s ease;
    }
    
    .vinted-offer-modal-content {
      background: rgba(255, 255, 255, 0.15) !important;
      background-color: rgba(255, 255, 255, 0.15) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease;
    }
    
    .vinted-dark-mode .vinted-offer-modal-content {
      background: rgba(255, 255, 255, 0.15) !important;
      background-color: rgba(255, 255, 255, 0.15) !important;
      color: white;
    }
    
    .vinted-offer-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .vinted-dark-mode .vinted-offer-modal-header {
      border-bottom-color: rgba(255, 255, 255, 0.1);
    }
    
    .vinted-offer-modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .vinted-offer-modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .vinted-offer-modal-close:hover {
      background: rgba(0, 0, 0, 0.1);
      color: #000;
    }
    
    .vinted-dark-mode .vinted-offer-modal-close {
      color: #aaa;
    }
    
    .vinted-dark-mode .vinted-offer-modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    
    .vinted-offer-modal-body {
      padding: 1.5rem;
    }
    
    .vinted-offer-modal-body label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.875rem;
    }
    
    .vinted-offer-price-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 1.5rem;
      box-sizing: border-box;
    }
    
    .vinted-offer-price-input:focus {
      outline: none;
      border-color: #09B1BA;
      box-shadow: 0 0 0 3px rgba(9, 177, 186, 0.1);
    }
    
    .vinted-dark-mode .vinted-offer-price-input {
      background: #2a2a2a;
      border-color: #444;
      color: white;
    }
    
    .vinted-offer-modal-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      }
      
    .vinted-offer-modal-cancel,
    .vinted-offer-modal-submit {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      }
      
    .vinted-offer-modal-cancel {
      background: #f0f0f0;
      color: #333;
    }
    
    .vinted-offer-modal-cancel:hover {
      background: #e0e0e0;
      }
      
    .vinted-dark-mode .vinted-offer-modal-cancel {
      background: #333;
      color: white;
    }
    
    .vinted-dark-mode .vinted-offer-modal-cancel:hover {
      background: #444;
    }
    
    .vinted-offer-modal-submit {
      background: #09B1BA;
      color: white;
      }
      
    .vinted-offer-modal-submit:hover {
      background: #078a91;
    }
    
    .vinted-offer-modal-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Styles pour le modal de détails de produit */
    .vinted-item-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20000;
      animation: fadeIn 0.2s ease;
      overflow-y: auto;
      padding: 20px;
    }
    
    .vinted-item-modal-content {
      background: rgba(255, 255, 255, 0.05) !important;
      background-color: rgba(255, 255, 255, 0.05) !important;
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease;
      position: relative;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .vinted-item-modal-content::-webkit-scrollbar {
      display: none;
    }
    
    .vinted-dark-mode .vinted-item-modal-content {
      background: rgba(255, 255, 255, 0.05) !important;
      background-color: rgba(255, 255, 255, 0.05) !important;
      color: white;
    }
    
    .vinted-item-modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: white;
      padding: 0.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
      z-index: 10;
    }
    
    .vinted-item-modal-close:hover {
      background: rgba(0, 0, 0, 0.5);
      transform: scale(1.1);
    }
    
    .vinted-item-modal-body {
      padding: 2rem;
    }
    
    .vinted-item-details {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 2rem;
      align-items: start;
    }
    
    @media (max-width: 768px) {
      .vinted-item-details {
        grid-template-columns: 1fr;
      }
    }
    
    .vinted-item-photos {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      position: sticky;
      top: 2rem;
    }
    
    .vinted-item-photo-main {
      width: 100%;
      max-width: 300px;
      aspect-ratio: 1;
      overflow: hidden;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .vinted-item-photo-main img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .vinted-item-photo-thumbnails {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .vinted-item-photo-thumbnails::-webkit-scrollbar {
      display: none;
    }
    
    .vinted-item-photo-thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .vinted-item-photo-thumb:hover,
    .vinted-item-photo-thumb.active {
      opacity: 1;
      border-color: #09B1BA;
    }
    
    .vinted-item-info {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .vinted-item-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }
    
    .vinted-item-price {
      font-size: 1.75rem;
      font-weight: 700;
      color: #09B1BA;
    }
    
    .vinted-item-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0;
      font-size: 0.875rem;
    }
    
    .vinted-item-status-label {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .vinted-item-status-value {
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .vinted-item-status-sold .vinted-item-status-value {
      color: #ef4444;
      font-weight: 600;
    }
    
    .vinted-item-meta {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      border-radius: 8px;
    }
    
    .vinted-item-meta-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .vinted-item-meta-label {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.8);
      min-width: 80px;
    }
    
    .vinted-item-meta-value {
      color: rgba(255, 255, 255, 0.9);
      flex: 1;
    }
    
    .vinted-item-meta-item {
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-size: 0.875rem;
    }
    
    .vinted-item-description {
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      border-radius: 8px;
    }
    
    .vinted-item-description h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .vinted-item-description p {
      margin: 0;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    
    .vinted-item-seller {
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      border-radius: 8px;
    }
    
    .vinted-item-seller h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .vinted-item-seller-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .vinted-item-seller-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .vinted-item-seller-name {
      font-weight: 500;
    }
    
    .vinted-item-seller-id {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.6);
      margin-left: 0.5rem;
    }
    
    /* Skeleton Loading Styles */
    .vinted-item-details-skeleton {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 2rem;
      align-items: start;
    }
    
    @media (max-width: 768px) {
      .vinted-item-details-skeleton {
        grid-template-columns: 1fr;
      }
    }
    
    .vinted-item-skeleton-photos {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .vinted-item-skeleton-photo-main {
      width: 100%;
      max-width: 300px;
      aspect-ratio: 1;
      border-radius: 8px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
    }
    
    .vinted-item-skeleton-thumbnails {
      display: flex;
      gap: 0.5rem;
    }
    
    .vinted-item-skeleton-thumb {
      width: 60px;
      height: 60px;
      border-radius: 6px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
    }
    
    .vinted-item-skeleton-info {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .vinted-item-skeleton-title {
      height: 32px;
      width: 80%;
      border-radius: 8px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
    }
    
    .vinted-item-skeleton-price {
      height: 40px;
      width: 120px;
      border-radius: 8px;
      background: linear-gradient(90deg, rgba(9, 177, 186, 0.3) 25%, rgba(9, 177, 186, 0.5) 50%, rgba(9, 177, 186, 0.3) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
    }
    
    .vinted-item-skeleton-meta {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    
    .vinted-item-skeleton-meta-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .vinted-item-skeleton-label {
      height: 20px;
      width: 80px;
      border-radius: 4px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
    }
    
    .vinted-item-skeleton-value {
      height: 20px;
      flex: 1;
      border-radius: 4px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
    }
    
    .vinted-item-skeleton-description {
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .vinted-item-skeleton-line {
      height: 16px;
      width: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
    }
    
    .vinted-item-skeleton-line.short {
      width: 60%;
    }
    
    .vinted-item-skeleton-seller {
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .vinted-item-skeleton-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
    }
    
    .vinted-item-skeleton-seller-name {
      height: 20px;
      width: 120px;
      border-radius: 4px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
    }
    
    .vinted-item-skeleton-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .vinted-item-skeleton-button {
      flex: 1;
      min-width: 150px;
      height: 44px;
      border-radius: 8px;
      background: linear-gradient(90deg, rgba(9, 177, 186, 0.3) 25%, rgba(9, 177, 186, 0.5) 50%, rgba(9, 177, 186, 0.3) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
    }
    
    @keyframes skeleton-loading {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }
    
    .vinted-item-error {
      padding: 2rem;
      text-align: center;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .vinted-item-error h3 {
      margin: 0 0 1rem 0;
      font-size: 1.25rem;
      color: #ef4444;
    }
    
    .vinted-item-error p {
      margin: 0 0 1.5rem 0;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .vinted-item-error-close {
      padding: 0.75rem 1.5rem;
      background: #09B1BA;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .vinted-item-error-close:hover {
      background: #078a91;
      transform: translateY(-1px);
    }
    
    .vinted-item-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .vinted-item-offer-btn,
    .vinted-item-message-btn {
      flex: 1;
      min-width: 150px;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .vinted-item-offer-btn {
      background: #09B1BA;
      color: white;
    }
    
    .vinted-item-offer-btn:hover {
      background: #078a91;
      transform: translateY(-1px);
    }
    
    .vinted-item-message-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .vinted-item-message-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .vinted-item-conversation {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      border-radius: 8px;
      max-height: 400px;
      display: flex;
      flex-direction: column;
    }
    
    .vinted-item-conversation-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-height: 400px;
    }
    
    .vinted-item-messages-list {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding: 0.5rem 0;
      max-height: 300px;
    }
    
    .vinted-item-messages-list::-webkit-scrollbar {
      display: none;
    }
    
    .vinted-item-messages-input-container {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .vinted-item-messages-input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      color: white;
      font-size: 0.875rem;
      outline: none;
    }
    
    .vinted-item-messages-input:focus {
      border-color: #09B1BA;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .vinted-item-messages-send {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #09B1BA;
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .vinted-item-messages-send:hover:not(:disabled) {
      background: #078a91;
      transform: scale(1.05);
    }
    
    .vinted-item-messages-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .vinted-item-no-messages {
      text-align: center;
      padding: 2rem;
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.875rem;
    }
    
    .vinted-item-conversation-loading,
    .vinted-item-conversation-error {
      text-align: center;
      padding: 1rem;
      color: rgba(255, 255, 255, 0.7);
    }
    
    /* Styles pour les messages dans la conversation de l'item */
    .vinted-item-messages-list .vinted-msg-item {
      margin-bottom: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      max-width: 80%;
      word-wrap: break-word;
    }
    
    .vinted-item-messages-list .vinted-msg-current-user {
      background: rgba(9, 177, 186, 0.2);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      margin-left: auto;
      text-align: right;
    }
    
    .vinted-item-messages-list .vinted-msg-other-user {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      margin-right: auto;
    }
    
    .vinted-item-messages-list .vinted-msg-body {
      color: white;
      font-size: 0.875rem;
      line-height: 1.4;
      margin-bottom: 0.25rem;
    }
    
    .vinted-item-messages-list .vinted-msg-time {
      font-size: 0.6875rem;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 0.25rem;
    }
    
    .vinted-item-pin-btn {
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .vinted-item-pin-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .vinted-item-pin-btn.pinned {
      background: rgba(9, 177, 186, 0.3);
      border-color: #09B1BA;
    }
    
    /* Barre des items épinglés */
    .vinted-pinned-items-bar {
      position: sticky;
      top: 0;
      z-index: 10001;
      background: transparent !important;
      background-color: transparent !important;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      border-bottom: none;
      padding: 0.75rem 1rem;
      width: 100%;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    
    .vinted-pinned-items-bar.scrolled {
      background: #0f172a !important;
      background-color: #0f172a !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 1rem 1.5rem;
      margin-top: 60px; /* Espace pour la navbar de Vinted lors du scroll */
    }
    
    /* S'assurer que le fond est bien appliqué même avec d'autres styles */
    .vinted-pinned-items-bar.scrolled,
    html .vinted-pinned-items-bar.scrolled,
    body .vinted-pinned-items-bar.scrolled {
      background: #0f172a !important;
      background-color: #0f172a !important;
    }
    
    .vinted-pinned-items-container {
      display: flex;
      gap: 0.75rem;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      max-width: 100%;
    }
    
    .vinted-pinned-items-container::-webkit-scrollbar {
      display: none;
    }
    
    .vinted-pinned-item {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      background: transparent;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      width: 60px;
      height: 60px;
      flex-shrink: 0;
      position: relative;
    }
    
    .vinted-pinned-item:hover {
      background: transparent;
      transform: translateY(-2px);
    }
    
    .vinted-pinned-item-photo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .vinted-pinned-item-unpin {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(220, 38, 38, 0.8);
      border: none;
      color: white;
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      transition: all 0.2s;
    }
    
    .vinted-pinned-item-unpin:hover {
      background: rgba(220, 38, 38, 1);
      transform: scale(1.1);
    }
  `;
  
  document.head.appendChild(style);
}

/**
 * Affiche un dialogue pour faire une offre
 * @param {string|number} transactionId - ID de la transaction
 * @param {string|number} conversationId - ID de la conversation
 * @param {HTMLElement} messagesContainer - Conteneur des messages
 * @param {Object} transaction - Objet transaction
 */
function showOfferDialog(transactionId, conversationId, messagesContainer, transaction) {
  // Créer le modal
  const modal = document.createElement('div');
  modal.className = 'vinted-offer-modal';
  modal.innerHTML = `
    <div class="vinted-offer-modal-content">
      <div class="vinted-offer-modal-header">
        <h3>Faire une offre</h3>
        <button class="vinted-offer-modal-close" aria-label="Fermer">&times;</button>
      </div>
      <div class="vinted-offer-modal-body">
        <label for="vinted-offer-price">Prix (EUR)</label>
        <input type="number" 
               id="vinted-offer-price" 
               class="vinted-offer-price-input" 
               placeholder="0.00" 
               step="0.01" 
               min="0.01"
               required>
        <div class="vinted-offer-modal-actions">
          <button class="vinted-offer-modal-cancel">Annuler</button>
          <button class="vinted-offer-modal-submit">Envoyer l'offre</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  const priceInput = modal.querySelector('.vinted-offer-price-input');
  const submitBtn = modal.querySelector('.vinted-offer-modal-submit');
  const cancelBtn = modal.querySelector('.vinted-offer-modal-cancel');
  const closeBtn = modal.querySelector('.vinted-offer-modal-close');
  
  const closeModal = () => {
    document.body.removeChild(modal);
  };
  
  const handleSubmit = async () => {
    const price = priceInput.value.trim();
    if (!price || parseFloat(price) <= 0) {
      alert('Veuillez entrer un prix valide');
      return;
    }
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Envoi...';
    
    try {
      await sendOfferRequest(transactionId, price, 'EUR');
      
      // Recharger la conversation pour afficher la nouvelle offre
      const updatedConversation = await fetchConversation(conversationId);
      const oppositeUserId = updatedConversation.opposite_user.id;
      let currentUserId = oppositeUserId;
      for (const msg of updatedConversation.messages) {
        if (msg.entity_type === 'message' && msg.entity?.user_id && msg.entity.user_id !== oppositeUserId) {
          currentUserId = msg.entity.user_id;
          break;
        }
      }
      
      const conversationUrl = updatedConversation.conversation_url || `https://www.vinted.fr/inbox/${conversationId}`;
      const updatedTransaction = updatedConversation.transaction || transaction;
      const updatedMessagesHtml = updatedConversation.messages.map(msg => 
        formatMessage(msg, currentUserId, conversationUrl, updatedTransaction)
      ).join('');
      
      const messagesContent = messagesContainer.querySelector('.vinted-notif-messages-content');
      messagesContent.innerHTML = updatedMessagesHtml;
      
      // Faire défiler vers le bas
      setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }, 100);
      
      closeModal();
    } catch (error) {
      console.error("[Vinted Messages] Erreur lors de l'envoi de l'offre:", error);
      alert("Erreur lors de l'envoi de l'offre. Veuillez réessayer.");
      submitBtn.disabled = false;
      submitBtn.textContent = 'Envoyer l\'offre';
    }
  };
  
  submitBtn.addEventListener('click', handleSubmit);
  cancelBtn.addEventListener('click', closeModal);
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
  
  priceInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleSubmit();
    }
  });
  
  setTimeout(() => priceInput.focus(), 100);
}

/**
 * Affiche une notification pour une nouvelle conversation non lue
 * @param {Object} conversationInfo - Informations de la conversation
 */
function showNotification(conversationInfo) {
  // Ne pas afficher si déjà affichée
  if (notificationState.activeNotifications.has(conversationInfo.id)) {
    return;
  }
  
  const container = getNotificationContainer();
  const notification = createNotificationElement(conversationInfo);
  container.appendChild(notification);
  
  notificationState.activeNotifications.set(conversationInfo.id, notification);
  
  console.log(`[Vinted Messages] Notification affichée pour la conversation ${conversationInfo.id}`);
}

/**
 * Supprime une notification
 * @param {string} conversationId - ID de la conversation
 */
function removeNotification(conversationId) {
  const notification = notificationState.activeNotifications.get(conversationId);
  
  if (notification) {
    notification.style.animation = 'popIn 0.3s ease reverse';
    setTimeout(() => {
      notification.remove();
      notificationState.activeNotifications.delete(conversationId);
      
      // Supprimer le conteneur s'il est vide
      const container = document.getElementById('vinted-notif-container');
      if (container && container.children.length === 0) {
        container.remove();
      }
    }, 300);
  }
}

/**
 * Formate un message pour l'affichage
 * @param {Object} message - Message de la conversation
 * @param {number} currentUserId - ID de l'utilisateur actuel
 * @param {string} conversationUrl - URL de la conversation
 * @param {Object} transaction - Transaction de la conversation (optionnel)
 * @returns {string} - HTML formaté du message
 */
function formatMessage(message, currentUserId, conversationUrl, transaction = null) {
  // Déterminer si le message est de l'utilisateur actuel
  const messageUserId = message.entity?.user_id;
  const isCurrentUser = messageUserId === currentUserId;
  const messageClass = isCurrentUser ? 'vinted-msg-current-user' : 'vinted-msg-other-user';
  
  // Formater la date - created_at_ts peut être une chaîne ISO 8601 ou un timestamp
  let timeAgo = message.created_time_ago || '';
  if (!timeAgo && message.created_at_ts) {
    try {
      // Si c'est une chaîne ISO 8601, la parser directement
      const date = new Date(message.created_at_ts);
      if (!isNaN(date.getTime())) {
        // Formater la date de manière relative
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) {
          timeAgo = 'À l\'instant';
        } else if (diffMins < 60) {
          timeAgo = `Il y a ${diffMins} min`;
        } else if (diffHours < 24) {
          timeAgo = `Il y a ${diffHours}h`;
        } else if (diffDays < 7) {
          timeAgo = `Il y a ${diffDays}j`;
        } else {
          timeAgo = new Intl.DateTimeFormat('fr-FR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }).format(date);
        }
      }
    } catch (e) {
      console.error("[Vinted Messages] Erreur lors du formatage de la date:", e, message.created_at_ts);
      timeAgo = '';
    }
  }
  
  let content = '';
  
  if (message.entity_type === 'message') {
    content = `<div class="vinted-msg-body">${escapeHtml(message.entity.body)}</div>`;
  } else if (message.entity_type === 'status_message') {
    content = `
      <div class="vinted-msg-status">
        <div class="vinted-msg-status-title">${escapeHtml(message.entity.title)}</div>
        ${message.entity.subtitle ? `<div class="vinted-msg-status-subtitle">${escapeHtml(message.entity.subtitle)}</div>` : ''}
      </div>
    `;
  } else if (message.entity_type === 'action_message') {
    content = `
      <div class="vinted-msg-action">
        <div class="vinted-msg-action-title">${escapeHtml(message.entity.title)}</div>
        ${message.entity.subtitle ? `<div class="vinted-msg-action-subtitle">${escapeHtml(message.entity.subtitle)}</div>` : ''}
        ${message.entity.actions && message.entity.actions.length > 0 ? `
          <div class="vinted-msg-actions">
            ${message.entity.actions.map(action => {
              // Construire l'URL de l'action si nécessaire
              let actionUrl = conversationUrl;
              if (action.action === 'track_shipment' && transaction?.id) {
                actionUrl = `https://www.vinted.fr/transactions/${transaction.id}`;
              }
              return `<a href="${actionUrl}" target="_blank" class="vinted-msg-action-btn">${escapeHtml(action.title)}</a>`;
            }).join('')}
          </div>
        ` : ''}
      </div>
    `;
  } else if (message.entity_type === 'offer_request_message') {
    // Message d'offre demandée (par l'acheteur)
    const statusText = message.entity.status_title ? ` (${escapeHtml(message.entity.status_title)})` : '';
    content = `
      <div class="vinted-msg-offer">
        <div class="vinted-msg-offer-title">${escapeHtml(message.entity.title || 'Offre demandée')}${statusText}</div>
        <div class="vinted-msg-offer-price">${escapeHtml(message.entity.price_label || message.entity.body || '')}</div>
        ${message.entity.original_price_label ? `<div class="vinted-msg-offer-original">Prix original: ${escapeHtml(message.entity.original_price_label)}</div>` : ''}
      </div>
    `;
  } else if (message.entity_type === 'offer_message') {
    // Message d'offre acceptée (par le vendeur)
    content = `
      <div class="vinted-msg-offer accepted">
        <div class="vinted-msg-offer-title">Offre acceptée</div>
        <div class="vinted-msg-offer-price">${escapeHtml(message.entity.price_label || '')}</div>
        ${message.entity.original_price_label ? `<div class="vinted-msg-offer-original">Prix original: ${escapeHtml(message.entity.original_price_label)}</div>` : ''}
      </div>
    `;
  }
  
  // Ne pas afficher de message vide
  if (!content) {
    return '';
  }
  
  return `
    <div class="vinted-msg-item ${messageClass}">
      ${content}
      <div class="vinted-msg-time">${escapeHtml(timeAgo)}</div>
    </div>
  `;
}

/**
 * Échappe le HTML pour éviter les injections XSS
 */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * Déplie ou replie une notification pour afficher les messages
 * @param {HTMLElement} notification - Élément de notification
 * @param {string|number} conversationId - ID de la conversation
 */
async function toggleNotificationExpansion(notification, conversationId) {
  const isExpanded = notification.dataset.expanded === 'true';
  const messagesContainer = notification.querySelector('.vinted-notif-messages');
  
  if (isExpanded) {
    // Replier
    notification.dataset.expanded = 'false';
    messagesContainer.style.display = 'none';
    notification.classList.remove('vinted-notif-expanded');
  } else {
    // Déplier
    notification.dataset.expanded = 'true';
    notification.classList.add('vinted-notif-expanded');
    messagesContainer.style.display = 'block';
    
    // Charger les messages si pas déjà chargés
    if (messagesContainer.querySelector('.vinted-notif-messages-loading')) {
      try {
        const conversation = await fetchConversation(conversationId);
        
        // Déterminer l'ID de l'utilisateur actuel
        const oppositeUserId = conversation.opposite_user.id;
        let currentUserId = oppositeUserId;
        for (const msg of conversation.messages) {
          if (msg.entity_type === 'message' && msg.entity?.user_id && msg.entity.user_id !== oppositeUserId) {
            currentUserId = msg.entity.user_id;
            break;
          }
        }
        
        // Construire le HTML des messages
        const conversationUrl = conversation.conversation_url || `https://www.vinted.fr/inbox/${conversationId}`;
        const transaction = conversation.transaction || null;
        // Trier les messages par date (du plus ancien au plus récent)
        const sortedMessages = [...(conversation.messages || [])].sort((a, b) => {
          const dateA = a.created_at_ts ? new Date(a.created_at_ts).getTime() : 0;
          const dateB = b.created_at_ts ? new Date(b.created_at_ts).getTime() : 0;
          return dateA - dateB;
        });
        const messagesHtml = sortedMessages.map(msg => formatMessage(msg, currentUserId, conversationUrl, transaction)).join('');
        
        // Vérifier si une transaction existe pour afficher le bouton d'offre
        const hasTransaction = transaction && transaction.id;
        const offerButtonHtml = hasTransaction ? `
          <button class="vinted-notif-offer-btn" aria-label="Faire une offre">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            Faire une offre
          </button>
        ` : '';
        
        messagesContainer.innerHTML = `
          <div class="vinted-notif-messages-content">
            ${messagesHtml}
          </div>
          ${offerButtonHtml}
          <div class="vinted-notif-messages-input-container">
            <input type="text" 
                   class="vinted-notif-messages-input" 
                   placeholder="Tapez votre message..."
                   maxlength="1000">
            <button class="vinted-notif-messages-send" aria-label="Envoyer">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </div>
        `;
        
        // Ajouter le gestionnaire d'envoi de message
        const input = messagesContainer.querySelector('.vinted-notif-messages-input');
        const sendBtn = messagesContainer.querySelector('.vinted-notif-messages-send');
        
        const handleSend = async () => {
          const messageText = input.value.trim();
          if (!messageText) return;
          
          // Désactiver l'input et le bouton pendant l'envoi
          input.disabled = true;
          sendBtn.disabled = true;
          sendBtn.style.opacity = '0.5';
          
          try {
            await sendMessage(conversationId, messageText);
            
            // Vider l'input
            input.value = '';
            
            // Recharger la conversation pour afficher le nouveau message
            const updatedConversation = await fetchConversation(conversationId);
            const oppositeUserId = updatedConversation.opposite_user.id;
            let currentUserId = oppositeUserId;
            for (const msg of updatedConversation.messages) {
              if (msg.entity_type === 'message' && msg.entity?.user_id && msg.entity.user_id !== oppositeUserId) {
                currentUserId = msg.entity.user_id;
                break;
              }
            }
            
            const updatedMessagesHtml = updatedConversation.messages.map(msg => 
              formatMessage(msg, currentUserId, conversationUrl, transaction)
            ).join('');
            
            const messagesContent = messagesContainer.querySelector('.vinted-notif-messages-content');
            messagesContent.innerHTML = updatedMessagesHtml;
            
            // Faire défiler vers le bas
            setTimeout(() => {
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
            
          } catch (error) {
            console.error("[Vinted Messages] Erreur lors de l'envoi:", error);
            alert("Erreur lors de l'envoi du message. Veuillez réessayer.");
          } finally {
            // Réactiver l'input et le bouton
            input.disabled = false;
            sendBtn.disabled = false;
            sendBtn.style.opacity = '1';
            input.focus();
          }
        };
        
        sendBtn.addEventListener('click', handleSend);
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
          }
        });
        
        // Gestionnaire pour le bouton d'offre
        if (hasTransaction) {
          const offerBtn = messagesContainer.querySelector('.vinted-notif-offer-btn');
          if (offerBtn) {
            offerBtn.addEventListener('click', () => {
              showOfferDialog(transaction.id, conversationId, messagesContainer, transaction);
            });
          }
        }
        
        // Faire défiler vers le bas et focus sur l'input
        setTimeout(() => {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          input.focus();
        }, 100);
        
      } catch (error) {
        console.error("[Vinted Messages] Erreur lors du chargement de la conversation:", error);
        messagesContainer.innerHTML = '<div class="vinted-notif-messages-error">Erreur lors du chargement</div>';
      }
    }
  }
}

/**
 * Affiche une modal avec la conversation (ancienne fonction, conservée pour compatibilité)
 * @param {string|number} conversationId - ID de la conversation
 */
async function showConversationModal(conversationId) {
  try {
    // Afficher un loader
    const modal = createModalElement();
    document.body.appendChild(modal);
    
    const conversation = await fetchConversation(conversationId);
    
    // Déterminer l'ID de l'utilisateur actuel en analysant les messages
    // L'utilisateur actuel est celui qui n'est pas l'opposite_user
    const oppositeUserId = conversation.opposite_user.id;
    let currentUserId = oppositeUserId; // Par défaut
    
    // Chercher un message de l'utilisateur actuel
    for (const msg of conversation.messages) {
      if (msg.entity_type === 'message' && msg.entity?.user_id && msg.entity.user_id !== oppositeUserId) {
        currentUserId = msg.entity.user_id;
        break;
      }
    }
    
    // Construire le HTML de la conversation
    const conversationUrl = conversation.conversation_url || `https://www.vinted.fr/inbox/${conversationId}`;
    const transaction = conversation.transaction || null;
    const messagesHtml = conversation.messages.map(msg => formatMessage(msg, currentUserId, conversationUrl, transaction)).join('');
    
    const modalContent = modal.querySelector('.vinted-conversation-content');
    modalContent.innerHTML = `
      <div class="vinted-conversation-header">
        <div class="vinted-conversation-user">
          <img src="${conversation.opposite_user.photo?.thumbnails?.find(t => t.type === "thumb100")?.url || conversation.opposite_user.photo?.url || 'https://via.placeholder.com/50'}" 
               alt="${conversation.opposite_user.login}"
               class="vinted-conversation-avatar">
          <div class="vinted-conversation-user-info">
            <div class="vinted-conversation-username">${escapeHtml(conversation.opposite_user.login)}</div>
            ${conversation.subtitle ? `<div class="vinted-conversation-subtitle">${escapeHtml(conversation.subtitle)}</div>` : ''}
          </div>
        </div>
        <button class="vinted-conversation-close" aria-label="Fermer">×</button>
      </div>
      <div class="vinted-conversation-messages">
        ${messagesHtml}
      </div>
      <div class="vinted-conversation-footer">
        <a href="${conversation.conversation_url}" target="_blank" class="vinted-conversation-link">
          Ouvrir sur Vinted →
        </a>
      </div>
    `;
    
    // Gestionnaire pour fermer la modal
    const closeBtn = modal.querySelector('.vinted-conversation-close');
    closeBtn.addEventListener('click', () => closeModal(modal));
    
    // Fermer en cliquant sur l'overlay
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal(modal);
      }
    });
    
    // Fermer avec Escape
    const escapeHandler = (e) => {
      if (e.key === 'Escape') {
        closeModal(modal);
        document.removeEventListener('keydown', escapeHandler);
      }
    };
    document.addEventListener('keydown', escapeHandler);
    
    // Faire défiler vers le bas pour voir les derniers messages
    const messagesContainer = modal.querySelector('.vinted-conversation-messages');
    setTimeout(() => {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 100);
    
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de l'affichage de la conversation:", error);
    alert("Erreur lors du chargement de la conversation. Veuillez réessayer.");
  }
}

/**
 * Crée l'élément modal
 */
function createModalElement() {
  const modal = document.createElement('div');
  modal.className = 'vinted-conversation-modal';
  modal.innerHTML = `
    <div class="vinted-conversation-container">
      <div class="vinted-conversation-content">
        <div class="vinted-conversation-loading">Chargement...</div>
      </div>
    </div>
  `;
  return modal;
}

/**
 * Ferme la modal
 */
function closeModal(modal) {
  modal.style.opacity = '0';
  setTimeout(() => {
    modal.remove();
  }, 300);
}

/**
 * Vérifie les nouveaux messages et affiche les notifications
 */
async function checkNewMessages() {
  try {
    const data = await fetchInbox();
    const unreadConversations = getUnreadConversations(data.conversations);
    
    // Première initialisation
    if (!notificationState.isInitialized) {
      // Mémoriser toutes les conversations
      data.conversations.forEach(conv => {
        notificationState.knownConversationIds.add(conv.id);
        if (conv.unread) {
          notificationState.knownUnreadIds.add(conv.id);
        }
      });
      
      notificationState.isInitialized = true;
      console.log(`[Vinted Messages] Initialisé avec ${notificationState.knownConversationIds.size} conversations connues`);
      
      // Si la config est activée, afficher les notifications pour les messages déjà non lus
      if (CONFIG.SHOW_EXISTING_UNREAD && unreadConversations.length > 0) {
        console.log(`[Vinted Messages] ${unreadConversations.length} message(s) non lu(s) trouvé(s) au démarrage`);
        for (const conv of unreadConversations) {
          const convInfo = formatConversationInfo(conv);
          showNotification(convInfo);
        }
      }
      
      return;
    }
    
    // Créer un Set des IDs des conversations non lues actuelles
    const currentUnreadIds = new Set(unreadConversations.map(c => c.id));
    
    // Détecter les conversations qui sont devenues non lues (nouvelles ou qui redeviennent non lues)
    const newlyUnreadConversations = unreadConversations.filter(conv => {
      // Soit c'est une nouvelle conversation, soit elle était lue avant et est maintenant non lue
      const isNew = !notificationState.knownConversationIds.has(conv.id);
      const becameUnread = !notificationState.knownUnreadIds.has(conv.id) && currentUnreadIds.has(conv.id);
      return isNew || becameUnread;
    });
    
    // Afficher les notifications pour les conversations nouvellement non lues
    for (const conv of newlyUnreadConversations) {
      // Ne pas afficher si déjà affichée
      if (!notificationState.activeNotifications.has(conv.id)) {
      const convInfo = formatConversationInfo(conv);
      showNotification(convInfo);
        console.log(`[Vinted Messages] Nouvelle notification pour la conversation ${conv.id}`);
      }
    }
    
    // Mettre à jour la liste des conversations connues
    data.conversations.forEach(conv => {
      notificationState.knownConversationIds.add(conv.id);
      if (conv.unread) {
        notificationState.knownUnreadIds.add(conv.id);
      } else {
        notificationState.knownUnreadIds.delete(conv.id);
      }
    });
    
    // Fermer les notifications pour les conversations qui ne sont plus non lues
    for (const [convId, notification] of notificationState.activeNotifications) {
      if (!currentUnreadIds.has(convId)) {
        removeNotification(convId);
        notificationState.knownUnreadIds.delete(convId);
      }
    }
    
    if (newlyUnreadConversations.length > 0) {
      console.log(`[Vinted Messages] ${newlyUnreadConversations.length} conversation(s) nouvellement non lue(s)`);
    }
    
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de la vérification des messages:", error);
  }
}

/**
 * Démarre le système de notifications
 * @param {number} intervalMs - Intervalle de vérification en millisecondes (par défaut 10000 = 10s)
 */
function startMessageNotifications(intervalMs = 10000) {
  // Injecter les styles
  injectNotificationStyles();
  
  // Ne pas démarrer si déjà en cours
  if (notificationState.pollInterval) {
    console.log("[Vinted Messages] Notifications déjà actives");
    return;
  }
  
  console.log(`[Vinted Messages] Démarrage des notifications (intervalle: ${intervalMs}ms)`);
  
  // Première vérification immédiate
  checkNewMessages();
  
  // Vérifications périodiques
  notificationState.pollInterval = setInterval(checkNewMessages, intervalMs);
}

/**
 * Arrête le système de notifications
 */
function stopMessageNotifications() {
  if (notificationState.pollInterval) {
    clearInterval(notificationState.pollInterval);
    notificationState.pollInterval = null;
    console.log("[Vinted Messages] Notifications arrêtées");
  }
  
  // Supprimer toutes les notifications actives
  for (const convId of notificationState.activeNotifications.keys()) {
    removeNotification(convId);
  }
}

/**
 * Réinitialise l'état des notifications
 */
function resetNotificationState() {
  stopMessageNotifications();
  notificationState.knownConversationIds.clear();
  notificationState.isInitialized = false;
}


  
  // ==========================================
  // utils.js
  // ==========================================
  
  // Utilitaires généraux

// Échapper le HTML
function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

// Formater le prix
function formatPrice(item) {
  // Gérer différents formats de prix
  let amount = item.price?.amount || item.price?.value || item.price || 0;
  
  // Si amount est une chaîne, la convertir en nombre
  if (typeof amount === 'string') {
    amount = parseFloat(amount.replace(',', '.')) || 0;
  }
  
  const currency = item.price?.currency || item.price?.currency_code || "EUR";

  return new Intl.NumberFormat("fr-FR", {
    style: "currency",
    currency: currency,
  }).format(amount);
}

// Formater l'heure
function formatTime(date) {
  return new Intl.DateTimeFormat("fr-FR", {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
  }).format(date);
}

// Extraire la taille
function extractSize(item) {
  const sizeLabel =
    item.size_title ||
    item.size?.localized_title ||
    item.size?.title ||
    item.size?.brand_size;

  if (!sizeLabel) return null;

  return sizeLabel
    .replace(/^(taille|size)\s+/i, "")
    .replace(/\b(taille unique|unique size)\b/i, "TU")
    .split(/[\s,/|-]+/)[0]
    ?.toUpperCase();
}

// Extraire la condition
function extractCondition(item) {
  if (typeof item.condition === "string") return item.condition;
  return (
    item.condition?.translated_title ||
    item.condition?.title ||
    item.condition_title ||
    item.status ||
    null
  );
}


  
  // ==========================================
  // itemDetails.js
  // ==========================================
  
  // Gestion de l'affichage des détails de produit dans une fenêtre transparente

/**
 * Extrait l'ID et le nom du produit depuis une URL Vinted
 * @param {string} url - URL du produit
 * @returns {Object|null} - {id: string, slug: string} ou null
 */
function extractItemInfoFromUrl(url) {
  // Format: /items/7573189306-giacca-carhartt
  const match = url.match(/\/items\/(\d+)(?:-(.+))?/);
  if (!match) return null;
  
  return {
    id: match[1],
    slug: match[2] || ''
  };
}

/**
 * Affiche un skeleton de chargement dans le modal
 * @param {HTMLElement} modalBody - Corps du modal
 */
function renderItemDetailsSkeleton(modalBody) {
  modalBody.innerHTML = `
    <div class="vinted-item-details-skeleton">
      <div class="vinted-item-skeleton-photos">
        <div class="vinted-item-skeleton-photo-main"></div>
        <div class="vinted-item-skeleton-thumbnails">
          <div class="vinted-item-skeleton-thumb"></div>
          <div class="vinted-item-skeleton-thumb"></div>
          <div class="vinted-item-skeleton-thumb"></div>
        </div>
      </div>
      <div class="vinted-item-skeleton-info">
        <div class="vinted-item-skeleton-title"></div>
        <div class="vinted-item-skeleton-price"></div>
        <div class="vinted-item-skeleton-meta">
          <div class="vinted-item-skeleton-meta-row">
            <div class="vinted-item-skeleton-label"></div>
            <div class="vinted-item-skeleton-value"></div>
          </div>
          <div class="vinted-item-skeleton-meta-row">
            <div class="vinted-item-skeleton-label"></div>
            <div class="vinted-item-skeleton-value"></div>
          </div>
          <div class="vinted-item-skeleton-meta-row">
            <div class="vinted-item-skeleton-label"></div>
            <div class="vinted-item-skeleton-value"></div>
          </div>
        </div>
        <div class="vinted-item-skeleton-description">
          <div class="vinted-item-skeleton-line"></div>
          <div class="vinted-item-skeleton-line"></div>
          <div class="vinted-item-skeleton-line short"></div>
        </div>
        <div class="vinted-item-skeleton-seller">
          <div class="vinted-item-skeleton-avatar"></div>
          <div class="vinted-item-skeleton-seller-name"></div>
        </div>
        <div class="vinted-item-skeleton-actions">
          <div class="vinted-item-skeleton-button"></div>
          <div class="vinted-item-skeleton-button"></div>
        </div>
      </div>
    </div>
  `;
}

/**
 * Affiche les détails d'un produit dans une fenêtre modale transparente
 * @param {string|number} itemId - ID du produit
 * @param {string} itemSlug - Nom/slug du produit (optionnel)
 */
/**
 * Injecte les styles CSS pour le modal de détails d'article si nécessaire
 */
function ensureItemModalStyles() {
  if (document.getElementById('vinted-item-modal-styles')) {
    return; // Styles déjà injectés
  }
  
  const style = document.createElement('style');
  style.id = 'vinted-item-modal-styles';
  style.textContent = `
    .vinted-item-modal {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      background: rgba(0, 0, 0, 0.5) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 999999 !important;
      animation: fadeIn 0.2s ease;
      overflow-y: auto !important;
      padding: 20px !important;
    }
    
    .vinted-item-modal-content {
      background: rgba(255, 255, 255, 0.95) !important;
      background-color: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      border-radius: 12px !important;
      width: 90% !important;
      max-width: 900px !important;
      max-height: 90vh !important;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2) !important;
      animation: slideUp 0.3s ease;
      position: relative !important;
      overflow-y: auto !important;
      scrollbar-width: none !important;
      -ms-overflow-style: none !important;
    }
    
    .vinted-item-modal-content::-webkit-scrollbar {
      display: none !important;
    }
    
    .vinted-dark-mode .vinted-item-modal-content {
      background: rgba(30, 30, 30, 0.95) !important;
      background-color: rgba(30, 30, 30, 0.95) !important;
      color: white !important;
    }
    
    .vinted-item-modal-close {
      position: absolute !important;
      top: 1rem !important;
      right: 1rem !important;
      background: rgba(0, 0, 0, 0.3) !important;
      border: none !important;
      font-size: 1.5rem !important;
      cursor: pointer !important;
      color: white !important;
      padding: 0.5rem !important;
      width: 40px !important;
      height: 40px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      border-radius: 50% !important;
      transition: all 0.2s !important;
      z-index: 10 !important;
    }
    
    .vinted-item-modal-close:hover {
      background: rgba(0, 0, 0, 0.5) !important;
      transform: scale(1.1) !important;
    }
    
    .vinted-item-modal-body {
      padding: 2rem !important;
    }
    
    .vinted-item-loading {
      padding: 2rem !important;
      text-align: center !important;
      color: #666 !important;
      font-size: 1rem !important;
    }
    
    .vinted-dark-mode .vinted-item-loading {
      color: rgba(255, 255, 255, 0.7) !important;
    }
    
    .vinted-item-details {
      display: grid !important;
      grid-template-columns: 300px 1fr !important;
      gap: 2rem !important;
      align-items: start !important;
    }
    
    @media (max-width: 768px) {
      .vinted-item-details {
        grid-template-columns: 1fr !important;
      }
    }
    
    .vinted-item-photos {
      display: flex !important;
      flex-direction: column !important;
      gap: 0.75rem !important;
      position: sticky !important;
      top: 2rem !important;
    }
    
    .vinted-item-photo-main {
      width: 100% !important;
      max-width: 300px !important;
      aspect-ratio: 1 !important;
      overflow: hidden !important;
      border-radius: 8px !important;
      background: rgba(255, 255, 255, 0.1) !important;
    }
    
    .vinted-item-photo-main img {
      width: 100% !important;
      height: 100% !important;
      object-fit: contain !important;
    }
    
    .vinted-item-photo-thumbnails {
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 0.5rem !important;
      overflow-x: auto !important;
      overflow-y: visible !important;
      scrollbar-width: none !important;
      -ms-overflow-style: none !important;
      max-width: 100% !important;
      padding: 0.25rem 0 !important;
    }
    
    .vinted-item-photo-thumbnails::-webkit-scrollbar {
      display: none !important;
    }
    
    .vinted-item-photo-thumb {
      width: 60px !important;
      height: 60px !important;
      min-width: 60px !important;
      min-height: 60px !important;
      max-width: 60px !important;
      max-height: 60px !important;
      object-fit: cover !important;
      border-radius: 6px !important;
      cursor: pointer !important;
      opacity: 0.7 !important;
      transition: all 0.2s !important;
      border: 2px solid transparent !important;
      flex-shrink: 0 !important;
      display: block !important;
      visibility: visible !important;
      background: #f0f0f0 !important;
    }
    
    .vinted-item-photo-thumb:hover {
      opacity: 1 !important;
      border-color: #09B1BA !important;
      transform: scale(1.05) !important;
    }
    
    .vinted-item-photo-thumb.active {
      opacity: 1 !important;
      border-color: #09B1BA !important;
      border-width: 2px !important;
      box-shadow: 0 0 0 2px rgba(9, 177, 186, 0.3) !important;
    }
    
    .vinted-item-info {
      display: flex !important;
      flex-direction: column !important;
      gap: 1rem !important;
    }
    
    .vinted-item-title {
      font-size: 1.5rem !important;
      font-weight: 600 !important;
      margin: 0 !important;
      color: #1a1a1a !important;
    }
    
    .vinted-dark-mode .vinted-item-title {
      color: #ffffff !important;
    }
    
    .vinted-item-price-container {
      display: flex !important;
      flex-direction: column !important;
      gap: 0.25rem !important;
      margin-bottom: 0.5rem !important;
    }
    
    .vinted-item-price {
      font-size: 1.75rem !important;
      font-weight: 700 !important;
      color: #09B1BA !important;
    }
    
    .vinted-item-price-with-fees {
      font-size: 1rem !important;
      font-weight: 500 !important;
      color: #64748b !important;
      display: flex !important;
      align-items: center !important;
      gap: 0.25rem !important;
    }
    
    .vinted-item-price-fees-label {
      font-size: 0.875rem !important;
      color: #94a3b8 !important;
      font-weight: 400 !important;
    }
    
    .vinted-dark-mode .vinted-item-price-with-fees {
      color: #94a3b8 !important;
    }
    
    .vinted-dark-mode .vinted-item-price-fees-label {
      color: #64748b !important;
    }
    
    .vinted-item-status {
      display: flex !important;
      align-items: center !important;
      gap: 0.5rem !important;
      padding: 0.5rem 0 !important;
      font-size: 0.875rem !important;
    }
    
    .vinted-item-status-label {
      font-weight: 600 !important;
      color: #666 !important;
    }
    
    .vinted-dark-mode .vinted-item-status-label {
      color: rgba(255, 255, 255, 0.8) !important;
    }
    
    .vinted-item-status-value {
      font-weight: 500 !important;
      color: #333 !important;
    }
    
    .vinted-dark-mode .vinted-item-status-value {
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .vinted-item-status-sold .vinted-item-status-value {
      color: #ef4444 !important;
      font-weight: 600 !important;
    }
    
    .vinted-item-meta {
      display: flex !important;
      flex-direction: column !important;
      gap: 0.75rem !important;
      padding: 1rem !important;
      background: rgba(0, 0, 0, 0.05) !important;
      border-radius: 8px !important;
    }
    
    .vinted-dark-mode .vinted-item-meta {
      background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .vinted-item-meta-row {
      display: flex !important;
      align-items: center !important;
      gap: 0.5rem !important;
    }
    
    .vinted-item-meta-label {
      font-weight: 600 !important;
      color: #666 !important;
      min-width: 80px !important;
    }
    
    .vinted-dark-mode .vinted-item-meta-label {
      color: rgba(255, 255, 255, 0.7) !important;
    }
    
    .vinted-item-meta-value {
      color: #333 !important;
    }
    
    .vinted-dark-mode .vinted-item-meta-value {
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .vinted-item-description {
      padding: 1rem !important;
      background: rgba(0, 0, 0, 0.05) !important;
      border-radius: 8px !important;
    }
    
    .vinted-dark-mode .vinted-item-description {
      background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .vinted-item-description h3 {
      margin: 0 0 0.5rem 0 !important;
      font-size: 1rem !important;
      font-weight: 600 !important;
    }
    
    .vinted-item-description p {
      margin: 0 !important;
      line-height: 1.6 !important;
      color: #333 !important;
      white-space: pre-wrap !important;
    }
    
    .vinted-dark-mode .vinted-item-description p {
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .vinted-item-seller {
      padding: 1rem !important;
      background: rgba(0, 0, 0, 0.05) !important;
      border-radius: 8px !important;
    }
    
    .vinted-dark-mode .vinted-item-seller {
      background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .vinted-item-seller h3 {
      margin: 0 0 0.5rem 0 !important;
      font-size: 1rem !important;
      font-weight: 600 !important;
    }
    
    .vinted-item-seller-info {
      display: flex !important;
      align-items: flex-start !important;
      gap: 0.75rem !important;
    }
    
    .vinted-item-seller-avatar {
      width: 40px !important;
      height: 40px !important;
      border-radius: 50% !important;
      object-fit: cover !important;
      flex-shrink: 0 !important;
    }
    
    .vinted-item-seller-details {
      display: flex !important;
      flex-direction: column !important;
      gap: 0.5rem !important;
      flex: 1 !important;
    }
    
    .vinted-item-seller-name-row {
      display: flex !important;
      align-items: center !important;
      gap: 0.5rem !important;
      flex-wrap: wrap !important;
    }
    
    .vinted-item-seller-name {
      font-weight: 500 !important;
      color: #333 !important;
    }
    
    .vinted-dark-mode .vinted-item-seller-name {
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .vinted-item-seller-id {
      font-size: 0.75rem !important;
      color: #999 !important;
    }
    
    .vinted-dark-mode .vinted-item-seller-id {
      color: rgba(255, 255, 255, 0.6) !important;
    }
    
    .vinted-item-seller-rating {
      display: flex !important;
      align-items: center !important;
      gap: 0.5rem !important;
      flex-wrap: wrap !important;
    }
    
    .vinted-item-seller-rating-stars {
      color: #fbbf24 !important;
      font-size: 0.875rem !important;
      letter-spacing: 0.05em !important;
    }
    
    .vinted-item-seller-rating-value {
      font-size: 0.875rem !important;
      font-weight: 500 !important;
      color: #666 !important;
    }
    
    .vinted-dark-mode .vinted-item-seller-rating-value {
      color: rgba(255, 255, 255, 0.7) !important;
    }
    
    .vinted-item-seller-review-count {
      font-size: 0.75rem !important;
      color: #999 !important;
    }
    
    .vinted-dark-mode .vinted-item-seller-review-count {
      color: rgba(255, 255, 255, 0.6) !important;
    }
    
    .vinted-item-actions {
      display: flex !important;
      gap: 1rem !important;
      flex-wrap: wrap !important;
    }
    
    .vinted-item-pin-btn,
    .vinted-item-offer-btn,
    .vinted-item-buy-btn {
      flex: 1 !important;
      min-width: 150px !important;
      padding: 0.75rem 1.5rem !important;
      border: none !important;
      border-radius: 8px !important;
      font-size: 0.875rem !important;
      font-weight: 500 !important;
      cursor: pointer !important;
      transition: all 0.2s !important;
      color: white !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 0.5rem !important;
    }
    
    .vinted-item-pin-btn,
    .vinted-item-offer-btn {
      background: #09B1BA !important;
    }
    
    .vinted-item-buy-btn {
      background: #3b82f6 !important;
    }
    
    .vinted-item-pin-btn:hover:not(:disabled),
    .vinted-item-offer-btn:hover:not(:disabled) {
      background: #078a91 !important;
      transform: translateY(-1px) !important;
    }
    
    .vinted-item-buy-btn:hover:not(:disabled) {
      background: #2563eb !important;
      transform: translateY(-1px) !important;
    }
    
    .vinted-item-pin-btn:disabled,
    .vinted-item-offer-btn:disabled,
    .vinted-item-buy-btn:disabled {
      opacity: 0.7 !important;
      cursor: wait !important;
      background: #6b7280 !important;
    }
    
    .vinted-item-buy-btn .buy-icon {
      font-size: 1rem !important;
    }
    
    .vinted-item-buy-btn .buy-text {
      font-weight: 600 !important;
    }
    
    .vinted-item-error {
      padding: 2rem !important;
      text-align: center !important;
      color: #333 !important;
    }
    
    .vinted-dark-mode .vinted-item-error {
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .vinted-item-error h3 {
      margin: 0 0 1rem 0 !important;
      font-size: 1.25rem !important;
      color: #ef4444 !important;
    }
    
    .vinted-item-error p {
      margin: 0 0 1.5rem 0 !important;
      color: #666 !important;
    }
    
    .vinted-dark-mode .vinted-item-error p {
      color: rgba(255, 255, 255, 0.7) !important;
    }
    
    .vinted-item-error-close {
      padding: 0.75rem 1.5rem !important;
      background: #09B1BA !important;
      color: white !important;
      border: none !important;
      border-radius: 8px !important;
      font-size: 0.875rem !important;
      font-weight: 500 !important;
      cursor: pointer !important;
      transition: all 0.2s !important;
    }
    
    .vinted-item-error-close:hover {
      background: #078a91 !important;
      transform: translateY(-1px) !important;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* Skeleton Loading Styles */
    .vinted-item-details-skeleton {
      display: grid !important;
      grid-template-columns: 300px 1fr !important;
      gap: 2rem !important;
      align-items: start !important;
    }
    
    @media (max-width: 768px) {
      .vinted-item-details-skeleton {
        grid-template-columns: 1fr !important;
      }
    }
    
    .vinted-item-skeleton-photos {
      display: flex !important;
      flex-direction: column !important;
      gap: 0.75rem !important;
    }
    
    .vinted-item-skeleton-photo-main {
      width: 100% !important;
      max-width: 300px !important;
      aspect-ratio: 1 !important;
      border-radius: 8px !important;
      background: linear-gradient(90deg, rgba(0, 0, 0, 0.1) 25%, rgba(0, 0, 0, 0.15) 50%, rgba(0, 0, 0, 0.1) 75%) !important;
      background-size: 200% 100% !important;
      animation: shimmer 1.5s infinite !important;
    }
    
    .vinted-dark-mode .vinted-item-skeleton-photo-main {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.1) 75%) !important;
      background-size: 200% 100% !important;
    }
    
    .vinted-item-skeleton-thumbnails {
      display: flex !important;
      gap: 0.5rem !important;
    }
    
    .vinted-item-skeleton-thumb {
      width: 60px !important;
      height: 60px !important;
      border-radius: 6px !important;
      background: linear-gradient(90deg, rgba(0, 0, 0, 0.1) 25%, rgba(0, 0, 0, 0.15) 50%, rgba(0, 0, 0, 0.1) 75%) !important;
      background-size: 200% 100% !important;
      animation: shimmer 1.5s infinite !important;
    }
    
    .vinted-dark-mode .vinted-item-skeleton-thumb {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.1) 75%) !important;
      background-size: 200% 100% !important;
    }
    
    .vinted-item-skeleton-info {
      display: flex !important;
      flex-direction: column !important;
      gap: 1rem !important;
    }
    
    .vinted-item-skeleton-title {
      width: 80% !important;
      height: 2rem !important;
      border-radius: 4px !important;
      background: linear-gradient(90deg, rgba(0, 0, 0, 0.1) 25%, rgba(0, 0, 0, 0.15) 50%, rgba(0, 0, 0, 0.1) 75%) !important;
      background-size: 200% 100% !important;
      animation: shimmer 1.5s infinite !important;
    }
    
    .vinted-dark-mode .vinted-item-skeleton-title {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.1) 75%) !important;
      background-size: 200% 100% !important;
    }
    
    .vinted-item-skeleton-price {
      width: 30% !important;
      height: 2.5rem !important;
      border-radius: 4px !important;
      background: linear-gradient(90deg, rgba(9, 177, 186, 0.3) 25%, rgba(9, 177, 186, 0.5) 50%, rgba(9, 177, 186, 0.3) 75%) !important;
      background-size: 200% 100% !important;
      animation: shimmer 1.5s infinite !important;
    }
    
    .vinted-item-skeleton-meta {
      display: flex !important;
      flex-direction: column !important;
      gap: 0.75rem !important;
      padding: 1rem !important;
      background: rgba(0, 0, 0, 0.05) !important;
      border-radius: 8px !important;
    }
    
    .vinted-dark-mode .vinted-item-skeleton-meta {
      background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .vinted-item-skeleton-meta-row {
      display: flex !important;
      align-items: center !important;
      gap: 0.5rem !important;
    }
    
    .vinted-item-skeleton-label {
      width: 80px !important;
      height: 1.25rem !important;
      border-radius: 4px !important;
      background: linear-gradient(90deg, rgba(0, 0, 0, 0.1) 25%, rgba(0, 0, 0, 0.15) 50%, rgba(0, 0, 0, 0.1) 75%) !important;
      background-size: 200% 100% !important;
      animation: shimmer 1.5s infinite !important;
    }
    
    .vinted-dark-mode .vinted-item-skeleton-label {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.1) 75%) !important;
      background-size: 200% 100% !important;
    }
    
    .vinted-item-skeleton-value {
      width: 120px !important;
      height: 1.25rem !important;
      border-radius: 4px !important;
      background: linear-gradient(90deg, rgba(0, 0, 0, 0.1) 25%, rgba(0, 0, 0, 0.15) 50%, rgba(0, 0, 0, 0.1) 75%) !important;
      background-size: 200% 100% !important;
      animation: shimmer 1.5s infinite !important;
    }
    
    .vinted-dark-mode .vinted-item-skeleton-value {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.1) 75%) !important;
      background-size: 200% 100% !important;
    }
    
    .vinted-item-skeleton-description {
      padding: 1rem !important;
      background: rgba(0, 0, 0, 0.05) !important;
      border-radius: 8px !important;
      display: flex !important;
      flex-direction: column !important;
      gap: 0.5rem !important;
    }
    
    .vinted-dark-mode .vinted-item-skeleton-description {
      background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .vinted-item-skeleton-line {
      width: 100% !important;
      height: 1rem !important;
      border-radius: 4px !important;
      background: linear-gradient(90deg, rgba(0, 0, 0, 0.1) 25%, rgba(0, 0, 0, 0.15) 50%, rgba(0, 0, 0, 0.1) 75%) !important;
      background-size: 200% 100% !important;
      animation: shimmer 1.5s infinite !important;
    }
    
    .vinted-item-skeleton-line.short {
      width: 70% !important;
    }
    
    .vinted-dark-mode .vinted-item-skeleton-line {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.1) 75%) !important;
      background-size: 200% 100% !important;
    }
    
    .vinted-item-skeleton-seller {
      padding: 1rem !important;
      background: rgba(0, 0, 0, 0.05) !important;
      border-radius: 8px !important;
      display: flex !important;
      align-items: center !important;
      gap: 0.75rem !important;
    }
    
    .vinted-dark-mode .vinted-item-skeleton-seller {
      background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .vinted-item-skeleton-avatar {
      width: 40px !important;
      height: 40px !important;
      border-radius: 50% !important;
      background: linear-gradient(90deg, rgba(0, 0, 0, 0.1) 25%, rgba(0, 0, 0, 0.15) 50%, rgba(0, 0, 0, 0.1) 75%) !important;
      background-size: 200% 100% !important;
      animation: shimmer 1.5s infinite !important;
    }
    
    .vinted-dark-mode .vinted-item-skeleton-avatar {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.1) 75%) !important;
      background-size: 200% 100% !important;
    }
    
    .vinted-item-skeleton-seller-name {
      width: 120px !important;
      height: 1.25rem !important;
      border-radius: 4px !important;
      background: linear-gradient(90deg, rgba(0, 0, 0, 0.1) 25%, rgba(0, 0, 0, 0.15) 50%, rgba(0, 0, 0, 0.1) 75%) !important;
      background-size: 200% 100% !important;
      animation: shimmer 1.5s infinite !important;
    }
    
    .vinted-dark-mode .vinted-item-skeleton-seller-name {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.1) 75%) !important;
      background-size: 200% 100% !important;
    }
    
    .vinted-item-skeleton-actions {
      display: flex !important;
      gap: 1rem !important;
      flex-wrap: wrap !important;
    }
    
    .vinted-item-skeleton-button {
      flex: 1 !important;
      min-width: 150px !important;
      height: 2.5rem !important;
      border-radius: 8px !important;
      background: linear-gradient(90deg, rgba(9, 177, 186, 0.3) 25%, rgba(9, 177, 186, 0.5) 50%, rgba(9, 177, 186, 0.3) 75%) !important;
      background-size: 200% 100% !important;
      animation: shimmer 1.5s infinite !important;
    }
    
    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }
    
    /* Styles pour le formulaire d'offre intégré */
    .vinted-item-offer-form-container {
      margin-top: 1rem !important;
      padding: 1rem !important;
      background: rgba(0, 0, 0, 0.05) !important;
      backdrop-filter: blur(2px) !important;
      -webkit-backdrop-filter: blur(2px) !important;
      border-radius: 8px !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
    }
    
    .vinted-dark-mode .vinted-item-offer-form-container {
      background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .vinted-item-offer-form-header {
      display: flex !important;
      align-items: center !important;
      justify-content: space-between !important;
      margin-bottom: 1rem !important;
    }
    
    .vinted-item-offer-form-header h3 {
      margin: 0 !important;
      font-size: 1.125rem !important;
      font-weight: 600 !important;
      color: #333 !important;
    }
    
    .vinted-dark-mode .vinted-item-offer-form-header h3 {
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .vinted-item-offer-form-close {
      background: none !important;
      border: none !important;
      font-size: 1.5rem !important;
      cursor: pointer !important;
      color: #666 !important;
      padding: 0 !important;
      width: 24px !important;
      height: 24px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      transition: color 0.2s !important;
    }
    
    .vinted-item-offer-form-close:hover {
      color: #333 !important;
    }
    
    .vinted-dark-mode .vinted-item-offer-form-close {
      color: rgba(255, 255, 255, 0.7) !important;
    }
    
    .vinted-dark-mode .vinted-item-offer-form-close:hover {
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .vinted-item-offer-form-body {
      display: flex !important;
      flex-direction: column !important;
      gap: 1rem !important;
    }
    
    .vinted-item-offer-form-body label {
      font-weight: 500 !important;
      color: #333 !important;
      font-size: 0.875rem !important;
    }
    
    .vinted-dark-mode .vinted-item-offer-form-body label {
      color: rgba(255, 255, 255, 0.8) !important;
    }
    
    .vinted-item-offer-price-input {
      padding: 0.75rem !important;
      border: 1px solid rgba(0, 0, 0, 0.2) !important;
      border-radius: 6px !important;
      font-size: 1rem !important;
      background: rgba(255, 255, 255, 0.9) !important;
      color: #333 !important;
      transition: all 0.2s !important;
    }
    
    .vinted-item-offer-price-input:focus {
      outline: none !important;
      border-color: #09B1BA !important;
      box-shadow: 0 0 0 3px rgba(9, 177, 186, 0.1) !important;
    }
    
    .vinted-dark-mode .vinted-item-offer-price-input {
      background: rgba(255, 255, 255, 0.1) !important;
      border-color: rgba(255, 255, 255, 0.2) !important;
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .vinted-dark-mode .vinted-item-offer-price-input:focus {
      border-color: #09B1BA !important;
      box-shadow: 0 0 0 3px rgba(9, 177, 186, 0.2) !important;
    }
    
    .vinted-item-offer-form-actions {
      display: flex !important;
      gap: 0.75rem !important;
      margin-top: 0.5rem !important;
    }
    
    .vinted-item-offer-form-cancel,
    .vinted-item-offer-form-submit {
      flex: 1 !important;
      padding: 0.75rem 1rem !important;
      border: none !important;
      border-radius: 6px !important;
      font-size: 0.875rem !important;
      font-weight: 500 !important;
      cursor: pointer !important;
      transition: all 0.2s !important;
    }
    
    .vinted-item-offer-form-cancel {
      background: rgba(0, 0, 0, 0.1) !important;
      color: #333 !important;
    }
    
    .vinted-item-offer-form-cancel:hover {
      background: rgba(0, 0, 0, 0.15) !important;
    }
    
    .vinted-dark-mode .vinted-item-offer-form-cancel {
      background: rgba(255, 255, 255, 0.1) !important;
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .vinted-dark-mode .vinted-item-offer-form-cancel:hover {
      background: rgba(255, 255, 255, 0.15) !important;
    }
    
    .vinted-item-offer-form-submit {
      background: #09B1BA !important;
      color: white !important;
    }
    
    .vinted-item-offer-form-submit:hover:not(:disabled) {
      background: #078a91 !important;
      transform: translateY(-1px) !important;
    }
    
    .vinted-item-offer-form-submit:disabled {
      opacity: 0.6 !important;
      cursor: not-allowed !important;
    }
  `;
  
  document.head.appendChild(style);
}

async function showItemDetails(itemId, itemSlug = '') {
  console.log(`[Vinted Item Details] showItemDetails appelé pour itemId: ${itemId}, slug: ${itemSlug || 'aucun'}`);
  
  // S'assurer que les styles sont injectés
  ensureItemModalStyles();
  console.log('[Vinted Item Details] Styles CSS vérifiés/injectés');
  
  // Créer le modal immédiatement pour afficher le skeleton
  const modal = document.createElement('div');
  modal.className = 'vinted-item-modal';
  modal.innerHTML = `
    <div class="vinted-item-modal-content">
      <button class="vinted-item-modal-close" aria-label="Fermer">×</button>
      <div class="vinted-item-modal-body">
        <div class="vinted-item-loading">Chargement...</div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  console.log('[Vinted Item Details] Modal créée et ajoutée au DOM');
  
  // Vérifier que la modal est visible
  const computedStyle = window.getComputedStyle(modal);
  console.log('[Vinted Item Details] Modal display:', computedStyle.display);
  console.log('[Vinted Item Details] Modal z-index:', computedStyle.zIndex);
  console.log('[Vinted Item Details] Modal position:', computedStyle.position);
  
  // Afficher le skeleton immédiatement
  const modalBody = modal.querySelector('.vinted-item-modal-body');
  renderItemDetailsSkeleton(modalBody);
  
  // Gestionnaires d'événements pour la fermeture
  const closeBtn = modal.querySelector('.vinted-item-modal-close');
  let closeModal = () => {
    modal.style.opacity = '0';
    setTimeout(() => {
      if (modal.parentNode) {
        document.body.removeChild(modal);
      }
      isModalOpen = false;
    }, 300);
  };
  
  let isClosing = false;
  const originalCloseModal = closeModal;
  closeModal = () => {
    if (isClosing) return;
    isClosing = true;
    
    // Nettoyer immédiatement le contenu pour libérer la mémoire
    const modalBody = modal.querySelector('.vinted-item-modal-body');
    if (modalBody) {
      // Vider les images pour libérer la mémoire
      const images = modalBody.querySelectorAll('img');
      images.forEach(img => {
        img.src = '';
        img.srcset = '';
      });
      // Vider le contenu après un court délai
      setTimeout(() => {
        modalBody.innerHTML = '';
      }, 100);
    }
    
    originalCloseModal();
    
    // Forcer le garbage collection en vidant les références
    setTimeout(() => {
      modal = null;
      content = null;
      closeBtn = null;
    }, 300);
  };
  
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
  
  // Empêcher la fermeture lors du clic dans le contenu
  const content = modal.querySelector('.vinted-item-modal-content');
  content.addEventListener('click', (e) => {
    e.stopPropagation();
  });
  
  try {
    console.log(`[Vinted Item Details] Appel de fetchItemDetails...`);
    const item = await fetchItemDetails(itemId, itemSlug);
    console.log(`[Vinted Item Details] fetchItemDetails terminé, item reçu:`, item ? { id: item.id, title: item.title?.substring(0, 50) } : null);
    if (!item) {
      throw new Error('Produit non trouvé');
    }

    // Remplacer le skeleton par les vraies données
    console.log('[Vinted Item Details] Appel de renderItemDetails avec item:', item);
    renderItemDetails(modal, item);
    console.log('[Vinted Item Details] renderItemDetails terminé');
    
  } catch (error) {
    console.error("[Vinted Item] Erreur lors de l'affichage des détails:", error);
    // Afficher un message d'erreur dans le modal au lieu d'une alerte
    const modalBody = modal.querySelector('.vinted-item-modal-body');
    if (modalBody) {
      modalBody.innerHTML = `
        <div class="vinted-item-error">
          <h3>Erreur lors du chargement</h3>
          <p>Impossible de charger les détails du produit. Veuillez réessayer.</p>
          <button class="vinted-item-error-close" onclick="this.closest('.vinted-item-modal').remove(); isModalOpen = false;">Fermer</button>
        </div>
      `;
    } else {
      alert("Erreur lors du chargement des détails du produit.");
      if (modal.parentNode) {
        document.body.removeChild(modal);
      }
      isModalOpen = false;
    }
  }
}

/**
 * Rend les détails du produit dans le modal
 * @param {HTMLElement} modal - Élément modal
 * @param {Object} item - Données du produit
 */
function renderItemDetails(modal, item) {
  const body = modal.querySelector('.vinted-item-modal-body');
  
  // Construire l'URL de l'article (comme dans la liste des articles)
  let itemUrl = item.url;
  if (!itemUrl || itemUrl === 'undefined') {
    // Construire l'URL à partir de l'ID et du slug/title
    const slug = item.slug || item.title?.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') || '';
    itemUrl = `https://www.vinted.fr/items/${item.id}${slug ? '-' + slug : ''}`;
  } else if (!itemUrl.startsWith('http')) {
    itemUrl = `https://www.vinted.fr${itemUrl}`;
  }
  
  // Photos - Filtrer pour éviter les doublons et exclure la photo de profil
  let photos = item.photos || [];
  console.log(`[Vinted Item Details] Photos initiales: ${photos.length}`);
  
  // Fonction pour obtenir l'URL formatée (f800)
  const getImageUrl = (photo) => {
    const url = typeof photo === 'string' ? photo : (photo.url || '');
    if (!url) return '';
    // Utiliser le format f800 pour toutes les images
    if (url.includes('/f800/') || url.includes('/f1024/')) {
      return url;
    }
    // Remplacer le format existant par f800
    return url.replace(/\/\d+x\d+\//, '/f800/');
  };
  
  // Fonction pour obtenir l'URL de miniature
  const getThumbnailUrl = (photo) => {
    const url = getImageUrl(photo);
    if (!url) return '';
    // Essayer différents formats de miniatures
    // Format f70x100 pour les miniatures
    if (url.includes('/f800/')) {
      return url.replace('/f800/', '/f70x100/');
    }
    if (url.includes('/f1024/')) {
      return url.replace('/f1024/', '/f70x100/');
    }
    // Si le format n'est pas reconnu, utiliser l'URL complète
    return url;
  };
  
  // Filtrer les photos : exclure les photos de profil
  const beforeFilter = photos.length;
  photos = photos.filter(photo => {
    const url = typeof photo === 'string' ? photo : (photo.url || '');
    // Exclure les photos de profil (généralement dans des dossiers spécifiques ou de petite taille)
    if (url.includes('/50x50/') || url.includes('/avatar') || url.includes('/profile') || 
        url.includes('/user') || url.match(/\/\d+x\d+\//)?.[0]?.includes('50x50')) {
      return false;
    }
    return true;
  });
  console.log(`[Vinted Item Details] Photos après filtrage: ${photos.length} (${beforeFilter - photos.length} exclues)`);
  
  // Dédupliquer par URL (garder seulement les URLs uniques)
  const uniquePhotos = [];
  const seenUrls = new Set();
  for (const photo of photos) {
    const url = getImageUrl(photo);
    if (url && !seenUrls.has(url)) {
      seenUrls.add(url);
      uniquePhotos.push({ url: url });
    }
  }
  photos = uniquePhotos;
  console.log(`[Vinted Item Details] Photos finales (uniques): ${photos.length}`);
  
  // Générer le HTML des photos avec toutes les miniatures visibles
  const photosHtml = photos.length > 0 ? `
    <div class="vinted-item-photos">
      <div class="vinted-item-photo-main">
        <img src="${getImageUrl(photos[0])}" alt="${item.title}" id="vinted-item-main-photo">
      </div>
      ${photos.length > 1 ? `
        <div class="vinted-item-photo-thumbnails">
          ${photos.map((photo, index) => {
            // Utiliser l'URL complète pour les miniatures (le navigateur optimisera l'affichage)
            const fullUrl = getImageUrl(photo);
            return `
            <img src="${fullUrl}" alt="Photo ${index + 1}" 
                 class="vinted-item-photo-thumb ${index === 0 ? 'active' : ''}"
                 data-index="${index}"
                 data-full-url="${fullUrl}">
          `;
          }).join('')}
        </div>
      ` : ''}
    </div>
  ` : '';
  
  // Prix - extraire et formater avec plusieurs fallbacks
  let price = 'Prix non disponible';
  if (item.price) {
    price = formatPrice(item);
  } else if (item.price_amount) {
    // Format alternatif
    const amount = typeof item.price_amount === 'string' 
      ? parseFloat(item.price_amount.replace(',', '.')) 
      : item.price_amount;
    const currency = item.price_currency || item.currency || 'EUR';
    price = new Intl.NumberFormat("fr-FR", {
      style: "currency",
      currency: currency,
    }).format(amount);
  }
  
  // Prix avec frais
  let priceWithFees = '';
  if (item.price_with_fees) {
    if (item.price_with_fees.formatted) {
      priceWithFees = item.price_with_fees.formatted;
    } else if (item.price_with_fees.amount) {
      const amount = typeof item.price_with_fees.amount === 'string' 
        ? parseFloat(item.price_with_fees.amount.replace(',', '.')) 
        : item.price_with_fees.amount;
      const currency = item.price_with_fees.currency_code || item.currency || 'EUR';
      priceWithFees = new Intl.NumberFormat("fr-FR", {
        style: "currency",
        currency: currency,
      }).format(amount);
    }
  } else if (item.price_with_protection) {
    // Fallback sur price_with_protection si price_with_fees n'est pas disponible
    if (item.price_with_protection.amount) {
      const amount = typeof item.price_with_protection.amount === 'string' 
        ? parseFloat(item.price_with_protection.amount.replace(',', '.')) 
        : item.price_with_protection.amount;
      const currency = item.price_with_protection.currency_code || item.currency || 'EUR';
      priceWithFees = new Intl.NumberFormat("fr-FR", {
        style: "currency",
        currency: currency,
      }).format(amount);
    }
  }
  
  // Taille - extraire avec plusieurs fallbacks
  let size = extractSize(item);
  if (!size) {
    size = item.size_title || item.size?.title || item.size?.localized_title || item.size?.brand_size || 'Taille non spécifiée';
  }
  
  // Marque - extraire avec plusieurs fallbacks
  let brand = item.brand?.title || item.brand?.name || item.brand_title;
  if (!brand && typeof item.brand === 'string') {
    brand = item.brand;
  }
  if (!brand) {
    brand = 'Marque non spécifiée';
  }
  
  // État/Condition - extraire avec plusieurs fallbacks
  let condition = extractCondition(item);
  if (!condition) {
    condition = item.condition_title || item.condition?.title || item.condition?.translated_title || item.status || 'État non spécifié';
  }
  
  // Couleur - extraire avec fallback
  let color = item.color || '';
  
  // Description - utiliser celle extraite, avec fallback
  let description = item.description || item.description_text || '';
  // Si la description est vide ou trop courte, essayer de la récupérer depuis og:description
  if (!description || description.length < 10) {
    const ogDesc = document.querySelector('meta[property="og:description"]')?.getAttribute('content');
    if (ogDesc && ogDesc.length > 10) {
      description = ogDesc;
    }
  }
  // Si toujours vide, utiliser le message par défaut
  if (!description || description.length < 10) {
    description = 'Aucune description';
  }
  
  // Informations du vendeur - extraire avec plusieurs fallbacks
  const seller = item.user || item.seller || {};
  const sellerName = seller.login || seller.username || seller.name || 'Vendeur inconnu';
  let sellerAvatar = seller.photo?.url || seller.avatar || '';
  // Si l'avatar est un objet avec thumbnails
  if (!sellerAvatar && seller.photo?.thumbnails) {
    const thumb100 = seller.photo.thumbnails.find(t => t.type === 'thumb100');
    if (thumb100) sellerAvatar = thumb100.url;
  }
  
  // Calculer les étoiles pour la note du vendeur de manière sécurisée
  // Normaliser la note sur une échelle de 5
  let ratingStarsHtml = '';
  let normalizedRating = null;
  if (seller.rating !== undefined && seller.rating !== null) {
    const maxRating = seller.max_rating || 5;
    // Normaliser la note sur une échelle de 5
    normalizedRating = (seller.rating / maxRating) * 5;
    // Limiter entre 0 et 5
    normalizedRating = Math.max(0, Math.min(5, normalizedRating));
    const rating = Math.round(normalizedRating);
    const filledStars = Math.max(0, rating);
    const emptyStars = Math.max(0, 5 - filledStars);
    ratingStarsHtml = `${'★'.repeat(filledStars)}${'☆'.repeat(emptyStars)}`;
  }
  
  console.log('[Vinted Item Details] Génération du HTML des détails...');
  const htmlContent = `
    <div class="vinted-item-details">
      ${photosHtml}
      <div class="vinted-item-info">
        <h2 class="vinted-item-title">${escapeHtml(item.title || 'Titre non disponible')}</h2>
        <div class="vinted-item-price-container">
          <div class="vinted-item-price">${escapeHtml(price)}</div>
          ${priceWithFees ? `<div class="vinted-item-price-with-fees">${escapeHtml(priceWithFees)} <span class="vinted-item-price-fees-label">(frais inclus)</span></div>` : ''}
        </div>
        ${item.status || item.is_sold ? `
        <div class="vinted-item-status ${item.is_sold ? 'vinted-item-status-sold' : ''}">
          <span class="vinted-item-status-label">Statut:</span>
          <span class="vinted-item-status-value">${escapeHtml(item.status || (item.is_sold ? 'Vendu' : 'Disponible'))}</span>
        </div>
        ` : ''}
        <div class="vinted-item-meta">
          <div class="vinted-item-meta-row">
            <span class="vinted-item-meta-label">Taille:</span>
            <span class="vinted-item-meta-value">${escapeHtml(size)}</span>
          </div>
          <div class="vinted-item-meta-row">
            <span class="vinted-item-meta-label">Marque:</span>
            <span class="vinted-item-meta-value">${escapeHtml(brand)}</span>
          </div>
          <div class="vinted-item-meta-row">
            <span class="vinted-item-meta-label">État:</span>
            <span class="vinted-item-meta-value">${escapeHtml(condition)}</span>
          </div>
          ${color ? `
          <div class="vinted-item-meta-row">
            <span class="vinted-item-meta-label">Couleur:</span>
            <span class="vinted-item-meta-value">${escapeHtml(color)}</span>
          </div>
          ` : ''}
        </div>
        <div class="vinted-item-description">
          <h3>Description</h3>
          <p>${escapeHtml(description).replace(/\n/g, '<br>')}</p>
        </div>
        <div class="vinted-item-seller">
          <h3>Vendeur</h3>
          <div class="vinted-item-seller-info">
            ${sellerAvatar ? `<img src="${escapeHtml(sellerAvatar)}" alt="${escapeHtml(sellerName)}" class="vinted-item-seller-avatar">` : ''}
            <div class="vinted-item-seller-details">
              <div class="vinted-item-seller-name-row">
                <span class="vinted-item-seller-name">${escapeHtml(sellerName)}</span>
                ${seller.id ? `<span class="vinted-item-seller-id">(ID: ${seller.id})</span>` : ''}
              </div>
              ${seller.rating !== undefined && seller.rating !== null ? `
                <div class="vinted-item-seller-rating">
                  <span class="vinted-item-seller-rating-stars">${ratingStarsHtml}</span>
                  <span class="vinted-item-seller-rating-value">${normalizedRating !== null ? normalizedRating.toFixed(1) : (seller.rating || 0).toFixed(1)}/5</span>
                  ${seller.review_count !== undefined && seller.review_count !== null ? `<span class="vinted-item-seller-review-count">(${seller.review_count} avis)</span>` : ''}
                </div>
              ` : ''}
            </div>
          </div>
        </div>
        <div class="vinted-item-actions">
          <button class="vinted-item-pin-btn" data-item-id="${item.id}" title="Ajouter aux favoris">
            ❤️ Ajouter aux favoris
          </button>
          <button class="vinted-item-offer-btn" data-item-id="${item.id}">Faire une offre</button>
          <button class="vinted-item-buy-btn" data-item-url="${itemUrl}" title="Acheter rapidement">
            <span class="buy-icon">🛒</span>
            <span class="buy-text">Buy</span>
          </button>
        </div>
        <div class="vinted-item-offer-form-container" id="vinted-item-offer-form-${item.id}" style="display: none;">
          <div class="vinted-item-offer-form-header">
            <h3>Faire une offre</h3>
            <button class="vinted-item-offer-form-close" data-item-id="${item.id}" aria-label="Fermer">&times;</button>
          </div>
          <div class="vinted-item-offer-form-body">
            <label for="vinted-offer-price-${item.id}">Prix (EUR)</label>
            <input type="number" 
                   id="vinted-offer-price-${item.id}" 
                   class="vinted-item-offer-price-input" 
                   placeholder="0.00" 
                   step="0.01" 
                   min="0.01"
                   required>
            <div class="vinted-item-offer-form-actions">
              <button class="vinted-item-offer-form-cancel" data-item-id="${item.id}">Annuler</button>
              <button class="vinted-item-offer-form-submit" data-item-id="${item.id}">Envoyer l'offre</button>
            </div>
          </div>
        </div>
        <div class="vinted-item-conversation" id="vinted-item-conversation-${item.id}">
        </div>
      </div>
    </div>
  `;
  
  console.log('[Vinted Item Details] HTML généré, longueur:', htmlContent.length);
  body.innerHTML = htmlContent;
  console.log('[Vinted Item Details] innerHTML défini, body.children.length:', body.children.length);
  
  // Vérifier que le contenu est bien affiché
  setTimeout(() => {
    const details = body.querySelector('.vinted-item-details');
    if (details) {
      console.log('[Vinted Item Details] ✓ Contenu rendu avec succès');
      const computedStyle = window.getComputedStyle(modal);
      console.log('[Vinted Item Details] Modal visible:', computedStyle.display !== 'none', 'opacity:', computedStyle.opacity, 'z-index:', computedStyle.zIndex);
    } else {
      console.error('[Vinted Item Details] ✗ ERREUR: .vinted-item-details non trouvé après rendu');
    }
  }, 100);
  
  // Gestionnaire pour les miniatures de photos
  if (photos.length > 1) {
    const thumbnails = body.querySelectorAll('.vinted-item-photo-thumb');
    const mainPhoto = body.querySelector('#vinted-item-main-photo');
    
    if (thumbnails.length > 0 && mainPhoto) {
      thumbnails.forEach((thumb, index) => {
        // Gestionnaire d'erreur pour les images qui ne se chargent pas
        thumb.addEventListener('error', () => {
          console.warn(`[Vinted Item Details] Erreur de chargement de la miniature ${index}, utilisation de l'URL complète`);
          const fullUrl = thumb.dataset.fullUrl;
          if (fullUrl) {
            thumb.src = fullUrl;
          }
        });
        
        thumb.addEventListener('click', () => {
          const index = parseInt(thumb.dataset.index);
          // Utiliser l'URL complète stockée dans data-full-url ou reconstruire
          const fullUrl = thumb.dataset.fullUrl || getImageUrl(photos[index]);
          mainPhoto.src = fullUrl;
          
          // Mettre à jour l'état actif
          thumbnails.forEach(t => t.classList.remove('active'));
          thumb.classList.add('active');
        });
      });
      
      console.log(`[Vinted Item Details] ${thumbnails.length} miniatures configurées pour la navigation`);
    } else {
      console.warn('[Vinted Item Details] Miniatures ou photo principale non trouvées');
    }
  } else {
    console.log('[Vinted Item Details] Une seule photo, pas de miniatures nécessaires');
  }
  
  // Gestionnaire pour le bouton d'offre
  const offerBtn = body.querySelector('.vinted-item-offer-btn');
  const offerFormContainer = body.querySelector(`#vinted-item-offer-form-${item.id}`);
  if (offerBtn && offerFormContainer) {
    offerBtn.addEventListener('click', () => {
      // Afficher/masquer le formulaire d'offre
      const isVisible = offerFormContainer.style.display !== 'none';
      if (isVisible) {
        offerFormContainer.style.display = 'none';
        offerBtn.textContent = 'Faire une offre';
      } else {
        offerFormContainer.style.display = 'block';
        offerBtn.textContent = 'Masquer l\'offre';
        // Focus sur l'input de prix
        const priceInput = offerFormContainer.querySelector(`#vinted-offer-price-${item.id}`);
        if (priceInput) {
          setTimeout(() => priceInput.focus(), 100);
        }
      }
    });
    
    // Gestionnaire pour le bouton de fermeture du formulaire
    const closeFormBtn = offerFormContainer.querySelector('.vinted-item-offer-form-close');
    if (closeFormBtn) {
      closeFormBtn.addEventListener('click', () => {
        offerFormContainer.style.display = 'none';
        offerBtn.textContent = 'Faire une offre';
      });
    }
    
    // Gestionnaire pour le bouton Annuler
    const cancelBtn = offerFormContainer.querySelector('.vinted-item-offer-form-cancel');
    if (cancelBtn) {
      cancelBtn.addEventListener('click', () => {
        offerFormContainer.style.display = 'none';
        offerBtn.textContent = 'Faire une offre';
        const priceInput = offerFormContainer.querySelector(`#vinted-offer-price-${item.id}`);
        if (priceInput) {
          priceInput.value = '';
        }
      });
    }
    
    // Gestionnaire pour le bouton Envoyer
    const submitBtn = offerFormContainer.querySelector('.vinted-item-offer-form-submit');
    if (submitBtn) {
      submitBtn.addEventListener('click', async () => {
        await handleOfferSubmit(item.id, offerFormContainer, modal, item);
      });
    }
    
    // Permettre d'envoyer avec Enter
    const priceInput = offerFormContainer.querySelector(`#vinted-offer-price-${item.id}`);
    if (priceInput) {
      priceInput.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          await handleOfferSubmit(item.id, offerFormContainer, modal, item);
        }
      });
    }
  }
  
  // Gestionnaire pour le bouton d'épinglage (favoris)
  const pinBtn = body.querySelector('.vinted-item-pin-btn');
  if (pinBtn) {
    // Vérifier l'état initial de manière asynchrone
    isItemPinned(item.id).then(isPinned => {
      if (isPinned) {
        pinBtn.textContent = '❤️ Retirer des favoris';
        pinBtn.title = 'Retirer des favoris';
        pinBtn.classList.add('pinned');
      }
    });
    
    pinBtn.addEventListener('click', async () => {
      // Sauvegarder l'état initial pour le texte
      const originalText = pinBtn.textContent;
      const originalTitle = pinBtn.title;
      
      // Afficher le chargement
      pinBtn.disabled = true;
      pinBtn.textContent = '⏳ Chargement...';
      pinBtn.title = 'Chargement en cours...';
      pinBtn.style.opacity = '0.7';
      pinBtn.style.cursor = 'wait';
      
      try {
        await togglePinItem(item);
        
        // Attendre un peu pour que l'API se synchronise
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Vérifier le nouvel état
        const isNowPinned = await isItemPinned(item.id);
        if (isNowPinned) {
          pinBtn.textContent = '❤️ Retirer des favoris';
          pinBtn.title = 'Retirer des favoris';
        } else {
          pinBtn.textContent = '❤️ Ajouter aux favoris';
          pinBtn.title = 'Ajouter aux favoris';
        }
        pinBtn.classList.toggle('pinned', isNowPinned);
      } catch (error) {
        console.error("[Vinted Item Details] Erreur lors du toggle favori:", error);
        // En cas d'erreur, restaurer l'état initial
        pinBtn.textContent = originalText;
        pinBtn.title = originalTitle;
      } finally {
        // Réactiver le bouton
        pinBtn.disabled = false;
        pinBtn.style.opacity = '1';
        pinBtn.style.cursor = 'pointer';
      }
    });
  }
  
  // Gestionnaire pour le bouton Buy
  const buyBtn = body.querySelector('.vinted-item-buy-btn');
  if (buyBtn) {
    buyBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const itemUrl = buyBtn.dataset.itemUrl;
      if (itemUrl) {
        quickBuyItem(itemUrl);
      }
    });
  }
  
  // Afficher directement la barre d'envoi, puis charger la conversation en arrière-plan
  const conversationContainer = modal.querySelector(`#vinted-item-conversation-${item.id}`);
  if (conversationContainer && seller.id) {
    // Afficher immédiatement la barre d'envoi vide
    renderEmptyConversation(conversationContainer, seller.id, item.id, item);
    // Charger la conversation en arrière-plan et remplacer si elle existe
    loadConversationForItem(item.id, seller.id, modal, item);
  }
}

/**
 * Gère la soumission du formulaire d'offre intégré
 * @param {string|number} itemId - ID du produit
 * @param {HTMLElement} offerFormContainer - Conteneur du formulaire d'offre
 * @param {HTMLElement} modal - Élément modal parent
 * @param {Object} item - Objet item
 */
async function handleOfferSubmit(itemId, offerFormContainer, modal, item) {
  const priceInput = offerFormContainer.querySelector(`#vinted-offer-price-${itemId}`);
  const submitBtn = offerFormContainer.querySelector('.vinted-item-offer-form-submit');
  const offerBtn = modal.querySelector('.vinted-item-offer-btn');
  
  if (!priceInput || !submitBtn) return;
  
  const price = priceInput.value.trim();
  if (!price || parseFloat(price) <= 0) {
    alert('Veuillez entrer un prix valide');
    return;
  }
  
  submitBtn.disabled = true;
  submitBtn.textContent = 'Envoi...';
  
  try {
    // Essayer de trouver une conversation existante pour cet item
    const inbox = await fetchInbox(1, 50);
    const conversations = inbox.conversations || [];
    let conversation = conversations.find(conv => {
      return conv.item?.id === parseInt(itemId) || 
             conv.item?.id === itemId;
    });
    
    if (conversation && conversation.transaction?.id) {
      // Si on a une transaction, envoyer l'offre directement
      await sendOfferRequest(conversation.transaction.id, price, 'EUR');
      alert('Offre envoyée avec succès !');
      
      // Masquer le formulaire et réinitialiser
      offerFormContainer.style.display = 'none';
      if (offerBtn) offerBtn.textContent = 'Faire une offre';
      priceInput.value = '';
      
      // Recharger la conversation pour afficher la nouvelle offre
      const conversationContainer = modal?.querySelector(`#vinted-item-conversation-${itemId}`);
      if (conversationContainer) {
        const updatedConversation = await fetchConversation(conversation.id);
        const seller = updatedConversation.opposite_user;
        if (seller && seller.id) {
          renderConversation(conversationContainer, updatedConversation, itemId, item);
        }
      }
    } else {
      // Pas de conversation/transaction existante, créer une conversation puis une transaction
      try {
        // Utiliser les données de l'item déjà chargé
        let sellerId = null;
        if (item && item.user && item.user.id) {
          sellerId = item.user.id;
          console.log(`[Vinted Item] ID vendeur depuis item: ${sellerId}`);
        }
        
        if (!sellerId) {
          // Fallback 1: récupérer les détails de l'item
          console.log(`[Vinted Item] Tentative de récupération des détails de l'item pour obtenir l'ID du vendeur...`);
          const itemDetails = await fetchItemDetails(itemId, item?.slug || '');
          if (itemDetails && itemDetails.user && itemDetails.user.id) {
            sellerId = itemDetails.user.id;
            console.log(`[Vinted Item] ID vendeur depuis fetchItemDetails: ${sellerId}`);
          }
        }
        
        // Fallback 2: essayer d'extraire depuis l'API directement
        if (!sellerId) {
          try {
            console.log(`[Vinted Item] Tentative d'extraction depuis l'API de l'item...`);
            const apiUrl = `https://www.vinted.fr/api/v2/items/${itemId}`;
            const apiResponse = await fetch(apiUrl, {
              credentials: "include",
              headers: {
                "accept": "application/json, text/plain, */*",
              },
            });
            if (apiResponse.ok) {
              const apiData = await apiResponse.json();
              if (apiData.item && apiData.item.user && apiData.item.user.id) {
                sellerId = apiData.item.user.id;
                console.log(`[Vinted Item] ID vendeur depuis API: ${sellerId}`);
              }
            }
          } catch (apiError) {
            console.warn(`[Vinted Item] Erreur lors de la récupération depuis l'API:`, apiError);
          }
        }
        
        if (!sellerId) {
          console.error(`[Vinted Item] Impossible de récupérer l'ID du vendeur. Item:`, item);
          throw new Error('Impossible de récupérer l\'ID du vendeur. Veuillez réessayer ou envoyer un message depuis la conversation ci-dessous.');
        }
        
        console.log(`[Vinted Item] Création de conversation pour item ${itemId} avec vendeur ${sellerId}...`);
        
        // Créer une conversation pour cet item avec la nouvelle API
        const itemData = item || await fetchItemDetails(itemId, '');
        const newConversation = await createConversationForItem(itemId, sellerId, `Je souhaite faire une offre de ${price} EUR`, itemData);
        
        if (!newConversation || !newConversation.id) {
          throw new Error('La création de conversation n\'a pas retourné d\'ID');
        }
        
        console.log(`[Vinted Item] Conversation créée avec succès: ${newConversation.id}`);
        
        // La conversation est créée, maintenant créer une transaction pour l'offre
        try {
          console.log(`[Vinted Item] Création de transaction pour l'offre de ${price} EUR...`);
          const transaction = await createTransactionForItem(itemId, price);
          
          if (transaction && transaction.id) {
            console.log(`[Vinted Item] Transaction créée: ${transaction.id}, envoi de l'offre...`);
            // Envoyer l'offre via la transaction
            await sendOfferRequest(transaction.id, price, 'EUR');
            console.log(`[Vinted Item] Offre envoyée avec succès !`);
            alert('Offre envoyée avec succès !');
            
            // Masquer le formulaire et réinitialiser
            offerFormContainer.style.display = 'none';
            if (offerBtn) offerBtn.textContent = 'Faire une offre';
            priceInput.value = '';
            
            // Recharger la conversation pour afficher la nouvelle offre
            const conversationContainer = modal?.querySelector(`#vinted-item-conversation-${itemId}`);
            if (conversationContainer) {
              const updatedConversation = await fetchConversation(newConversation.id);
              const seller = updatedConversation.opposite_user;
              if (seller && seller.id) {
                renderConversation(conversationContainer, updatedConversation, itemId, itemData);
              }
            }
          } else {
            console.warn("[Vinted Item] Transaction non créée, mais conversation créée");
            // Transaction non créée, mais conversation créée - ouvrir la conversation
            window.open(`https://www.vinted.fr/inbox/${newConversation.id}`, '_blank');
            alert('Conversation créée ! Vous pouvez maintenant faire une offre depuis la page de conversation.');
            offerFormContainer.style.display = 'none';
            if (offerBtn) offerBtn.textContent = 'Faire une offre';
          }
        } catch (transactionError) {
          console.error("[Vinted Item] Erreur lors de la création de la transaction:", transactionError);
          // Conversation créée mais transaction échouée - ouvrir la conversation
          window.open(`https://www.vinted.fr/inbox/${newConversation.id}`, '_blank');
          alert('Conversation créée ! Vous pouvez maintenant faire une offre depuis la page de conversation.');
          offerFormContainer.style.display = 'none';
          if (offerBtn) offerBtn.textContent = 'Faire une offre';
        }
      } catch (createError) {
        console.error("[Vinted Item] Erreur lors de la création de la conversation:", createError);
        console.error("[Vinted Item] Détails de l'erreur:", {
          message: createError.message,
          stack: createError.stack,
          itemId: itemId,
          sellerId: item?.user?.id
        });
        alert(`Erreur lors de la création de la conversation: ${createError.message}. Veuillez réessayer ou envoyer un message depuis la conversation ci-dessous.`);
        offerFormContainer.style.display = 'none';
        if (offerBtn) offerBtn.textContent = 'Faire une offre';
      }
    }
  } catch (error) {
    console.error("[Vinted Item] Erreur lors de l'envoi de l'offre:", error);
    alert("Erreur lors de l'envoi de l'offre. Veuillez réessayer.");
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Envoyer l\'offre';
  }
}

/**
 * Charge la conversation pour un produit
 * @param {string|number} itemId - ID du produit
 * @param {string|number} userId - ID du vendeur
 * @param {HTMLElement} modal - Élément modal parent
 * @param {Object} item - Données du produit
 */
async function loadConversationForItem(itemId, userId, modal, item) {
  const conversationContainer = modal.querySelector(`#vinted-item-conversation-${itemId}`);
  if (!conversationContainer) return;
  
  try {
    // Chercher une conversation existante dans l'inbox
    const inbox = await fetchInbox(1, 50);
    const conversations = inbox.conversations || [];
    
    // Trouver une conversation liée à cet item
    let conversation = conversations.find(conv => {
      return conv.item?.id === parseInt(itemId) || 
             conv.item?.id === itemId ||
             (conv.opposite_user?.id === parseInt(userId) && conv.item);
    });
    
    if (conversation) {
      // Charger les détails de la conversation et remplacer la barre d'envoi vide
      const conversationDetails = await fetchConversation(conversation.id);
      renderConversation(conversationContainer, conversationDetails, itemId, item);
    }
    // Si aucune conversation n'est trouvée, on garde la barre d'envoi vide déjà affichée
  } catch (error) {
    console.error("[Vinted Item] Erreur lors du chargement de la conversation:", error);
    // En cas d'erreur, on garde la barre d'envoi vide déjà affichée
  }
}

/**
 * Affiche la conversation pour un produit
 * @param {string|number} itemId - ID du produit
 * @param {string|number} userId - ID du vendeur
 * @param {HTMLElement} modal - Élément modal parent
 * @param {Object} item - Données du produit
 */
async function showConversationForItem(itemId, userId, modal, item) {
  const conversationContainer = modal.querySelector(`#vinted-item-conversation-${itemId}`);
  if (!conversationContainer) return;
  
  // Afficher le conteneur s'il était caché
  conversationContainer.style.display = 'block';
  
  await loadConversationForItem(itemId, userId, modal, item);
}

/**
 * Rend une conversation dans le conteneur
 * @param {HTMLElement} container - Conteneur de conversation
 * @param {Object} conversation - Données de la conversation
 * @param {string|number} itemId - ID du produit
 * @param {Object} item - Données du produit
 */
function renderConversation(container, conversation, itemId, item) {
  const oppositeUserId = conversation.opposite_user?.id;
  if (!oppositeUserId) {
    container.innerHTML = '<div class="vinted-item-conversation-error">Erreur: Impossible de charger la conversation.</div>';
    return;
  }
  
  let currentUserId = oppositeUserId;
  for (const msg of conversation.messages || []) {
    if (msg.entity_type === 'message' && msg.entity?.user_id && msg.entity.user_id !== oppositeUserId) {
      currentUserId = msg.entity.user_id;
      break;
    }
  }
  
  const conversationUrl = conversation.conversation_url || `https://www.vinted.fr/inbox/${conversation.id}`;
  const transaction = conversation.transaction || null;
  
  // Fonction pour formater les messages
  const formatMessage = (msg, userId, url, trans) => {
    const isCurrentUser = msg.entity?.user_id === userId;
    const messageClass = isCurrentUser ? 'vinted-msg-current-user' : 'vinted-msg-other-user';
    
    // Formater la date - created_at_ts peut être une chaîne ISO 8601 ou un timestamp
    let timeAgo = msg.created_time_ago || '';
    if (!timeAgo && msg.created_at_ts) {
      try {
        // Si c'est une chaîne ISO 8601, la parser directement
        const date = new Date(msg.created_at_ts);
        if (!isNaN(date.getTime())) {
          // Formater la date de manière relative
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);
          
          if (diffMins < 1) {
            timeAgo = 'À l\'instant';
          } else if (diffMins < 60) {
            timeAgo = `Il y a ${diffMins} min`;
          } else if (diffHours < 24) {
            timeAgo = `Il y a ${diffHours}h`;
          } else if (diffDays < 7) {
            timeAgo = `Il y a ${diffDays}j`;
          } else {
            timeAgo = new Intl.DateTimeFormat('fr-FR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }).format(date);
          }
        }
      } catch (e) {
        console.error("[Vinted Item] Erreur lors du formatage de la date:", e, msg.created_at_ts);
        timeAgo = '';
      }
    }
    
    if (msg.entity_type === 'message') {
      return `
        <div class="vinted-msg-item ${messageClass}">
          <div class="vinted-msg-body">${escapeHtml(msg.entity.body)}</div>
          <div class="vinted-msg-time">${escapeHtml(timeAgo)}</div>
        </div>
      `;
    } else if (msg.entity_type === 'offer_request_message' || msg.entity_type === 'offer_message') {
      // Afficher aussi les messages d'offre
      const priceLabel = msg.entity?.price_label || msg.entity?.body || '';
      const originalPrice = msg.entity?.original_price_label ? ` (Prix original: ${msg.entity.original_price_label})` : '';
      const title = msg.entity_type === 'offer_message' ? 'Offre acceptée' : (msg.entity?.title || 'Offre demandée');
      return `
        <div class="vinted-msg-item ${messageClass}">
          <div class="vinted-msg-offer ${msg.entity_type === 'offer_message' ? 'accepted' : ''}">
            <div class="vinted-msg-offer-title">${escapeHtml(title)}</div>
            <div class="vinted-msg-offer-price">${escapeHtml(priceLabel)}</div>
            ${originalPrice ? `<div class="vinted-msg-offer-original">${escapeHtml(originalPrice)}</div>` : ''}
          </div>
          <div class="vinted-msg-time">${escapeHtml(timeAgo)}</div>
        </div>
      `;
    }
    return '';
  };
  
  const messagesHtml = (conversation.messages || []).map(msg => 
    formatMessage(msg, currentUserId, conversationUrl, transaction)
  ).join('');
  
  container.innerHTML = `
    <div class="vinted-item-conversation-content">
      <div class="vinted-item-messages-list">
        ${messagesHtml}
      </div>
      <div class="vinted-item-messages-input-container">
        <input type="text" 
               class="vinted-item-messages-input" 
               placeholder="Tapez votre message..."
               maxlength="1000">
        <button class="vinted-item-messages-send" aria-label="Envoyer">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  `;
  
  // Gestionnaire d'envoi de message
  const input = container.querySelector('.vinted-item-messages-input');
  const sendBtn = container.querySelector('.vinted-item-messages-send');
  
  const handleSend = async () => {
    const messageText = input.value.trim();
    if (!messageText) return;
    
    input.disabled = true;
    sendBtn.disabled = true;
    sendBtn.style.opacity = '0.5';
    
    try {
      // Si on a une conversation, envoyer le message
      if (conversation && conversation.id) {
        await sendMessage(conversation.id, messageText);
        // Recharger la conversation
        const updatedConversation = await fetchConversation(conversation.id);
        renderConversation(container, updatedConversation, itemId, item);
      } else {
        // Essayer de trouver une conversation existante
        const inbox = await fetchInbox(1, 50);
        const conversations = inbox.conversations || [];
        const foundConversation = conversations.find(conv => {
          return conv.item?.id === parseInt(itemId) || 
                 conv.item?.id === itemId;
        });
        
        if (foundConversation) {
          // Charger et utiliser cette conversation
          const conversationDetails = await fetchConversation(foundConversation.id);
          await sendMessage(foundConversation.id, messageText);
          const updatedConversation = await fetchConversation(foundConversation.id);
          renderConversation(container, updatedConversation, itemId, item);
        } else {
          // Pas de conversation, essayer de créer une conversation
          try {
            // Récupérer les détails de l'item pour obtenir l'ID du vendeur
            let sellerId = null;
            if (!item || !item.user || !item.user.id) {
              const itemDetails = await fetchItemDetails(itemId, item?.slug || '');
              if (itemDetails && itemDetails.user && itemDetails.user.id) {
                sellerId = itemDetails.user.id;
              }
            } else {
              sellerId = item.user.id;
            }
            
            if (!sellerId) {
              throw new Error('Impossible de récupérer l\'ID du vendeur');
            }
            
            const newConversation = await createConversationForItem(itemId, sellerId, messageText, item);
            if (newConversation && newConversation.id) {
              // Recharger la conversation
              const updatedConversation = await fetchConversation(newConversation.id);
              renderConversation(container, updatedConversation, itemId, item);
              
              // Optionnel: ouvrir la conversation dans un nouvel onglet
              // window.open(`https://www.vinted.fr/inbox/${newConversation.id}`, '_blank');
            } else {
              // Si la création a échoué
              alert('Impossible de créer la conversation. Veuillez réessayer.');
            }
          } catch (createError) {
            console.error("[Vinted Item] Erreur lors de la création de la conversation:", createError);
            alert('Erreur lors de la création de la conversation. Veuillez réessayer.');
          }
        }
      }
      
      input.value = '';
      setTimeout(() => {
        const messagesList = container.querySelector('.vinted-item-messages-list');
        if (messagesList) {
          messagesList.scrollTop = messagesList.scrollHeight;
        }
      }, 100);
    } catch (error) {
      console.error("[Vinted Item] Erreur lors de l'envoi:", error);
      alert("Erreur lors de l'envoi du message. Veuillez réessayer.");
    } finally {
      input.disabled = false;
      sendBtn.disabled = false;
      sendBtn.style.opacity = '1';
      input.focus();
    }
  };
  
  sendBtn.addEventListener('click', handleSend);
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });
  
  // Faire défiler vers le bas
  setTimeout(() => {
    const messagesList = container.querySelector('.vinted-item-messages-list');
    if (messagesList) {
      messagesList.scrollTop = messagesList.scrollHeight;
    }
  }, 100);
}

/**
 * Rend une conversation vide avec la barre d'envoi
 * @param {HTMLElement} container - Conteneur de conversation
 * @param {string|number} userId - ID du vendeur
 * @param {string|number} itemId - ID du produit
 * @param {Object} item - Données du produit
 */
function renderEmptyConversation(container, userId, itemId, item) {
  container.innerHTML = `
    <div class="vinted-item-conversation-content">
      <div class="vinted-item-messages-list">
        <div class="vinted-item-no-messages">Aucun message. Commencez la conversation !</div>
      </div>
      <div class="vinted-item-messages-input-container">
        <input type="text" 
               class="vinted-item-messages-input" 
               placeholder="Tapez votre message..."
               maxlength="1000">
        <button class="vinted-item-messages-send" aria-label="Envoyer">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  `;
  
  const input = container.querySelector('.vinted-item-messages-input');
  const sendBtn = container.querySelector('.vinted-item-messages-send');
  
  const handleSend = async () => {
    const messageText = input.value.trim();
    if (!messageText) return;
    
    input.disabled = true;
    sendBtn.disabled = true;
    sendBtn.style.opacity = '0.5';
    
    try {
      // Créer une conversation en envoyant un message via l'API Vinted
      // On va utiliser l'URL de contact direct de Vinted
      const conversation = await createConversationForItem(itemId, userId, messageText, item);
      
      if (conversation && conversation.id) {
        // Recharger la conversation pour afficher le message
        const updatedConversation = await fetchConversation(conversation.id);
        renderConversation(container, updatedConversation, itemId, item);
      } else {
        throw new Error('Impossible de créer la conversation');
      }
    } catch (error) {
      console.error("[Vinted Item] Erreur lors de l'envoi:", error);
      alert("Erreur lors de l'envoi du message. Veuillez réessayer.");
    } finally {
      input.disabled = false;
      sendBtn.disabled = false;
      sendBtn.style.opacity = '1';
      input.focus();
    }
  };
  
  sendBtn.addEventListener('click', handleSend);
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });
}

/**
 * Achat rapide d'un article (même comportement que dans la liste des articles)
 * @param {string} itemUrl - URL de l'article
 */
function quickBuyItem(itemUrl) {
  // Ajouter le paramètre auto_buy=true à l'URL pour déclencher le script auto-buy
  const url = new URL(itemUrl);
  url.searchParams.set('auto_buy', 'true');
  
  // Ouvrir l'article dans un nouvel onglet
  const newTab = window.open(url.toString(), '_blank');
  
  if (newTab) {
    console.log('[Vinted Item Details] Ouverture de l\'article pour achat rapide:', url.toString());
  } else {
    console.error('[Vinted Item Details] Impossible d\'ouvrir l\'onglet. Popup bloquée ?');
  }
}

/**
 * Échappe le HTML pour éviter les XSS
 * @param {string} text - Texte à échapper
 * @returns {string} - Texte échappé
 */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Variable pour éviter les doubles clics
let isModalOpen = false;

/**
 * Ajoute un bouton "Faire une offre" sur les pages d'items Vinted
 */
function addOfferButtonToItemPage() {
  // Vérifier si on est sur une page d'item
  if (!window.location.pathname.match(/\/items\/\d+/)) return;
  
  // Chercher le bouton "Acheter" ou "Buy"
  const buyButton = document.querySelector('button[class*="buy"], button[class*="purchase"], a[class*="buy"], button:has-text("Acheter"), button:has-text("Buy")');
  
  // Alternative: chercher par texte
  const buttons = document.querySelectorAll('button, a[role="button"]');
  let buyBtn = null;
  for (const btn of buttons) {
    const text = btn.textContent?.toLowerCase() || '';
    if (text.includes('acheter') || text.includes('buy') || text.includes('purchase')) {
      buyBtn = btn;
      break;
    }
  }
  
  if (buyBtn && !document.querySelector('.vinted-offer-button-injected')) {
    // Créer le bouton "Faire une offre"
    const offerBtn = document.createElement('button');
    offerBtn.className = 'vinted-offer-button-injected';
    offerBtn.textContent = 'Faire une offre';
    offerBtn.style.cssText = `
      padding: 0.75rem 1.5rem;
      background: #09B1BA;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      margin-right: 0.75rem;
      transition: all 0.2s;
    `;
    
    offerBtn.addEventListener('mouseenter', () => {
      offerBtn.style.background = '#078a91';
      offerBtn.style.transform = 'translateY(-1px)';
    });
    
    offerBtn.addEventListener('mouseleave', () => {
      offerBtn.style.background = '#09B1BA';
      offerBtn.style.transform = 'translateY(0)';
    });
    
    // Extraire l'ID de l'item depuis l'URL
    const itemInfo = extractItemInfoFromUrl(window.location.href);
    if (itemInfo && itemInfo.id) {
      offerBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        await showItemDetails(itemInfo.id, itemInfo.slug);
      });
    }
    
    // Insérer avant le bouton "Acheter"
    buyBtn.parentNode.insertBefore(offerBtn, buyBtn);
  }
}

/**
 * Initialise l'interception des clics sur les produits
 */
function initItemClickInterceptor() {
  console.log('[Vinted Item Details] 🎯 Intercepteur de clics initialisé');
  // Intercepter les clics sur les liens de produits
  document.addEventListener('click', async (e) => {
    // Éviter les doubles clics
    if (isModalOpen) return;
    
    const link = e.target.closest('a[href*="/items/"]');
    if (!link) return;
    
    const url = link.href || link.getAttribute('href');
    if (!url || !url.includes('/items/')) return;
    
    const itemInfo = extractItemInfoFromUrl(url);
    if (!itemInfo || !itemInfo.id) return;
    
    console.log('[Vinted Item Details] 🖱️ Clic détecté sur un article:', itemInfo);
    
    // Empêcher la redirection
    e.preventDefault();
    e.stopPropagation();
    
    // Marquer comme ouvert
    isModalOpen = true;
    
    // Afficher les détails dans le modal
    console.log('[Vinted Item Details] 📋 Ouverture de la modal pour l\'article:', itemInfo.id);
    await showItemDetails(itemInfo.id, itemInfo.slug);
  }, true); // Utiliser capture pour intercepter avant que le lien ne soit suivi
  
  // Ajouter le bouton "Faire une offre" sur les pages d'items
  if (window.location.pathname.match(/\/items\/\d+/)) {
    // Attendre que la page soit chargée
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(addOfferButtonToItemPage, 1000);
      });
    } else {
      setTimeout(addOfferButtonToItemPage, 1000);
    }
    
    // Observer les changements de DOM pour réajouter le bouton si nécessaire
    const observer = new MutationObserver(() => {
      if (!document.querySelector('.vinted-offer-button-injected')) {
        addOfferButtonToItemPage();
      }
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  }
}

// ==========================================
// Gestion des items épinglés (utilise les favoris Vinted)
// ==========================================

// Cache pour les favoris
let cachedFavourites = null;
let favouritesCacheTime = 0;
const FAVOURITES_CACHE_DURATION = 60000; // 1 minute
let favouritesRefreshInterval = null;
const FAVOURITES_REFRESH_INTERVAL = 5000; // 5 secondes

/**
 * Récupère l'user_id depuis plusieurs sources
 * @returns {Promise<string|null>} - User ID
 */
async function getUserId() {
  // Méthode 1: Depuis les cookies
  const cookies = document.cookie.split(';');
  for (const cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'v_uid') {
      const userId = decodeURIComponent(value);
      if (userId) return userId;
    }
  }
  
  // Méthode 2: Depuis l'API inbox (comme dans content-bundled.js)
  try {
    const response = await fetch('https://www.vinted.fr/api/v2/inbox?page=1&per_page=20', {
      credentials: 'include',
      headers: {
        'accept': 'application/json, text/plain, */*',
        'accept-language': 'fr',
      }
    });

    if (response.ok) {
      const data = await response.json();
      if (data.conversations && data.conversations.length > 0) {
        // Essayer toutes les conversations jusqu'à trouver une avec des messages
        for (const conversation of data.conversations) {
          try {
            const convResponse = await fetch(`https://www.vinted.fr/api/v2/conversations/${conversation.id}`, {
              credentials: 'include',
              headers: {
                'accept': 'application/json, text/plain, */*',
                'accept-language': 'fr',
              }
            });
            
            if (convResponse.ok) {
              const convData = await convResponse.json();
              const fullConversation = convData.conversation || convData;
              if (fullConversation.messages && fullConversation.messages.length > 0) {
                const oppositeUserId = fullConversation.opposite_user?.id;
                for (const msg of fullConversation.messages) {
                  if (msg.entity_type === 'message' && msg.entity?.user_id && msg.entity.user_id !== oppositeUserId) {
                    return String(msg.entity.user_id);
                  }
                }
              }
            }
          } catch (convError) {
            // Continuer avec la conversation suivante
            continue;
          }
        }
      }
    }
  } catch (error) {
    // Ignorer silencieusement les erreurs
  }
  
  return null;
}

/**
 * Récupère le token CSRF depuis les cookies ou les meta tags
 * @returns {Promise<string|null>} - Token CSRF
 */
async function getCsrfToken() {
  // Chercher dans les scripts inline
  try {
    const scripts = document.querySelectorAll('script:not([src])');
    for (const script of scripts) {
      const scriptContent = script.textContent || script.innerHTML;
      if (scriptContent && scriptContent.includes('CSRF_TOKEN')) {
        const patterns = [
          /"CSRF_TOKEN"\s*:\s*"([a-f0-9-]{36,})"/i,
          /CSRF_TOKEN"\s*:\s*"([a-f0-9-]{36,})"/i,
          /CSRF_TOKEN[\\"]*:\s*[\\"]*([a-f0-9-]{36,})/i
        ];
        
        for (const pattern of patterns) {
          const match = scriptContent.match(pattern);
          if (match && match[1] && match[1].length > 20) {
            return match[1];
          }
        }
      }
    }
  } catch (e) {
    // Ignorer les erreurs
  }
  return null;
}

/**
 * Récupère l'anon_id depuis les cookies
 * @returns {string|null} - Anon ID
 */
function getAnonId() {
  const cookies = document.cookie.split(';');
  for (const cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'anon_id') {
      return decodeURIComponent(value);
    }
  }
  return null;
}

/**
 * Récupère les favoris depuis l'API Vinted
 * @returns {Promise<Array>} - Liste des favoris
 */
async function getFavouritesFromAPI() {
  const userId = await getUserId();
  if (!userId) {
    // Ne pas logger d'erreur si l'utilisateur n'est simplement pas connecté
    // C'est un cas normal, pas une erreur
    return [];
  }

  // Utiliser le cache si disponible et récent
  const now = Date.now();
  if (cachedFavourites && (now - favouritesCacheTime) < FAVOURITES_CACHE_DURATION) {
    return cachedFavourites;
  }

  try {
    const url = `https://www.vinted.fr/api/v2/users/${userId}/items/favourites`;
    const response = await fetch(url, {
      method: 'GET',
      credentials: 'include',
      headers: {
        'accept': 'application/json, text/plain, */*',
        'x-anon-id': getAnonId() || '',
      }
    });

    if (!response.ok) {
      throw new Error(`Erreur API: ${response.status}`);
    }

    const data = await response.json();
    const favourites = data.items || [];
    
    // Mettre en cache
    cachedFavourites = favourites;
    favouritesCacheTime = now;
    
    return favourites;
  } catch (error) {
    console.error("[Vinted Favourites] Erreur lors de la récupération des favoris:", error);
    // Retourner le cache si disponible en cas d'erreur
    return cachedFavourites || [];
  }
}

/**
 * Récupère les items épinglés (favoris) depuis l'API
 * @returns {Promise<Array>} - Liste des items épinglés
 */
async function getPinnedItems() {
  const favourites = await getFavouritesFromAPI();
  return favourites.map(item => ({
    id: String(item.id),
    title: item.title,
    price: item.price?.amount || '',
    currency: item.price?.currency_code || 'EUR',
    photo: item.photo?.url || '',
    url: item.url || `https://www.vinted.fr/items/${item.id}`,
    slug: item.url ? item.url.split('/').pop().replace(/^\d+-/, '') : '',
    is_closed: item.is_closed || false,
    is_reserved: item.is_reserved || false
  }));
}

/**
 * Vérifie si un item est épinglé (dans les favoris)
 * @param {string|number} itemId - ID de l'item
 * @returns {Promise<boolean>}
 */
async function isItemPinned(itemId) {
  const favourites = await getFavouritesFromAPI();
  return favourites.some(item => String(item.id) === String(itemId));
}

/**
 * Ajoute un item aux favoris Vinted
 * @param {string|number} itemId - ID de l'item
 * @param {string} itemPath - Chemin de l'item (ex: /items/7580796632-camiseta-nino-carhartt)
 * @returns {Promise<boolean>} - Succès
 */
async function addToFavourites(itemId, itemPath) {
  try {
    let csrfToken = await getCsrfToken();
    
    // Si le token n'est pas trouvé, essayer d'importer la fonction depuis messagesApi.js
    if (!csrfToken) {
      try {
        const { getCsrfToken: getCsrfTokenFromApi, tryGetCsrfTokenFromPage } = await import('./messagesApi.js');
        csrfToken = await getCsrfTokenFromApi();
        if (!csrfToken) {
          csrfToken = await tryGetCsrfTokenFromPage();
        }
        if (csrfToken) {
          console.log("[Vinted Favourites] Token CSRF récupéré depuis messagesApi");
        }
      } catch (importError) {
        console.warn("[Vinted Favourites] Impossible d'importer depuis messagesApi:", importError);
      }
    }

    if (!csrfToken) {
      console.error("[Vinted Favourites] Token CSRF non trouvé");
      return false;
    }

    const anonId = getAnonId();
    const itemIdNum = parseInt(itemId);

    // Utiliser l'API toggle de Vinted
    const url = 'https://www.vinted.fr/api/v2/user_favourites/toggle';
    const payload = {
      type: "item",
      user_favourites: [itemIdNum]
    };

    console.log(`[Vinted Favourites] Envoi de la requête toggle pour l'item ${itemIdNum}`, payload);

    const headers = {
      'content-type': 'application/json',
      'x-csrf-token': csrfToken,
    };
    
    if (anonId) {
      headers['x-anon-id'] = anonId;
    }

    const response = await fetch(url, {
      method: 'POST',
      credentials: 'include',
      headers: headers,
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error(`[Vinted Favourites] Erreur API ${response.status}:`, errorText);
      throw new Error(`Erreur API: ${response.status} - ${errorText}`);
    }

    const responseData = await response.json();
    console.log(`[Vinted Favourites] Réponse de l'API:`, responseData);

    // Invalider le cache
    cachedFavourites = null;
    favouritesCacheTime = 0;

    return true;
  } catch (error) {
    console.error("[Vinted Favourites] Erreur lors de l'ajout aux favoris:", error);
    return false;
  }
}

/**
 * Retire un item des favoris Vinted (en cliquant à nouveau sur le bouton favori)
 * @param {string|number} itemId - ID de l'item
 * @param {string} itemPath - Chemin de l'item
 * @returns {Promise<boolean>} - Succès
 */
async function removeFromFavourites(itemId, itemPath) {
  // Pour retirer, on fait la même requête (toggle)
  return await addToFavourites(itemId, itemPath);
}

/**
 * Épingle ou désépingle un item (toggle favori)
 * @param {Object} item - Données de l'item
 */
async function togglePinItem(item) {
  const itemId = String(item.id);
  // Construire le path correctement : /items/{id}-{slug}
  let itemPath = `/items/${itemId}`;
  if (item.slug) {
    itemPath += `-${item.slug}`;
  } else if (item.url) {
    try {
      const url = new URL(item.url);
      itemPath = url.pathname;
    } catch (e) {
      // Si l'URL est invalide, utiliser le format par défaut
    }
  }
  
  const isCurrentlyPinned = await isItemPinned(itemId);
  
  // L'API Vinted utilise un toggle, donc on envoie toujours la même requête
  // qui va basculer l'état actuel
  await addToFavourites(itemId, itemPath);
  
  // Attendre un peu pour que l'API se synchronise
  await new Promise(resolve => setTimeout(resolve, 300));
  
  // Invalider le cache et recharger
  cachedFavourites = null;
  favouritesCacheTime = 0;
  await checkAndRenderPinnedItemsBar();
  
  // Mettre à jour tous les boutons favoris sur la page pour cet item
  updateFavoriteButtonsOnPage(itemId);
}

/**
 * Met à jour tous les boutons favoris sur la page pour un item donné
 * @param {string} itemId - ID de l'item
 */
async function updateFavoriteButtonsOnPage(itemId) {
  if (!itemId) return;
  
  // Vérifier l'état réel depuis l'API
  const isPinned = await isItemPinned(itemId);
  
  // Trouver tous les boutons favoris pour cet item
  const favoriteButtons = document.querySelectorAll(`.btn-favorite-item[data-item-id="${itemId}"]`);
  
  favoriteButtons.forEach(btn => {
    if (isPinned) {
      btn.classList.add('favorited');
      btn.title = 'Retirer des favoris';
      const icon = btn.querySelector('.favorite-icon');
      if (icon) icon.textContent = '❤️';
    } else {
      btn.classList.remove('favorited');
      btn.title = 'Ajouter aux favoris';
      const icon = btn.querySelector('.favorite-icon');
      if (icon) icon.textContent = '🤍';
    }
  });
}

/**
 * Supprime un item épinglé (retire des favoris)
 * @param {string|number} itemId - ID de l'item
 */
async function unpinItem(itemId) {
  console.log(`[Vinted Favourites] Suppression de l'item ${itemId} des favoris...`);
  
  const favourites = await getFavouritesFromAPI();
  const item = favourites.find(f => String(f.id) === String(itemId));
  
  if (!item) {
    console.warn(`[Vinted Favourites] Item ${itemId} non trouvé dans les favoris`);
    // Essayer quand même de le retirer (peut-être que le cache est obsolète)
  }
  
  let itemPath = `/items/${itemId}`;
  if (item && item.url) {
    try {
      const url = new URL(item.url);
      itemPath = url.pathname;
    } catch (e) {
      // Si l'URL est invalide, utiliser le format par défaut
    }
  }
  
  // Utiliser l'API toggle pour retirer l'item
  const success = await removeFromFavourites(itemId, itemPath);
  
  if (!success) {
    console.error(`[Vinted Favourites] Échec de la suppression de l'item ${itemId}`);
    throw new Error('Échec de la suppression des favoris');
  }
  
  // Attendre un peu pour que l'API se synchronise
  await new Promise(resolve => setTimeout(resolve, 300));
  
  // Invalider le cache et recharger
  cachedFavourites = null;
  favouritesCacheTime = 0;
  await checkAndRenderPinnedItemsBar();
  
  console.log(`[Vinted Favourites] Item ${itemId} retiré des favoris avec succès`);
}

/**
 * Rend la barre des items épinglés (favoris)
 * Uniquement sur la page /catalog
 */
async function renderPinnedItemsBar() {
  // Vérifier si on est sur la page catalog
  const isCatalogPage = window.location.pathname === '/catalog' || window.location.pathname.startsWith('/catalog');
  if (!isCatalogPage) {
    // Supprimer la barre si elle existe sur d'autres pages
    const existingBar = document.getElementById('vinted-pinned-items-bar');
    if (existingBar) {
      existingBar.remove();
    }
    return;
  }
  
  const pinned = await getPinnedItems();
  
  // Supprimer l'ancienne barre si elle existe
  const existingBar = document.getElementById('vinted-pinned-items-bar');
  if (existingBar) {
    existingBar.remove();
  }
  
  if (pinned.length === 0) return;
  
  // Créer la barre
  const bar = document.createElement('div');
  bar.id = 'vinted-pinned-items-bar';
  bar.className = 'vinted-pinned-items-bar';
  bar.innerHTML = `
    <div class="vinted-pinned-items-container">
      ${pinned.map(item => {
        // Déterminer le statut : vendu (rouge) ou disponible (vert)
        const isAvailable = !item.is_closed && !item.is_reserved;
        const statusClass = isAvailable ? 'status-available' : 'status-sold';
        const statusTitle = isAvailable ? 'Disponible' : 'Vendu';
        
        return `
        <div class="vinted-pinned-item" data-item-id="${item.id}">
          <img src="${item.photo || ''}" alt="${escapeHtml(item.title)}" class="vinted-pinned-item-photo">
          <div class="vinted-pinned-item-status ${statusClass}" title="${statusTitle}"></div>
          <button class="vinted-pinned-item-unpin" data-item-id="${item.id}" title="Retirer des favoris">×</button>
        </div>
      `;
      }).join('')}
    </div>
  `;
  
  // Insérer après la navbar de Vinted
  const header = document.querySelector('header, .l-header, [class*="header"]');
  if (header) {
    header.insertAdjacentElement('afterend', bar);
  } else {
    document.body.insertBefore(bar, document.body.firstChild);
  }
  
  // Gestionnaires d'événements
  bar.querySelectorAll('.vinted-pinned-item').forEach(itemEl => {
    itemEl.addEventListener('click', async (e) => {
      if (e.target.classList.contains('vinted-pinned-item-unpin')) return;
      const itemId = itemEl.dataset.itemId;
      const item = pinned.find(p => String(p.id) === itemId);
      if (item) {
        await showItemDetails(itemId, item.slug);
      }
    });
  });
  
  bar.querySelectorAll('.vinted-pinned-item-unpin').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      e.preventDefault();
      
      const itemId = btn.dataset.itemId;
      const itemElement = btn.closest('.vinted-pinned-item');
      
      if (!itemElement) return;
      
      // Afficher un indicateur de chargement
      const originalContent = btn.textContent;
      btn.textContent = '⏳';
      btn.disabled = true;
      btn.style.opacity = '0.6';
      btn.style.cursor = 'wait';
      itemElement.style.opacity = '0.6';
      
      try {
        await unpinItem(itemId);
        // L'élément sera supprimé automatiquement par renderPinnedItemsBar
      } catch (error) {
        console.error("[Vinted Favourites] Erreur lors de la suppression:", error);
        // En cas d'erreur, restaurer l'état
        btn.textContent = originalContent;
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        itemElement.style.opacity = '1';
      }
    });
  });
}

// Initialiser quand le DOM est prêt
// Exposer showItemDetails globalement pour qu'elle soit accessible depuis content-bundled.js
if (typeof window !== 'undefined') {
  window.showItemDetails = showItemDetails;
  window.initItemClickInterceptor = initItemClickInterceptor;
  window.addToFavourites = addToFavourites;
  window.isItemPinned = isItemPinned;
  window.togglePinItem = togglePinItem;
  window.updateFavoriteButtonsOnPage = updateFavoriteButtonsOnPage;
}

// Fonction pour vérifier et afficher/masquer la barre selon l'URL
async function checkAndRenderPinnedItemsBar() {
  const isCatalogPage = window.location.pathname === '/catalog' || window.location.pathname.startsWith('/catalog');
  if (isCatalogPage) {
    await renderPinnedItemsBar();
  } else {
    // Supprimer la barre si on n'est pas sur catalog
    const existingBar = document.getElementById('vinted-pinned-items-bar');
    if (existingBar) {
      existingBar.remove();
    }
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', async () => {
    initItemClickInterceptor();
    await checkAndRenderPinnedItemsBar();
  });
} else {
  initItemClickInterceptor();
  (async () => {
    await checkAndRenderPinnedItemsBar();
  })();
}

// Écouter les changements d'URL (pour les SPA comme Vinted)
let lastUrl = window.location.href;
new MutationObserver(() => {
  const currentUrl = window.location.href;
  if (currentUrl !== lastUrl) {
    lastUrl = currentUrl;
    checkAndRenderPinnedItemsBar();
  }
}).observe(document.body, { childList: true, subtree: true });

// Écouter aussi les événements popstate (navigation navigateur)
window.addEventListener('popstate', () => {
  checkAndRenderPinnedItemsBar();
});

/**
 * Démarre le rafraîchissement automatique des favoris toutes les 5 secondes
 */
function startFavouritesAutoRefresh() {
  // Arrêter l'intervalle existant s'il y en a un
  stopFavouritesAutoRefresh();
  
  // Rafraîchir immédiatement
  checkAndRenderPinnedItemsBar();
  
  // Puis rafraîchir toutes les 5 secondes
  favouritesRefreshInterval = setInterval(() => {
    // Invalider le cache pour forcer une nouvelle requête
    cachedFavourites = null;
    favouritesCacheTime = 0;
    checkAndRenderPinnedItemsBar();
  }, FAVOURITES_REFRESH_INTERVAL);
  
  console.log("[Vinted Favourites] ✅ Rafraîchissement automatique activé (toutes les 5 secondes)");
}

/**
 * Arrête le rafraîchissement automatique des favoris
 */
function stopFavouritesAutoRefresh() {
  if (favouritesRefreshInterval) {
    clearInterval(favouritesRefreshInterval);
    favouritesRefreshInterval = null;
  }
}

// Démarrer le rafraîchissement automatique au chargement
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    startFavouritesAutoRefresh();
  });
} else {
  startFavouritesAutoRefresh();
}

// Gérer le style de la barre lors du scroll (fond sombre et padding)
let lastScrollTop = 0;
window.addEventListener('scroll', () => {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  const bar = document.getElementById('vinted-pinned-items-bar');
  
  if (bar) {
    // Ajouter la classe 'scrolled' si on a scrollé plus de 50px
    if (scrollTop > 50) {
      bar.classList.add('scrolled');
      // Forcer le fond bleu marine avec style inline pour s'assurer qu'il s'applique
      bar.style.background = '#0f172a';
      bar.style.backgroundColor = '#0f172a';
    } else {
      bar.classList.remove('scrolled');
      // Remettre transparent quand on revient en haut
      bar.style.background = 'transparent';
      bar.style.backgroundColor = 'transparent';
    }
    
    // Réafficher la barre si nécessaire
    if (Math.abs(scrollTop - lastScrollTop) > 50) {
      bar.style.display = 'block';
    }
  }
  
  lastScrollTop = scrollTop;
});


  
  // ==========================================
  // Initialization
  // ==========================================
  
  // Point d'entrée pour le système de notifications de messages
// Ce fichier est chargé sur toutes les pages Vinted


// Fonction pour vérifier si on est sur une vraie page Vinted (pas une iframe ou autre)
function isMainVintedPage() {
  return window.top === window.self && window.location.hostname === 'www.vinted.fr';
}

// Fonction d'initialisation
function initMessageNotifications() {
  // Vérifier qu'on est sur la page principale
  if (!isMainVintedPage()) {
    console.log("[Vinted Messages] Pas sur la page principale, notifications désactivées");
    return;
  }

  // Vérifier que le système n'est pas déjà initialisé
  if (window.__VINTED_MESSAGE_NOTIFIER_INITIALIZED__) {
    console.log("[Vinted Messages] Système déjà initialisé");
    return;
  }

  // Marquer comme initialisé
  window.__VINTED_MESSAGE_NOTIFIER_INITIALIZED__ = true;

  // Attendre que la page soit prête
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      startSystem();
    });
  } else {
    startSystem();
  }
}

function startSystem() {
  try {
    console.log("[Vinted Messages] 🔔 Système de notifications désactivé");
    
    // Ne plus démarrer les notifications - elles sont désactivées
    // startMessageNotifications(10000);
    
    // Initialiser l'interception des clics sur les produits
    if (typeof initItemClickInterceptor === 'function') {
      initItemClickInterceptor();
      console.log("[Vinted Item] ✅ Interception des clics sur les produits activée");
    }
    
    console.log("[Vinted Messages] ✅ Système démarré (notifications désactivées)");
  } catch (error) {
    console.error("[Vinted Messages] ❌ Erreur lors du démarrage:", error);
  }
}

// Démarrer l'initialisation
initMessageNotifications();


  
})();
