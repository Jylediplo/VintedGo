
// ==========================================
// VINTED MESSAGE NOTIFIER - BUNDLED VERSION
// Auto-generated by build-messages-notifier.js
// ==========================================

(function() {
  'use strict';
  
  // ==========================================
  // messagesApi.js
  // ==========================================
  
  // Gestion de l'API des messages Vinted

/**
 * Récupère les messages depuis l'API Vinted
 * @param {number} page - Numéro de page
 * @param {number} perPage - Nombre de messages par page
 * @returns {Promise<Object>} - Données des conversations
 */
async function fetchInbox(page = 1, perPage = 20) {
  const url = `https://www.vinted.fr/api/v2/inbox?page=${page}&per_page=${perPage}`;
  
  try {
    const response = await fetch(url, {
      credentials: "include",
      headers: {
        "accept": "application/json, text/plain, */*",
        "accept-language": "fr",
        "sec-fetch-dest": "empty",
        "sec-fetch-mode": "cors",
        "sec-fetch-site": "same-origin",
      },
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    return data;
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de la récupération des messages:", error);
    throw error;
  }
}

/**
 * Filtre les conversations non lues
 * @param {Array} conversations - Liste des conversations
 * @returns {Array} - Conversations non lues
 */
function getUnreadConversations(conversations) {
  return conversations.filter(conv => conv.unread === true);
}

/**
 * Extrait les informations essentielles d'une conversation
 * @param {Object} conversation - Objet conversation
 * @returns {Object} - Informations formatées
 */
function formatConversationInfo(conversation) {
  return {
    id: conversation.id,
    description: conversation.description,
    unread: conversation.unread,
    updated_at: conversation.updated_at,
    opposite_user: {
      id: conversation.opposite_user.id,
      login: conversation.opposite_user.login,
      photo_url: conversation.opposite_user.photo?.thumbnails?.find(t => t.type === "thumb100")?.url || 
                 conversation.opposite_user.photo?.url
    },
    item_photo: conversation.item_photos?.[0]?.thumbnails?.find(t => t.type === "thumb70x100")?.url || 
                conversation.item_photos?.[0]?.url,
    conversation_url: `https://www.vinted.fr/inbox/${conversation.id}`
  };
}

/**
 * Récupère une conversation spécifique depuis l'API Vinted
 * @param {string|number} conversationId - ID de la conversation
 * @returns {Promise<Object>} - Données de la conversation
 */
async function fetchConversation(conversationId) {
  const url = `https://www.vinted.fr/api/v2/conversations/${conversationId}`;
  
  try {
    const response = await fetch(url, {
      credentials: "include",
      headers: {
        "accept": "application/json, text/plain, */*",
        "accept-language": "fr",
        "sec-fetch-dest": "empty",
        "sec-fetch-mode": "cors",
        "sec-fetch-site": "same-origin",
      },
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    return data.conversation;
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de la récupération de la conversation:", error);
    throw error;
  }
}

// Variable globale pour stocker le token CSRF intercepté
let cachedCsrfToken = null;

/**
 * Intercepte les requêtes fetch pour récupérer le token CSRF
 */
function interceptFetchForCsrfToken() {
  if (window._vintedCsrfIntercepted) return;
  window._vintedCsrfIntercepted = true;
  
  const originalFetch = window.fetch;
  window.fetch = function(...args) {
    const [url, options = {}] = args;
    
    // Si c'est une requête vers l'API Vinted avec un header x-csrf-token
    if (typeof url === 'string' && url.includes('vinted.fr/api') && options.headers) {
      // Vérifier différents formats de headers
      let csrfToken = null;
      
      if (options.headers instanceof Headers) {
        csrfToken = options.headers.get('x-csrf-token') || options.headers.get('X-CSRF-Token');
      } else if (typeof options.headers === 'object') {
        csrfToken = options.headers['x-csrf-token'] || 
                   options.headers['X-CSRF-Token'] ||
                   options.headers['X-Csrf-Token'];
      }
      
      if (csrfToken) {
        cachedCsrfToken = csrfToken;
      }
    }
    
    // Intercepter aussi les réponses de scripts JavaScript pour chercher CSRF_TOKEN
    if (typeof url === 'string' && (url.includes('.js') || url.includes('chunks'))) {
      const promise = originalFetch.apply(this, args);
      promise.then(async response => {
        if (response.ok) {
          try {
            const text = await response.clone().text();
            // Chercher CSRF_TOKEN dans le contenu du script
            const patterns = [
              /CSRF_TOKEN["\s:=]+["']([a-f0-9-]{36,})["']/i,
              /csrf[_-]?token["\s:=]+["']([a-f0-9-]{36,})["']/i
            ];
            
            for (const pattern of patterns) {
              const match = text.match(pattern);
              if (match && match[1] && match[1].length > 20 && !cachedCsrfToken) {
                cachedCsrfToken = match[1];
                break;
              }
            }
          } catch (e) {
            // Ignorer les erreurs de lecture
          }
        }
      }).catch(() => {});
      return promise;
    }
    
    return originalFetch.apply(this, args);
  };
  
  // Intercepter aussi XMLHttpRequest
  if (window.XMLHttpRequest) {
    const originalOpen = XMLHttpRequest.prototype.open;
    const originalSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;
    
    XMLHttpRequest.prototype.setRequestHeader = function(header, value) {
      if (header.toLowerCase() === 'x-csrf-token' && value) {
        cachedCsrfToken = value;
      }
      return originalSetRequestHeader.apply(this, arguments);
    };
  }
}

/**
 * Récupère le token CSRF depuis les cookies ou les meta tags
 * @returns {Promise<string|null>} - Token CSRF
 */
async function getCsrfToken() {
  // Méthode 1: Depuis le cache (intercepté depuis une requête)
  if (cachedCsrfToken) {
    return cachedCsrfToken;
  }
  
  // Méthode 2: Extraire le token CSRF depuis les scripts inline de la page
  // Le token est dans un script avec pattern: "CSRF_TOKEN":"[token]" dans __next_f.push
  try {
    const scripts = document.querySelectorAll('script:not([src])');
    for (const script of scripts) {
      const scriptContent = script.textContent || script.innerHTML;
      if (scriptContent && scriptContent.includes('CSRF_TOKEN')) {
        // Pattern principal: "CSRF_TOKEN":"[token]" ou CSRF_TOKEN":"[token]" (avec/sans guillemets)
        const patterns = [
          /"CSRF_TOKEN"\s*:\s*"([a-f0-9-]{36,})"/i,
          /CSRF_TOKEN"\s*:\s*"([a-f0-9-]{36,})"/i,
          /CSRF_TOKEN[\\"]*:\s*[\\"]*([a-f0-9-]{36,})/i
        ];
        
        for (const pattern of patterns) {
          const match = scriptContent.match(pattern);
          if (match && match[1] && match[1].length > 20) {
            cachedCsrfToken = match[1];
            return match[1];
          }
        }
      }
    }
    
    // Fallback: Chercher dans le HTML complet
    const htmlContent = document.documentElement.outerHTML || document.body.innerHTML;
    if (htmlContent.includes('CSRF_TOKEN')) {
      const htmlMatch = htmlContent.match(/"CSRF_TOKEN"\s*:\s*"([a-f0-9-]{36,})"/i);
      if (htmlMatch && htmlMatch[1] && htmlMatch[1].length > 20) {
        cachedCsrfToken = htmlMatch[1];
        return htmlMatch[1];
      }
    }
  } catch (e) {
    // Ignorer les erreurs
  }
  
  // Méthode 3: Depuis window.__NEXT_DATA__?.env (fallback)
  if (window.__NEXT_DATA__?.env?.CSRF_TOKEN) {
    const token = window.__NEXT_DATA__.env.CSRF_TOKEN;
    if (token && typeof token === 'string' && token.length > 20) {
      cachedCsrfToken = token;
      return token;
    }
  }
  
  return null;
}

// Initialiser l'interception au chargement
if (typeof window !== 'undefined') {
  interceptFetchForCsrfToken();
}

/**
 * Récupère l'anon_id depuis les cookies
 * @returns {string|null} - Anon ID
 */
function getAnonId() {
  const cookies = document.cookie.split(';');
  for (const cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'anon_id') {
      return decodeURIComponent(value);
    }
  }
  return null;
}

/**
 * Envoie un message dans une conversation
 * @param {string|number} conversationId - ID de la conversation
 * @param {string} messageBody - Corps du message
 * @returns {Promise<Object>} - Réponse de l'API
 */
async function sendMessage(conversationId, messageBody) {
  console.log("[Vinted Messages] sendMessage appelé avec conversationId:", conversationId, "messageBody:", messageBody?.substring(0, 50));
  
  const url = `https://www.vinted.fr/api/v2/conversations/${conversationId}/replies`;
  console.log("[Vinted Messages] URL de la requête:", url);
  
  // Récupérer le token CSRF et l'anon_id
  console.log("[Vinted Messages] Récupération du token CSRF...");
  let csrfToken = await getCsrfToken();
  console.log("[Vinted Messages] Token CSRF récupéré:", csrfToken ? csrfToken.substring(0, 8) + '...' : 'null');
  
  const anonId = getAnonId();
  console.log("[Vinted Messages] Anon ID:", anonId || 'non trouvé');
  
  // Si pas de token, essayer de le récupérer depuis la page inbox
  if (!csrfToken) {
    console.warn("[Vinted Messages] Token CSRF non trouvé, tentative de récupération depuis la page...");
    csrfToken = await tryGetCsrfTokenFromPage();
    if (csrfToken) {
      cachedCsrfToken = csrfToken;
      console.log("[Vinted Messages] Token CSRF récupéré depuis la page");
    }
  }
  
  if (!csrfToken) {
    const error = "Impossible de récupérer le token CSRF. Veuillez recharger la page et réessayer.";
    console.error("[Vinted Messages]", error);
    throw new Error(error);
  }
  
  console.log("[Vinted Messages] Envoi du message avec token CSRF:", csrfToken.substring(0, 8) + '...');
  
  const payload = {
    reply: {
      body: messageBody,
      photo_temp_uuids: null,
      is_personal_data_sharing_check_skipped: false
    }
  };
  
  try {
    // Récupérer le cookie DataDome si disponible
    const getCookie = (name) => {
      const cookies = document.cookie.split(';');
      for (const cookie of cookies) {
        const [cookieName, value] = cookie.trim().split('=');
        if (cookieName === name) {
          return decodeURIComponent(value);
        }
      }
      return null;
    };
    
    const headers = {
      "content-type": "application/json",
      "x-csrf-token": csrfToken,
    };
    
    // Ajouter l'anon_id si disponible (optionnel mais peut aider)
    if (anonId) {
      headers["x-anon-id"] = anonId;
    }
    
    // S'assurer que les cookies (y compris DataDome) sont inclus
    const fetchOptions = {
      method: "POST",
      credentials: "include", // Inclut automatiquement les cookies (y compris DataDome)
      headers: headers,
      body: JSON.stringify(payload),
      mode: "cors",
      cache: "no-cache",
    };
    
    const response = await fetch(url, fetchOptions);

    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch {
        const errorText = await response.text();
        errorData = { message: errorText };
      }
      console.error("[Vinted Messages] Erreur API:", errorData);
      
      // Si c'est une erreur d'accès refusé, essayer de récupérer le token depuis la page
      if (errorData.code === 106 || response.status === 403) {
        console.warn("[Vinted Messages] Accès refusé, tentative de récupération du token CSRF depuis la page");
        
        // Recharger la page pour récupérer le token (ou essayer une autre méthode)
        const newCsrfToken = await tryGetCsrfTokenFromPage();
        if (newCsrfToken && newCsrfToken !== csrfToken) {
          headers["x-csrf-token"] = newCsrfToken;
          // Réessayer avec le nouveau token
          const retryResponse = await fetch(url, {
            method: "POST",
            credentials: "include",
            headers: headers,
            body: JSON.stringify(payload),
          });
          
          if (!retryResponse.ok) {
            let retryError;
            try {
              retryError = await retryResponse.json();
            } catch {
              const retryErrorText = await retryResponse.text();
              retryError = { message: retryErrorText };
            }
            throw new Error(`HTTP ${retryResponse.status}: ${JSON.stringify(retryError)}`);
          }
          
          return await retryResponse.json();
        }
      }
      
      throw new Error(`HTTP ${response.status}: ${JSON.stringify(errorData)}`);
    }

    const data = await response.json();
    return data;
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de l'envoi du message:", error);
    throw error;
  }
}

/**
 * Essaie de récupérer le token CSRF depuis la page en faisant une requête
 */
async function tryGetCsrfTokenFromPage() {
  try {
    // Essayer de récupérer depuis la page inbox
    const inboxResponse = await fetch('https://www.vinted.fr/inbox', {
      credentials: "include",
      headers: {
        "accept": "text/html,application/xhtml+xml",
      },
    });
    
    if (inboxResponse.ok) {
      const html = await inboxResponse.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // Chercher dans les meta tags (tous les variants)
      const metaSelectors = [
        'meta[name="csrf-token"]',
        'meta[name="csrf_token"]',
        'meta[name="CSRF-Token"]',
        'meta[property="csrf-token"]'
      ];
      
      for (const selector of metaSelectors) {
        const metaTag = doc.querySelector(selector);
        if (metaTag) {
          const token = metaTag.getAttribute('content');
          if (token && token.length > 20) {
            return token;
          }
        }
      }
      
      // Chercher dans les attributs data
      const dataTag = doc.querySelector('[data-csrf-token], body[data-csrf-token], html[data-csrf-token]');
      if (dataTag) {
        const token = dataTag.getAttribute('data-csrf-token') || 
                     dataTag.getAttribute('data-csrf_token') ||
                     dataTag.getAttribute('data-csrf');
        if (token && token.length > 20) {
          return token;
        }
      }
      
      // Chercher dans le HTML avec des patterns améliorés
      const patterns = [
        /csrf[_-]?token["\s:=]+["']?([a-f0-9-]{36,})["']?/i,
        /["']x-csrf-token["']\s*:\s*["']([a-f0-9-]{36,})["']/i,
        /x-csrf-token["\s:=]+["']?([a-f0-9-]{36,})["']?/i,
        /csrfToken["\s:=]+["']?([a-f0-9-]{36,})["']?/i,
        /csrf_token["\s:=]+["']?([a-f0-9-]{36,})["']?/i
      ];
      
      for (const pattern of patterns) {
        const match = html.match(pattern);
        if (match && match[1] && match[1].length > 20) {
          return match[1];
        }
      }
    }
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de la récupération du token:", error);
  }
  
  return null;
}

/**
 * Envoie une demande d'offre pour une transaction
 * @param {string|number} transactionId - ID de la transaction
 * @param {string} price - Prix de l'offre
 * @param {string} currency - Devise (par défaut: EUR)
 * @returns {Promise<Object>} - Réponse de l'API
 */
async function sendOfferRequest(transactionId, price, currency = "EUR") {
  const url = `https://www.vinted.fr/api/v2/transactions/${transactionId}/offer_requests`;
  
  let csrfToken = await getCsrfToken();
  const anonId = getAnonId();
  
  if (!csrfToken) {
    csrfToken = await tryGetCsrfTokenFromPage();
    if (csrfToken) {
      cachedCsrfToken = csrfToken;
    }
  }
  
  if (!csrfToken) {
    throw new Error("Impossible de récupérer le token CSRF. Veuillez recharger la page et réessayer.");
  }
  
  const payload = {
    offer_request: {
      price: price.toString(),
      currency: currency
    }
  };
  
  const headers = {
    "content-type": "application/json",
    "x-csrf-token": csrfToken,
  };
  
  if (anonId) {
    headers["x-anon-id"] = anonId;
  }
  
  const fetchOptions = {
    method: "POST",
    credentials: "include",
    headers: headers,
    body: JSON.stringify(payload),
    mode: "cors",
    cache: "no-cache",
  };
  
  try {
    const response = await fetch(url, fetchOptions);
    
    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch (e) {
        errorData = { message: await response.text() };
      }
      
      if (response.status === 403 || (errorData.code === 106)) {
        cachedCsrfToken = null;
        const newToken = await tryGetCsrfTokenFromPage();
        if (newToken) {
          cachedCsrfToken = newToken;
          headers["x-csrf-token"] = newToken;
          const retryResponse = await fetch(url, fetchOptions);
          if (!retryResponse.ok) {
            throw new Error(`HTTP ${retryResponse.status}: ${JSON.stringify(await retryResponse.json())}`);
          }
          return await retryResponse.json();
        }
      }
      
      throw new Error(`HTTP ${response.status}: ${JSON.stringify(errorData)}`);
    }
    
    const data = await response.json();
    return data;
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de l'envoi de l'offre:", error);
    throw error;
  }
}

/**
 * Récupère les détails d'un produit depuis la page Vinted
 * @param {string|number} itemId - ID du produit
 * @param {string} itemSlug - Nom/slug du produit (optionnel)
 * @returns {Promise<Object>} - Données du produit
 */
async function fetchItemDetails(itemId, itemSlug = '') {
  // Construire l'URL de la page avec l'ID et le slug si disponible
  const url = itemSlug 
    ? `https://www.vinted.fr/items/${itemId}-${itemSlug}`
    : `https://www.vinted.fr/items/${itemId}`;
  
  try {
    const response = await fetch(url, {
      credentials: "include",
      headers: {
        "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "accept-language": "fr",
        "sec-fetch-dest": "document",
        "sec-fetch-mode": "navigate",
        "sec-fetch-site": "same-origin",
      },
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const html = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // Extraire les données depuis __NEXT_DATA__ ou depuis le HTML
    let itemData = null;
    
    // Méthode 1: Chercher dans __NEXT_DATA__
    const scripts = doc.querySelectorAll('script');
    for (const script of scripts) {
      const content = script.textContent || script.innerHTML;
      if (content.includes('__NEXT_DATA__') || content.includes('"item"')) {
        try {
          // Essayer d'extraire les données JSON
          const match = content.match(/__NEXT_DATA__\s*=\s*({.+?});/s);
          if (match) {
            const nextData = JSON.parse(match[1]);
            if (nextData?.props?.pageProps?.item) {
              itemData = nextData.props.pageProps.item;
              break;
            }
          }
          
          // Alternative: chercher directement "item" dans le JSON
          const itemMatch = content.match(/"item"\s*:\s*({.+?})(?=,"|$)/s);
          if (itemMatch) {
            itemData = JSON.parse(itemMatch[1]);
            break;
          }
        } catch (e) {
          // Continuer avec la méthode suivante
        }
      }
    }
    
    // Méthode 2: Si pas trouvé, essayer de parser le HTML directement
    if (!itemData) {
      // Extraire les informations de base depuis le HTML
      const title = doc.querySelector('h1')?.textContent?.trim() || '';
      const priceText = doc.querySelector('[class*="price"]')?.textContent?.trim() || '';
      const description = doc.querySelector('[class*="description"]')?.textContent?.trim() || '';
      
      // Créer un objet item basique
      itemData = {
        id: itemId,
        title: title,
        description: description,
        price: parseFloat(priceText.replace(/[^\d,.]/g, '').replace(',', '.')) || 0,
        currency: 'EUR',
        photos: Array.from(doc.querySelectorAll('img[src*="vinted.net"]')).map(img => ({
          url: img.src
        })).slice(0, 10)
      };
    }
    
    return itemData;
  } catch (error) {
    console.error("[Vinted Item] Erreur lors de la récupération des détails:", error);
    throw error;
  }
}


  
  // ==========================================
  // messagesNotifier.js
  // ==========================================
  
  // Système de notification pour les nouveaux messages

// Configuration
const CONFIG = {
  SHOW_EXISTING_UNREAD: true, // Afficher les notifications pour les messages déjà non lus au démarrage
};

// État du système de notifications
const notificationState = {
  knownConversationIds: new Set(),
  knownUnreadIds: new Set(), // IDs des conversations connues comme non lues
  isInitialized: false,
  pollInterval: null,
  activeNotifications: new Map(), // Map<conversationId, notificationElement>
};

/**
 * Crée ou récupère le conteneur de notifications
 * @returns {HTMLElement} - Conteneur de notifications
 */
function getNotificationContainer() {
  let container = document.getElementById('vinted-notif-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'vinted-notif-container';
    container.className = 'vinted-notif-container';
    document.body.appendChild(container);
  }
  return container;
}

/**
 * Crée une notification popup pour une conversation
 * @param {Object} conversationInfo - Informations de la conversation
 * @returns {HTMLElement} - Élément de notification
 */
function createNotificationElement(conversationInfo) {
  const notification = document.createElement('div');
  notification.className = 'vinted-message-notification';
  notification.dataset.conversationId = conversationInfo.id;
  notification.dataset.expanded = 'false';
  
  notification.innerHTML = `
    <button class="vinted-notif-close" aria-label="Fermer">×</button>
    <div class="vinted-notif-header">
      <img src="${conversationInfo.opposite_user.photo_url || 'https://via.placeholder.com/50'}" 
           alt="${conversationInfo.opposite_user.login}"
           class="vinted-notif-avatar">
    <div class="vinted-notif-content">
      <div class="vinted-notif-username">${conversationInfo.opposite_user.login}</div>
      <div class="vinted-notif-description">${conversationInfo.description}</div>
      </div>
      ${conversationInfo.item_photo ? `
        <img src="${conversationInfo.item_photo}" alt="Article" class="vinted-notif-item-photo">
      ` : ''}
    </div>
    <div class="vinted-notif-messages" style="display: none;">
      <div class="vinted-notif-messages-loading">Chargement...</div>
    </div>
  `;
  
  // Gestionnaire de clic pour déplier/replier la conversation
  const header = notification.querySelector('.vinted-notif-header');
  header.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('vinted-notif-close')) {
      e.preventDefault();
      e.stopPropagation();
      await toggleNotificationExpansion(notification, conversationInfo.id);
    }
  });
  
  // Gestionnaire pour fermer la notification
  const closeBtn = notification.querySelector('.vinted-notif-close');
  closeBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    removeNotification(conversationInfo.id);
  });
  
  return notification;
}

/**
 * Ajoute les styles CSS pour les notifications
 */
function injectNotificationStyles() {
  if (document.getElementById('vinted-notif-styles')) {
    return; // Styles déjà injectés
  }
  
  const style = document.createElement('style');
  style.id = 'vinted-notif-styles';
  style.textContent = `
    .vinted-notif-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      z-index: 10000;
      padding: 0;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 12px;
      overflow-x: auto;
      overflow-y: hidden;
      pointer-events: none;
    }
    
    /* Forcer la transparence du conteneur même en mode sombre */
    .vinted-dark-mode .vinted-notif-container,
    html.vinted-dark-mode .vinted-notif-container,
    body.vinted-dark-mode .vinted-notif-container {
      background: transparent !important;
      background-color: transparent !important;
    }
    
    .vinted-notif-container::-webkit-scrollbar {
      height: 6px;
    }
    
    .vinted-notif-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .vinted-notif-container::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }
    
    .vinted-notif-container::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .vinted-message-notification {
      flex-shrink: 0;
      width: 250px;
      max-width: 250px;
      min-width: 250px;
      height: auto;
      max-height: none;
      min-height: auto;
      background: transparent !important;
      background-color: transparent !important;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      transition: width 0.3s ease, max-width 0.3s ease, min-width 0.3s ease;
      position: relative;
      animation: popIn 0.3s ease;
      display: flex;
      flex-direction: column;
      align-self: flex-end;
      pointer-events: auto;
    }
    
    .vinted-message-notification.vinted-notif-expanded {
      width: 400px !important;
      max-width: 400px !important;
      min-width: 400px !important;
      max-height: 80vh !important;
      height: auto;
      align-self: flex-end;
    }
    
    .vinted-message-notification:not(.vinted-notif-expanded) {
      height: auto;
      max-height: none;
      align-self: flex-end;
    }
    
    .vinted-notif-header {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.15) !important;
      background-color: rgba(255, 255, 255, 0.15) !important;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius: 12px;
      padding: 12px;
    }
    
    .vinted-notif-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #09B1BA;
      flex-shrink: 0;
    }
    
    .vinted-notif-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .vinted-notif-username {
      font-weight: 700;
      font-size: 13px;
      color: #1a1a1a;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .vinted-dark-mode .vinted-notif-username {
      color: #ffffff;
    }
    
    .vinted-notif-description {
      font-size: 11px;
      color: #666;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .vinted-dark-mode .vinted-notif-description {
      color: #aaa;
    }
    
    .vinted-notif-item-photo {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #f0f0f0;
      flex-shrink: 0;
    }
    
    .vinted-dark-mode .vinted-notif-item-photo {
      border-color: #333;
    }
    
    /* Forcer la transparence même en mode sombre */
    .vinted-dark-mode .vinted-message-notification,
    html.vinted-dark-mode .vinted-message-notification,
    body.vinted-dark-mode .vinted-message-notification {
      background: transparent !important;
      background-color: transparent !important;
    }
    
    .vinted-notif-messages {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      max-height: 400px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.15) !important;
      background-color: rgba(255, 255, 255, 0.15) !important;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border-radius: 12px;
      padding: 12px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .vinted-notif-messages::-webkit-scrollbar {
      display: none;
    }
    
    .vinted-dark-mode .vinted-notif-messages {
      border-top-color: rgba(255, 255, 255, 0.1);
    }
    
    .vinted-dark-mode .vinted-notif-header,
    html.vinted-dark-mode .vinted-notif-header,
    body.vinted-dark-mode .vinted-notif-header {
      background: rgba(255, 255, 255, 0.25) !important;
      background-color: rgba(255, 255, 255, 0.25) !important;
    }
    
    .vinted-dark-mode .vinted-notif-messages,
    html.vinted-dark-mode .vinted-notif-messages,
    body.vinted-dark-mode .vinted-notif-messages {
      background: rgba(255, 255, 255, 0.25) !important;
      background-color: rgba(255, 255, 255, 0.25) !important;
    }
    
    
    .vinted-notif-messages-content {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .vinted-notif-messages-loading,
    .vinted-notif-messages-error {
      text-align: center;
      padding: 1rem;
      color: #666;
      font-size: 0.875rem;
    }
    
    .vinted-dark-mode .vinted-notif-messages-loading,
    .vinted-dark-mode .vinted-notif-messages-error {
      color: #aaa;
    }
    
    .vinted-notif-messages-input-container {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .vinted-dark-mode .vinted-notif-messages-input-container {
      border-top-color: rgba(255, 255, 255, 0.1);
    }
    
    .vinted-notif-messages-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 20px;
      font-size: 0.875rem;
      background: rgba(255, 255, 255, 0.5);
      color: #1a1a1a;
      outline: none;
      transition: all 0.2s;
    }
    
    .vinted-notif-messages-input:focus {
      border-color: #09B1BA;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 0 2px rgba(9, 177, 186, 0.2);
    }
    
    .vinted-notif-messages-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .vinted-dark-mode .vinted-notif-messages-input {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      color: #ffffff;
    }
    
    .vinted-dark-mode .vinted-notif-messages-input:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: #09B1BA;
    }
    
    .vinted-notif-messages-input::placeholder {
      color: #999;
    }
    
    .vinted-dark-mode .vinted-notif-messages-input::placeholder {
      color: #666;
    }
    
    .vinted-notif-messages-send {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #09B1BA;
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
      padding: 0;
    }
    
    .vinted-notif-messages-send:hover:not(:disabled) {
      background: #078a91;
      transform: scale(1.05);
    }
    
    .vinted-notif-messages-send:active:not(:disabled) {
      transform: scale(0.95);
    }
    
    .vinted-notif-messages-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .vinted-notif-messages-send svg {
      width: 18px;
      height: 18px;
    }
    
    /* Styles pour les messages dans la notification */
    .vinted-notif-messages .vinted-msg-item {
      max-width: 100%;
      font-size: 0.8125rem;
    }
    
    .vinted-notif-messages .vinted-msg-body {
      padding: 0.5rem 0.75rem;
      font-size: 0.8125rem;
    }
    
    .vinted-notif-messages .vinted-msg-time {
      font-size: 0.6875rem;
    }
    
    .vinted-notif-messages .vinted-msg-status,
    .vinted-notif-messages .vinted-msg-action,
    .vinted-notif-messages .vinted-msg-offer {
      padding: 0.5rem 0.75rem;
      font-size: 0.8125rem;
    }
    
    @keyframes popIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .vinted-message-notification:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }
    
    .vinted-notif-close {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.1);
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-weight: bold;
      z-index: 10;
    }
    
    .vinted-notif-close:hover {
      background: rgba(0, 0, 0, 0.2);
      color: #333;
      transform: scale(1.1);
    }
    
    
    /* Responsive */
    @media (max-width: 768px) {
      .vinted-message-notification {
        width: 160px;
      }
      
      .vinted-notif-avatar {
        width: 40px;
        height: 40px;
      }
      
      .vinted-notif-username {
        font-size: 12px;
      }
      
      .vinted-notif-description {
        font-size: 10px;
      }
      
      .vinted-notif-item-photo {
        height: 80px;
      }
    }
    
    /* Modal de conversation */
    .vinted-conversation-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease;
    }
    
    .vinted-conversation-container {
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      background: rgba(255, 255, 255, 0.95) !important;
      background-color: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }
    
    .vinted-dark-mode .vinted-conversation-container {
      background: rgba(30, 30, 30, 0.95) !important;
      background-color: rgba(30, 30, 30, 0.95) !important;
    }
    
    .vinted-conversation-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-height: 90vh;
    }
    
    .vinted-conversation-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .vinted-conversation-user {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .vinted-conversation-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .vinted-conversation-user-info {
      display: flex;
      flex-direction: column;
    }
    
    .vinted-conversation-username {
      font-weight: 600;
      font-size: 1rem;
      color: #1a1a1a;
    }
    
    .vinted-dark-mode .vinted-conversation-username {
      color: #ffffff;
    }
    
    .vinted-conversation-subtitle {
      font-size: 0.875rem;
      color: #666;
      margin-top: 0.25rem;
    }
    
    .vinted-dark-mode .vinted-conversation-subtitle {
      color: #aaa;
    }
    
    .vinted-conversation-close {
      background: transparent;
      border: none;
      font-size: 2rem;
      line-height: 1;
      color: #666;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .vinted-conversation-close:hover {
      background: rgba(0, 0, 0, 0.1);
      color: #333;
    }
    
    .vinted-dark-mode .vinted-conversation-close {
      color: #aaa;
    }
    
    .vinted-dark-mode .vinted-conversation-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    
    .vinted-conversation-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .vinted-conversation-messages::-webkit-scrollbar {
      width: 6px;
    }
    
    .vinted-conversation-messages::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
    }
    
    .vinted-conversation-messages::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }
    
    .vinted-msg-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      max-width: 70%;
    }
    
    .vinted-msg-current-user {
      align-self: flex-end;
      align-items: flex-end;
    }
    
    .vinted-msg-other-user {
      align-self: flex-start;
      align-items: flex-start;
    }
    
    .vinted-msg-body {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      background: #f0f0f0;
      color: #1a1a1a;
      word-wrap: break-word;
    }
    
    .vinted-msg-current-user .vinted-msg-body {
      background: #09B1BA;
      color: white;
    }
    
    .vinted-dark-mode .vinted-msg-other-user .vinted-msg-body {
      background: #2a2a2a;
      color: #e0e0e0;
    }
    
    .vinted-msg-status,
    .vinted-msg-action,
    .vinted-msg-offer {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      background: #f8f8f8;
      border: 1px solid #e0e0e0;
    }
    
    .vinted-dark-mode .vinted-msg-status,
    .vinted-dark-mode .vinted-msg-action,
    .vinted-dark-mode .vinted-msg-offer {
      background: #2a2a2a;
      border-color: #404040;
    }
    
    .vinted-msg-status-title,
    .vinted-msg-action-title,
    .vinted-msg-offer-title {
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }
    
    .vinted-msg-status-subtitle,
    .vinted-msg-action-subtitle {
      font-size: 0.8125rem;
      color: #666;
    }
    
    .vinted-dark-mode .vinted-msg-status-subtitle,
    .vinted-dark-mode .vinted-msg-action-subtitle {
      color: #aaa;
    }
    
    .vinted-msg-offer-price {
      font-weight: 700;
      font-size: 1.125rem;
      color: #09B1BA;
      margin-top: 0.5rem;
    }
    
    .vinted-msg-offer-original {
      font-size: 0.8125rem;
      color: #999;
      text-decoration: line-through;
      margin-top: 0.25rem;
    }
    
    .vinted-msg-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    
    .vinted-msg-action-btn {
      padding: 0.5rem 1rem;
      background: #09B1BA;
      color: white;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .vinted-msg-action-btn:hover {
      background: #078a91;
      transform: translateY(-1px);
    }
    
    .vinted-msg-time {
      font-size: 0.75rem;
      color: #999;
      margin-top: 0.25rem;
    }
    
    .vinted-dark-mode .vinted-msg-time {
      color: #666;
    }
    
    .vinted-conversation-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    
    .vinted-conversation-link {
      color: #09B1BA;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .vinted-conversation-link:hover {
      color: #078a91;
      text-decoration: underline;
    }
    
    .vinted-conversation-loading {
      padding: 2rem;
      text-align: center;
      color: #666;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .vinted-notif-offer-btn {
      margin: 12px;
      padding: 8px 16px;
      background: #09B1BA;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    
    .vinted-notif-offer-btn:hover {
      background: #078a91;
      transform: translateY(-1px);
    }
    
    .vinted-offer-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20000;
      animation: fadeIn 0.2s ease;
    }
    
    .vinted-offer-modal-content {
      background: rgba(255, 255, 255, 0.15) !important;
      background-color: rgba(255, 255, 255, 0.15) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease;
    }
    
    .vinted-dark-mode .vinted-offer-modal-content {
      background: rgba(255, 255, 255, 0.15) !important;
      background-color: rgba(255, 255, 255, 0.15) !important;
      color: white;
    }
    
    .vinted-offer-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .vinted-dark-mode .vinted-offer-modal-header {
      border-bottom-color: rgba(255, 255, 255, 0.1);
    }
    
    .vinted-offer-modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .vinted-offer-modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .vinted-offer-modal-close:hover {
      background: rgba(0, 0, 0, 0.1);
      color: #000;
    }
    
    .vinted-dark-mode .vinted-offer-modal-close {
      color: #aaa;
    }
    
    .vinted-dark-mode .vinted-offer-modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    
    .vinted-offer-modal-body {
      padding: 1.5rem;
    }
    
    .vinted-offer-modal-body label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.875rem;
    }
    
    .vinted-offer-price-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 1.5rem;
      box-sizing: border-box;
    }
    
    .vinted-offer-price-input:focus {
      outline: none;
      border-color: #09B1BA;
      box-shadow: 0 0 0 3px rgba(9, 177, 186, 0.1);
    }
    
    .vinted-dark-mode .vinted-offer-price-input {
      background: #2a2a2a;
      border-color: #444;
      color: white;
    }
    
    .vinted-offer-modal-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      }
      
    .vinted-offer-modal-cancel,
    .vinted-offer-modal-submit {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      }
      
    .vinted-offer-modal-cancel {
      background: #f0f0f0;
      color: #333;
    }
    
    .vinted-offer-modal-cancel:hover {
      background: #e0e0e0;
      }
      
    .vinted-dark-mode .vinted-offer-modal-cancel {
      background: #333;
      color: white;
    }
    
    .vinted-dark-mode .vinted-offer-modal-cancel:hover {
      background: #444;
    }
    
    .vinted-offer-modal-submit {
      background: #09B1BA;
      color: white;
      }
      
    .vinted-offer-modal-submit:hover {
      background: #078a91;
    }
    
    .vinted-offer-modal-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Styles pour le modal de détails de produit */
    .vinted-item-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20000;
      animation: fadeIn 0.2s ease;
      overflow-y: auto;
      padding: 20px;
    }
    
    .vinted-item-modal-content {
      background: rgba(255, 255, 255, 0.05) !important;
      background-color: rgba(255, 255, 255, 0.05) !important;
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease;
      position: relative;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .vinted-item-modal-content::-webkit-scrollbar {
      display: none;
    }
    
    .vinted-dark-mode .vinted-item-modal-content {
      background: rgba(255, 255, 255, 0.05) !important;
      background-color: rgba(255, 255, 255, 0.05) !important;
      color: white;
    }
    
    .vinted-item-modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: white;
      padding: 0.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
      z-index: 10;
    }
    
    .vinted-item-modal-close:hover {
      background: rgba(0, 0, 0, 0.5);
      transform: scale(1.1);
    }
    
    .vinted-item-modal-body {
      padding: 2rem;
    }
    
    .vinted-item-details {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 2rem;
      align-items: start;
    }
    
    @media (max-width: 768px) {
      .vinted-item-details {
        grid-template-columns: 1fr;
      }
    }
    
    .vinted-item-photos {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      position: sticky;
      top: 2rem;
    }
    
    .vinted-item-photo-main {
      width: 100%;
      max-width: 300px;
      aspect-ratio: 1;
      overflow: hidden;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .vinted-item-photo-main img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .vinted-item-photo-thumbnails {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .vinted-item-photo-thumbnails::-webkit-scrollbar {
      display: none;
    }
    
    .vinted-item-photo-thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .vinted-item-photo-thumb:hover,
    .vinted-item-photo-thumb.active {
      opacity: 1;
      border-color: #09B1BA;
    }
    
    .vinted-item-info {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .vinted-item-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }
    
    .vinted-item-price {
      font-size: 1.75rem;
      font-weight: 700;
      color: #09B1BA;
    }
    
    .vinted-item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .vinted-item-meta-item {
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-size: 0.875rem;
    }
    
    .vinted-item-description {
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      border-radius: 8px;
    }
    
    .vinted-item-description h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .vinted-item-description p {
      margin: 0;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    
    .vinted-item-seller {
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      border-radius: 8px;
    }
    
    .vinted-item-seller h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .vinted-item-seller-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .vinted-item-seller-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .vinted-item-seller-name {
      font-weight: 500;
    }
    
    .vinted-item-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .vinted-item-offer-btn,
    .vinted-item-message-btn {
      flex: 1;
      min-width: 150px;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .vinted-item-offer-btn {
      background: #09B1BA;
      color: white;
    }
    
    .vinted-item-offer-btn:hover {
      background: #078a91;
      transform: translateY(-1px);
    }
    
    .vinted-item-message-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .vinted-item-message-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .vinted-item-conversation {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      border-radius: 8px;
      max-height: 400px;
      display: flex;
      flex-direction: column;
    }
    
    .vinted-item-conversation-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-height: 400px;
    }
    
    .vinted-item-messages-list {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding: 0.5rem 0;
      max-height: 300px;
    }
    
    .vinted-item-messages-list::-webkit-scrollbar {
      display: none;
    }
    
    .vinted-item-messages-input-container {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .vinted-item-messages-input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      color: white;
      font-size: 0.875rem;
      outline: none;
    }
    
    .vinted-item-messages-input:focus {
      border-color: #09B1BA;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .vinted-item-messages-send {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #09B1BA;
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .vinted-item-messages-send:hover:not(:disabled) {
      background: #078a91;
      transform: scale(1.05);
    }
    
    .vinted-item-messages-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .vinted-item-no-messages {
      text-align: center;
      padding: 2rem;
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.875rem;
    }
    
    .vinted-item-conversation-loading,
    .vinted-item-conversation-error {
      text-align: center;
      padding: 1rem;
      color: rgba(255, 255, 255, 0.7);
    }
    
    /* Styles pour les messages dans la conversation de l'item */
    .vinted-item-messages-list .vinted-msg-item {
      margin-bottom: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      max-width: 80%;
      word-wrap: break-word;
    }
    
    .vinted-item-messages-list .vinted-msg-current-user {
      background: rgba(9, 177, 186, 0.2);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      margin-left: auto;
      text-align: right;
    }
    
    .vinted-item-messages-list .vinted-msg-other-user {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      margin-right: auto;
    }
    
    .vinted-item-messages-list .vinted-msg-body {
      color: white;
      font-size: 0.875rem;
      line-height: 1.4;
      margin-bottom: 0.25rem;
    }
    
    .vinted-item-messages-list .vinted-msg-time {
      font-size: 0.6875rem;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 0.25rem;
    }
    
    .vinted-item-pin-btn {
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .vinted-item-pin-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .vinted-item-pin-btn.pinned {
      background: rgba(9, 177, 186, 0.3);
      border-color: #09B1BA;
    }
    
    /* Barre des items épinglés */
    .vinted-pinned-items-bar {
      position: sticky;
      top: 0;
      z-index: 10001;
      background: transparent !important;
      background-color: transparent !important;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      border-bottom: none;
      padding: 0.75rem 1rem;
      width: 100%;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    
    .vinted-pinned-items-bar.scrolled {
      background: #0f172a !important;
      background-color: #0f172a !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 1rem 1.5rem;
      margin-top: 60px; /* Espace pour la navbar de Vinted lors du scroll */
    }
    
    /* S'assurer que le fond est bien appliqué même avec d'autres styles */
    .vinted-pinned-items-bar.scrolled,
    html .vinted-pinned-items-bar.scrolled,
    body .vinted-pinned-items-bar.scrolled {
      background: #0f172a !important;
      background-color: #0f172a !important;
    }
    
    .vinted-pinned-items-container {
      display: flex;
      gap: 0.75rem;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      max-width: 100%;
    }
    
    .vinted-pinned-items-container::-webkit-scrollbar {
      display: none;
    }
    
    .vinted-pinned-item {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      background: transparent;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      width: 60px;
      height: 60px;
      flex-shrink: 0;
      position: relative;
    }
    
    .vinted-pinned-item:hover {
      background: transparent;
      transform: translateY(-2px);
    }
    
    .vinted-pinned-item-photo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .vinted-pinned-item-unpin {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(220, 38, 38, 0.8);
      border: none;
      color: white;
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      transition: all 0.2s;
    }
    
    .vinted-pinned-item-unpin:hover {
      background: rgba(220, 38, 38, 1);
      transform: scale(1.1);
    }
  `;
  
  document.head.appendChild(style);
}

/**
 * Affiche un dialogue pour faire une offre
 * @param {string|number} transactionId - ID de la transaction
 * @param {string|number} conversationId - ID de la conversation
 * @param {HTMLElement} messagesContainer - Conteneur des messages
 * @param {Object} transaction - Objet transaction
 */
function showOfferDialog(transactionId, conversationId, messagesContainer, transaction) {
  // Créer le modal
  const modal = document.createElement('div');
  modal.className = 'vinted-offer-modal';
  modal.innerHTML = `
    <div class="vinted-offer-modal-content">
      <div class="vinted-offer-modal-header">
        <h3>Faire une offre</h3>
        <button class="vinted-offer-modal-close" aria-label="Fermer">&times;</button>
      </div>
      <div class="vinted-offer-modal-body">
        <label for="vinted-offer-price">Prix (EUR)</label>
        <input type="number" 
               id="vinted-offer-price" 
               class="vinted-offer-price-input" 
               placeholder="0.00" 
               step="0.01" 
               min="0.01"
               required>
        <div class="vinted-offer-modal-actions">
          <button class="vinted-offer-modal-cancel">Annuler</button>
          <button class="vinted-offer-modal-submit">Envoyer l'offre</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  const priceInput = modal.querySelector('.vinted-offer-price-input');
  const submitBtn = modal.querySelector('.vinted-offer-modal-submit');
  const cancelBtn = modal.querySelector('.vinted-offer-modal-cancel');
  const closeBtn = modal.querySelector('.vinted-offer-modal-close');
  
  const closeModal = () => {
    document.body.removeChild(modal);
  };
  
  const handleSubmit = async () => {
    const price = priceInput.value.trim();
    if (!price || parseFloat(price) <= 0) {
      alert('Veuillez entrer un prix valide');
      return;
    }
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Envoi...';
    
    try {
      await sendOfferRequest(transactionId, price, 'EUR');
      
      // Recharger la conversation pour afficher la nouvelle offre
      const updatedConversation = await fetchConversation(conversationId);
      const oppositeUserId = updatedConversation.opposite_user.id;
      let currentUserId = oppositeUserId;
      for (const msg of updatedConversation.messages) {
        if (msg.entity_type === 'message' && msg.entity?.user_id && msg.entity.user_id !== oppositeUserId) {
          currentUserId = msg.entity.user_id;
          break;
        }
      }
      
      const conversationUrl = updatedConversation.conversation_url || `https://www.vinted.fr/inbox/${conversationId}`;
      const updatedTransaction = updatedConversation.transaction || transaction;
      const updatedMessagesHtml = updatedConversation.messages.map(msg => 
        formatMessage(msg, currentUserId, conversationUrl, updatedTransaction)
      ).join('');
      
      const messagesContent = messagesContainer.querySelector('.vinted-notif-messages-content');
      messagesContent.innerHTML = updatedMessagesHtml;
      
      // Faire défiler vers le bas
      setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }, 100);
      
      closeModal();
    } catch (error) {
      console.error("[Vinted Messages] Erreur lors de l'envoi de l'offre:", error);
      alert("Erreur lors de l'envoi de l'offre. Veuillez réessayer.");
      submitBtn.disabled = false;
      submitBtn.textContent = 'Envoyer l\'offre';
    }
  };
  
  submitBtn.addEventListener('click', handleSubmit);
  cancelBtn.addEventListener('click', closeModal);
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
  
  priceInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleSubmit();
    }
  });
  
  setTimeout(() => priceInput.focus(), 100);
}

/**
 * Affiche une notification pour une nouvelle conversation non lue
 * @param {Object} conversationInfo - Informations de la conversation
 */
function showNotification(conversationInfo) {
  // Ne pas afficher si déjà affichée
  if (notificationState.activeNotifications.has(conversationInfo.id)) {
    return;
  }
  
  const container = getNotificationContainer();
  const notification = createNotificationElement(conversationInfo);
  container.appendChild(notification);
  
  notificationState.activeNotifications.set(conversationInfo.id, notification);
  
  console.log(`[Vinted Messages] Notification affichée pour la conversation ${conversationInfo.id}`);
}

/**
 * Supprime une notification
 * @param {string} conversationId - ID de la conversation
 */
function removeNotification(conversationId) {
  const notification = notificationState.activeNotifications.get(conversationId);
  
  if (notification) {
    notification.style.animation = 'popIn 0.3s ease reverse';
    setTimeout(() => {
      notification.remove();
      notificationState.activeNotifications.delete(conversationId);
      
      // Supprimer le conteneur s'il est vide
      const container = document.getElementById('vinted-notif-container');
      if (container && container.children.length === 0) {
        container.remove();
      }
    }, 300);
  }
}

/**
 * Formate un message pour l'affichage
 * @param {Object} message - Message de la conversation
 * @param {number} currentUserId - ID de l'utilisateur actuel
 * @param {string} conversationUrl - URL de la conversation
 * @param {Object} transaction - Transaction de la conversation (optionnel)
 * @returns {string} - HTML formaté du message
 */
function formatMessage(message, currentUserId, conversationUrl, transaction = null) {
  const isCurrentUser = message.entity?.user_id === currentUserId;
  const messageClass = isCurrentUser ? 'vinted-msg-current-user' : 'vinted-msg-other-user';
  const timeAgo = message.created_time_ago || new Date(message.created_at_ts).toLocaleString('fr-FR');
  
  let content = '';
  
  if (message.entity_type === 'message') {
    content = `<div class="vinted-msg-body">${escapeHtml(message.entity.body)}</div>`;
  } else if (message.entity_type === 'status_message') {
    content = `
      <div class="vinted-msg-status">
        <div class="vinted-msg-status-title">${escapeHtml(message.entity.title)}</div>
        ${message.entity.subtitle ? `<div class="vinted-msg-status-subtitle">${escapeHtml(message.entity.subtitle)}</div>` : ''}
      </div>
    `;
  } else if (message.entity_type === 'action_message') {
    content = `
      <div class="vinted-msg-action">
        <div class="vinted-msg-action-title">${escapeHtml(message.entity.title)}</div>
        ${message.entity.subtitle ? `<div class="vinted-msg-action-subtitle">${escapeHtml(message.entity.subtitle)}</div>` : ''}
        ${message.entity.actions && message.entity.actions.length > 0 ? `
          <div class="vinted-msg-actions">
            ${message.entity.actions.map(action => {
              // Construire l'URL de l'action si nécessaire
              let actionUrl = conversationUrl;
              if (action.action === 'track_shipment' && transaction?.id) {
                actionUrl = `https://www.vinted.fr/transactions/${transaction.id}`;
              }
              return `<a href="${actionUrl}" target="_blank" class="vinted-msg-action-btn">${escapeHtml(action.title)}</a>`;
            }).join('')}
          </div>
        ` : ''}
      </div>
    `;
  } else if (message.entity_type === 'offer_request_message') {
    content = `
      <div class="vinted-msg-offer">
        <div class="vinted-msg-offer-title">${escapeHtml(message.entity.title)}</div>
        <div class="vinted-msg-offer-price">${escapeHtml(message.entity.price_label)}</div>
        ${message.entity.original_price_label ? `<div class="vinted-msg-offer-original">${escapeHtml(message.entity.original_price_label)}</div>` : ''}
      </div>
    `;
  }
  
  return `
    <div class="vinted-msg-item ${messageClass}">
      ${content}
      <div class="vinted-msg-time">${timeAgo}</div>
    </div>
  `;
}

/**
 * Échappe le HTML pour éviter les injections XSS
 */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * Déplie ou replie une notification pour afficher les messages
 * @param {HTMLElement} notification - Élément de notification
 * @param {string|number} conversationId - ID de la conversation
 */
async function toggleNotificationExpansion(notification, conversationId) {
  const isExpanded = notification.dataset.expanded === 'true';
  const messagesContainer = notification.querySelector('.vinted-notif-messages');
  
  if (isExpanded) {
    // Replier
    notification.dataset.expanded = 'false';
    messagesContainer.style.display = 'none';
    notification.classList.remove('vinted-notif-expanded');
  } else {
    // Déplier
    notification.dataset.expanded = 'true';
    notification.classList.add('vinted-notif-expanded');
    messagesContainer.style.display = 'block';
    
    // Charger les messages si pas déjà chargés
    if (messagesContainer.querySelector('.vinted-notif-messages-loading')) {
      try {
        const conversation = await fetchConversation(conversationId);
        
        // Déterminer l'ID de l'utilisateur actuel
        const oppositeUserId = conversation.opposite_user.id;
        let currentUserId = oppositeUserId;
        for (const msg of conversation.messages) {
          if (msg.entity_type === 'message' && msg.entity?.user_id && msg.entity.user_id !== oppositeUserId) {
            currentUserId = msg.entity.user_id;
            break;
          }
        }
        
        // Construire le HTML des messages
        const conversationUrl = conversation.conversation_url || `https://www.vinted.fr/inbox/${conversationId}`;
        const transaction = conversation.transaction || null;
        const messagesHtml = conversation.messages.map(msg => formatMessage(msg, currentUserId, conversationUrl, transaction)).join('');
        
        // Vérifier si une transaction existe pour afficher le bouton d'offre
        const hasTransaction = transaction && transaction.id;
        const offerButtonHtml = hasTransaction ? `
          <button class="vinted-notif-offer-btn" aria-label="Faire une offre">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            Faire une offre
          </button>
        ` : '';
        
        messagesContainer.innerHTML = `
          <div class="vinted-notif-messages-content">
            ${messagesHtml}
          </div>
          ${offerButtonHtml}
          <div class="vinted-notif-messages-input-container">
            <input type="text" 
                   class="vinted-notif-messages-input" 
                   placeholder="Tapez votre message..."
                   maxlength="1000">
            <button class="vinted-notif-messages-send" aria-label="Envoyer">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </div>
        `;
        
        // Ajouter le gestionnaire d'envoi de message
        const input = messagesContainer.querySelector('.vinted-notif-messages-input');
        const sendBtn = messagesContainer.querySelector('.vinted-notif-messages-send');
        
        const handleSend = async () => {
          const messageText = input.value.trim();
          if (!messageText) return;
          
          // Désactiver l'input et le bouton pendant l'envoi
          input.disabled = true;
          sendBtn.disabled = true;
          sendBtn.style.opacity = '0.5';
          
          try {
            await sendMessage(conversationId, messageText);
            
            // Vider l'input
            input.value = '';
            
            // Recharger la conversation pour afficher le nouveau message
            const updatedConversation = await fetchConversation(conversationId);
            const oppositeUserId = updatedConversation.opposite_user.id;
            let currentUserId = oppositeUserId;
            for (const msg of updatedConversation.messages) {
              if (msg.entity_type === 'message' && msg.entity?.user_id && msg.entity.user_id !== oppositeUserId) {
                currentUserId = msg.entity.user_id;
                break;
              }
            }
            
            const updatedMessagesHtml = updatedConversation.messages.map(msg => 
              formatMessage(msg, currentUserId, conversationUrl, transaction)
            ).join('');
            
            const messagesContent = messagesContainer.querySelector('.vinted-notif-messages-content');
            messagesContent.innerHTML = updatedMessagesHtml;
            
            // Faire défiler vers le bas
            setTimeout(() => {
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
            
          } catch (error) {
            console.error("[Vinted Messages] Erreur lors de l'envoi:", error);
            alert("Erreur lors de l'envoi du message. Veuillez réessayer.");
          } finally {
            // Réactiver l'input et le bouton
            input.disabled = false;
            sendBtn.disabled = false;
            sendBtn.style.opacity = '1';
            input.focus();
          }
        };
        
        sendBtn.addEventListener('click', handleSend);
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
          }
        });
        
        // Gestionnaire pour le bouton d'offre
        if (hasTransaction) {
          const offerBtn = messagesContainer.querySelector('.vinted-notif-offer-btn');
          if (offerBtn) {
            offerBtn.addEventListener('click', () => {
              showOfferDialog(transaction.id, conversationId, messagesContainer, transaction);
            });
          }
        }
        
        // Faire défiler vers le bas et focus sur l'input
        setTimeout(() => {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          input.focus();
        }, 100);
        
      } catch (error) {
        console.error("[Vinted Messages] Erreur lors du chargement de la conversation:", error);
        messagesContainer.innerHTML = '<div class="vinted-notif-messages-error">Erreur lors du chargement</div>';
      }
    }
  }
}

/**
 * Affiche une modal avec la conversation (ancienne fonction, conservée pour compatibilité)
 * @param {string|number} conversationId - ID de la conversation
 */
async function showConversationModal(conversationId) {
  try {
    // Afficher un loader
    const modal = createModalElement();
    document.body.appendChild(modal);
    
    const conversation = await fetchConversation(conversationId);
    
    // Déterminer l'ID de l'utilisateur actuel en analysant les messages
    // L'utilisateur actuel est celui qui n'est pas l'opposite_user
    const oppositeUserId = conversation.opposite_user.id;
    let currentUserId = oppositeUserId; // Par défaut
    
    // Chercher un message de l'utilisateur actuel
    for (const msg of conversation.messages) {
      if (msg.entity_type === 'message' && msg.entity?.user_id && msg.entity.user_id !== oppositeUserId) {
        currentUserId = msg.entity.user_id;
        break;
      }
    }
    
    // Construire le HTML de la conversation
    const conversationUrl = conversation.conversation_url || `https://www.vinted.fr/inbox/${conversationId}`;
    const transaction = conversation.transaction || null;
    const messagesHtml = conversation.messages.map(msg => formatMessage(msg, currentUserId, conversationUrl, transaction)).join('');
    
    const modalContent = modal.querySelector('.vinted-conversation-content');
    modalContent.innerHTML = `
      <div class="vinted-conversation-header">
        <div class="vinted-conversation-user">
          <img src="${conversation.opposite_user.photo?.thumbnails?.find(t => t.type === "thumb100")?.url || conversation.opposite_user.photo?.url || 'https://via.placeholder.com/50'}" 
               alt="${conversation.opposite_user.login}"
               class="vinted-conversation-avatar">
          <div class="vinted-conversation-user-info">
            <div class="vinted-conversation-username">${escapeHtml(conversation.opposite_user.login)}</div>
            ${conversation.subtitle ? `<div class="vinted-conversation-subtitle">${escapeHtml(conversation.subtitle)}</div>` : ''}
          </div>
        </div>
        <button class="vinted-conversation-close" aria-label="Fermer">×</button>
      </div>
      <div class="vinted-conversation-messages">
        ${messagesHtml}
      </div>
      <div class="vinted-conversation-footer">
        <a href="${conversation.conversation_url}" target="_blank" class="vinted-conversation-link">
          Ouvrir sur Vinted →
        </a>
      </div>
    `;
    
    // Gestionnaire pour fermer la modal
    const closeBtn = modal.querySelector('.vinted-conversation-close');
    closeBtn.addEventListener('click', () => closeModal(modal));
    
    // Fermer en cliquant sur l'overlay
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal(modal);
      }
    });
    
    // Fermer avec Escape
    const escapeHandler = (e) => {
      if (e.key === 'Escape') {
        closeModal(modal);
        document.removeEventListener('keydown', escapeHandler);
      }
    };
    document.addEventListener('keydown', escapeHandler);
    
    // Faire défiler vers le bas pour voir les derniers messages
    const messagesContainer = modal.querySelector('.vinted-conversation-messages');
    setTimeout(() => {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 100);
    
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de l'affichage de la conversation:", error);
    alert("Erreur lors du chargement de la conversation. Veuillez réessayer.");
  }
}

/**
 * Crée l'élément modal
 */
function createModalElement() {
  const modal = document.createElement('div');
  modal.className = 'vinted-conversation-modal';
  modal.innerHTML = `
    <div class="vinted-conversation-container">
      <div class="vinted-conversation-content">
        <div class="vinted-conversation-loading">Chargement...</div>
      </div>
    </div>
  `;
  return modal;
}

/**
 * Ferme la modal
 */
function closeModal(modal) {
  modal.style.opacity = '0';
  setTimeout(() => {
    modal.remove();
  }, 300);
}

/**
 * Vérifie les nouveaux messages et affiche les notifications
 */
async function checkNewMessages() {
  try {
    const data = await fetchInbox();
    const unreadConversations = getUnreadConversations(data.conversations);
    
    // Première initialisation
    if (!notificationState.isInitialized) {
      // Mémoriser toutes les conversations
      data.conversations.forEach(conv => {
        notificationState.knownConversationIds.add(conv.id);
        if (conv.unread) {
          notificationState.knownUnreadIds.add(conv.id);
        }
      });
      
      notificationState.isInitialized = true;
      console.log(`[Vinted Messages] Initialisé avec ${notificationState.knownConversationIds.size} conversations connues`);
      
      // Si la config est activée, afficher les notifications pour les messages déjà non lus
      if (CONFIG.SHOW_EXISTING_UNREAD && unreadConversations.length > 0) {
        console.log(`[Vinted Messages] ${unreadConversations.length} message(s) non lu(s) trouvé(s) au démarrage`);
        for (const conv of unreadConversations) {
          const convInfo = formatConversationInfo(conv);
          showNotification(convInfo);
        }
      }
      
      return;
    }
    
    // Créer un Set des IDs des conversations non lues actuelles
    const currentUnreadIds = new Set(unreadConversations.map(c => c.id));
    
    // Détecter les conversations qui sont devenues non lues (nouvelles ou qui redeviennent non lues)
    const newlyUnreadConversations = unreadConversations.filter(conv => {
      // Soit c'est une nouvelle conversation, soit elle était lue avant et est maintenant non lue
      const isNew = !notificationState.knownConversationIds.has(conv.id);
      const becameUnread = !notificationState.knownUnreadIds.has(conv.id) && currentUnreadIds.has(conv.id);
      return isNew || becameUnread;
    });
    
    // Afficher les notifications pour les conversations nouvellement non lues
    for (const conv of newlyUnreadConversations) {
      // Ne pas afficher si déjà affichée
      if (!notificationState.activeNotifications.has(conv.id)) {
      const convInfo = formatConversationInfo(conv);
      showNotification(convInfo);
        console.log(`[Vinted Messages] Nouvelle notification pour la conversation ${conv.id}`);
      }
    }
    
    // Mettre à jour la liste des conversations connues
    data.conversations.forEach(conv => {
      notificationState.knownConversationIds.add(conv.id);
      if (conv.unread) {
        notificationState.knownUnreadIds.add(conv.id);
      } else {
        notificationState.knownUnreadIds.delete(conv.id);
      }
    });
    
    // Fermer les notifications pour les conversations qui ne sont plus non lues
    for (const [convId, notification] of notificationState.activeNotifications) {
      if (!currentUnreadIds.has(convId)) {
        removeNotification(convId);
        notificationState.knownUnreadIds.delete(convId);
      }
    }
    
    if (newlyUnreadConversations.length > 0) {
      console.log(`[Vinted Messages] ${newlyUnreadConversations.length} conversation(s) nouvellement non lue(s)`);
    }
    
  } catch (error) {
    console.error("[Vinted Messages] Erreur lors de la vérification des messages:", error);
  }
}

/**
 * Démarre le système de notifications
 * @param {number} intervalMs - Intervalle de vérification en millisecondes (par défaut 10000 = 10s)
 */
function startMessageNotifications(intervalMs = 10000) {
  // Injecter les styles
  injectNotificationStyles();
  
  // Ne pas démarrer si déjà en cours
  if (notificationState.pollInterval) {
    console.log("[Vinted Messages] Notifications déjà actives");
    return;
  }
  
  console.log(`[Vinted Messages] Démarrage des notifications (intervalle: ${intervalMs}ms)`);
  
  // Première vérification immédiate
  checkNewMessages();
  
  // Vérifications périodiques
  notificationState.pollInterval = setInterval(checkNewMessages, intervalMs);
}

/**
 * Arrête le système de notifications
 */
function stopMessageNotifications() {
  if (notificationState.pollInterval) {
    clearInterval(notificationState.pollInterval);
    notificationState.pollInterval = null;
    console.log("[Vinted Messages] Notifications arrêtées");
  }
  
  // Supprimer toutes les notifications actives
  for (const convId of notificationState.activeNotifications.keys()) {
    removeNotification(convId);
  }
}

/**
 * Réinitialise l'état des notifications
 */
function resetNotificationState() {
  stopMessageNotifications();
  notificationState.knownConversationIds.clear();
  notificationState.isInitialized = false;
}


  
  // ==========================================
  // itemDetails.js
  // ==========================================
  
  // Gestion de l'affichage des détails de produit dans une fenêtre transparente

/**
 * Extrait l'ID et le nom du produit depuis une URL Vinted
 * @param {string} url - URL du produit
 * @returns {Object|null} - {id: string, slug: string} ou null
 */
function extractItemInfoFromUrl(url) {
  // Format: /items/7573189306-giacca-carhartt
  const match = url.match(/\/items\/(\d+)(?:-(.+))?/);
  if (!match) return null;
  
  return {
    id: match[1],
    slug: match[2] || ''
  };
}

/**
 * Affiche les détails d'un produit dans une fenêtre modale transparente
 * @param {string|number} itemId - ID du produit
 * @param {string} itemSlug - Nom/slug du produit (optionnel)
 */
async function showItemDetails(itemId, itemSlug = '') {
  try {
    const item = await fetchItemDetails(itemId, itemSlug);
    if (!item) {
      throw new Error('Produit non trouvé');
    }

    // Créer le modal
    const modal = document.createElement('div');
    modal.className = 'vinted-item-modal';
    modal.innerHTML = `
      <div class="vinted-item-modal-content">
        <button class="vinted-item-modal-close" aria-label="Fermer">&times;</button>
        <div class="vinted-item-modal-body">
          <div class="vinted-item-loading">Chargement...</div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Rendre le contenu
    renderItemDetails(modal, item);
    
    // Gestionnaires d'événements
    const closeBtn = modal.querySelector('.vinted-item-modal-close');
    const closeModal = () => {
      document.body.removeChild(modal);
      isModalOpen = false;
    };
    
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
    
    // Empêcher la fermeture lors du clic dans le contenu
    const content = modal.querySelector('.vinted-item-modal-content');
    content.addEventListener('click', (e) => {
      e.stopPropagation();
    });
    
  } catch (error) {
    console.error("[Vinted Item] Erreur lors de l'affichage des détails:", error);
    alert("Erreur lors du chargement des détails du produit.");
  }
}

/**
 * Rend les détails du produit dans le modal
 * @param {HTMLElement} modal - Élément modal
 * @param {Object} item - Données du produit
 */
function renderItemDetails(modal, item) {
  const body = modal.querySelector('.vinted-item-modal-body');
  
  // Photos - Filtrer pour éviter les doublons et exclure la photo de profil
  let photos = item.photos || [];
  
  // Fonction pour obtenir l'URL formatée (f800)
  const getImageUrl = (photo) => {
    const url = typeof photo === 'string' ? photo : (photo.url || '');
    if (!url) return '';
    // Utiliser le format f800 pour toutes les images
    if (url.includes('/f800/') || url.includes('/f1024/')) {
      return url;
    }
    // Remplacer le format existant par f800
    return url.replace(/\/\d+x\d+\//, '/f800/');
  };
  
  // Filtrer les photos : exclure les photos de profil
  photos = photos.filter(photo => {
    const url = typeof photo === 'string' ? photo : (photo.url || '');
    // Exclure les photos de profil (généralement dans des dossiers spécifiques ou de petite taille)
    if (url.includes('/50x50/') || url.includes('/avatar') || url.includes('/profile') || 
        url.includes('/user') || url.match(/\/\d+x\d+\//)?.[0]?.includes('50x50')) {
      return false;
    }
    return true;
  });
  
  // Dédupliquer par URL (garder seulement les URLs uniques)
  const uniquePhotos = [];
  const seenUrls = new Set();
  for (const photo of photos) {
    const url = getImageUrl(photo);
    if (url && !seenUrls.has(url)) {
      seenUrls.add(url);
      uniquePhotos.push({ url: url });
    }
  }
  photos = uniquePhotos;
  
  const photosHtml = photos.length > 0 ? `
    <div class="vinted-item-photos">
      <div class="vinted-item-photo-main">
        <img src="${getImageUrl(photos[0])}" alt="${item.title}" id="vinted-item-main-photo">
      </div>
      ${photos.length > 1 ? `
        <div class="vinted-item-photo-thumbnails">
          ${photos.map((photo, index) => `
            <img src="${getImageUrl(photo)}" alt="Photo ${index + 1}" 
                 class="vinted-item-photo-thumb ${index === 0 ? 'active' : ''}"
                 data-index="${index}">
          `).join('')}
        </div>
      ` : ''}
    </div>
  ` : '';
  
  // Fonctions utilitaires pour extraire les données
  function formatPrice(item) {
    const amount = item.price?.amount || item.price?.value || item.price || 0;
    const currency = item.price?.currency || item.price?.currency_code || item.currency || "EUR";
    return new Intl.NumberFormat("fr-FR", {
      style: "currency",
      currency: currency,
    }).format(amount);
  }
  
  function extractSize(item) {
    const sizeLabel =
      item.size_title ||
      item.size?.localized_title ||
      item.size?.title ||
      item.size?.brand_size;
    if (!sizeLabel) return null;
    return sizeLabel
      .replace(/^(taille|size)\s+/i, "")
      .replace(/\b(taille unique|unique size)\b/i, "TU")
      .split(/[\s,/|-]+/)[0]
      ?.toUpperCase();
  }
  
  function extractCondition(item) {
    if (typeof item.condition === "string") return item.condition;
    return (
      item.condition?.translated_title ||
      item.condition?.title ||
      item.condition_title ||
      item.status ||
      null
    );
  }
  
  // Informations du produit - utiliser les fonctions d'extraction appropriées
  const price = formatPrice(item) || 'Prix non disponible';
  const size = extractSize(item) || 'Taille non spécifiée';
  const brand = item.brand?.title || item.brand?.name || item.brand_title || (typeof item.brand === 'string' ? item.brand : 'Marque non spécifiée');
  const condition = extractCondition(item) || 'État non spécifié';
  const description = item.description || item.description_text || 'Aucune description';
  
  // Informations du vendeur
  const seller = item.user || {};
  const sellerName = seller.login || 'Vendeur inconnu';
  const sellerAvatar = seller.photo?.url || '';
  
  body.innerHTML = `
    <div class="vinted-item-details">
      ${photosHtml}
      <div class="vinted-item-info">
        <h2 class="vinted-item-title">${escapeHtml(item.title)}</h2>
        <div class="vinted-item-price">${escapeHtml(price)}</div>
        <div class="vinted-item-meta">
          <span class="vinted-item-meta-item">Taille: ${escapeHtml(size)}</span>
          <span class="vinted-item-meta-item">Marque: ${escapeHtml(brand)}</span>
          <span class="vinted-item-meta-item">État: ${escapeHtml(condition)}</span>
        </div>
        <div class="vinted-item-description">
          <h3>Description</h3>
          <p>${escapeHtml(description).replace(/\n/g, '<br>')}</p>
        </div>
        <div class="vinted-item-seller">
          <h3>Vendeur</h3>
          <div class="vinted-item-seller-info">
            ${sellerAvatar ? `<img src="${sellerAvatar}" alt="${sellerName}" class="vinted-item-seller-avatar">` : ''}
            <span class="vinted-item-seller-name">${escapeHtml(sellerName)}</span>
          </div>
        </div>
        <div class="vinted-item-actions">
          <button class="vinted-item-pin-btn" data-item-id="${item.id}" title="Épingler cet article">
            📌 Épingler
          </button>
          <button class="vinted-item-offer-btn" data-item-id="${item.id}">Faire une offre</button>
          <button class="vinted-item-message-btn" data-user-id="${seller.id || ''}" data-item-id="${item.id}">Contacter le vendeur</button>
        </div>
        <div class="vinted-item-conversation" id="vinted-item-conversation-${item.id}">
        </div>
      </div>
    </div>
  `;
  
  // Gestionnaire pour les miniatures de photos
  if (photos.length > 1) {
    const thumbnails = body.querySelectorAll('.vinted-item-photo-thumb');
    const mainPhoto = body.querySelector('#vinted-item-main-photo');
    
    const getImageUrl = (photo) => {
      const url = typeof photo === 'string' ? photo : (photo.url || '');
      if (!url) return '';
      if (url.includes('/f800/') || url.includes('/f1024/')) {
        return url;
      }
      return url.replace(/\/\d+x\d+\//, '/f800/');
    };
    
    thumbnails.forEach(thumb => {
      thumb.addEventListener('click', () => {
        const index = parseInt(thumb.dataset.index);
        mainPhoto.src = getImageUrl(photos[index]);
        thumbnails.forEach(t => t.classList.remove('active'));
        thumb.classList.add('active');
      });
    });
  }
  
  // Gestionnaire pour le bouton d'offre
  const offerBtn = body.querySelector('.vinted-item-offer-btn');
  if (offerBtn) {
    offerBtn.addEventListener('click', () => {
      showOfferDialogForItem(item.id, modal);
    });
  }
  
  // Gestionnaire pour le bouton de message
  const messageBtn = body.querySelector('.vinted-item-message-btn');
  if (messageBtn && seller.id) {
    messageBtn.addEventListener('click', async () => {
      await showConversationForItem(item.id, seller.id, modal, item);
    });
  }
  
  // Gestionnaire pour le bouton d'épinglage
  const pinBtn = body.querySelector('.vinted-item-pin-btn');
  if (pinBtn) {
    const isPinned = isItemPinned(item.id);
    if (isPinned) {
      pinBtn.textContent = '📌 Épinglé';
      pinBtn.classList.add('pinned');
    }
    pinBtn.addEventListener('click', () => {
      togglePinItem(item);
      const isNowPinned = isItemPinned(item.id);
      pinBtn.textContent = isNowPinned ? '📌 Épinglé' : '📌 Épingler';
      pinBtn.classList.toggle('pinned', isNowPinned);
    });
  }
  
  // Charger automatiquement la conversation si elle existe
  if (seller.id) {
    loadConversationForItem(item.id, seller.id, modal, item);
  }
}

/**
 * Affiche le dialogue d'offre pour un produit
 * @param {string|number} itemId - ID du produit
 * @param {HTMLElement} modal - Élément modal parent
 */
function showOfferDialogForItem(itemId, modal) {
  // Créer le modal d'offre
  const offerModal = document.createElement('div');
  offerModal.className = 'vinted-offer-modal';
  offerModal.innerHTML = `
    <div class="vinted-offer-modal-content">
      <div class="vinted-offer-modal-header">
        <h3>Faire une offre</h3>
        <button class="vinted-offer-modal-close" aria-label="Fermer">&times;</button>
      </div>
      <div class="vinted-offer-modal-body">
        <label for="vinted-offer-price">Prix (EUR)</label>
        <input type="number" 
               id="vinted-offer-price" 
               class="vinted-offer-price-input" 
               placeholder="0.00" 
               step="0.01" 
               min="0.01"
               required>
        <div class="vinted-offer-modal-actions">
          <button class="vinted-offer-modal-cancel">Annuler</button>
          <button class="vinted-offer-modal-submit">Envoyer l'offre</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(offerModal);
  
  const priceInput = offerModal.querySelector('.vinted-offer-price-input');
  const submitBtn = offerModal.querySelector('.vinted-offer-modal-submit');
  const cancelBtn = offerModal.querySelector('.vinted-offer-modal-cancel');
  const closeBtn = offerModal.querySelector('.vinted-offer-modal-close');
  
  const closeOfferModal = () => {
    document.body.removeChild(offerModal);
  };
  
  const handleSubmit = async () => {
    const price = priceInput.value.trim();
    if (!price || parseFloat(price) <= 0) {
      alert('Veuillez entrer un prix valide');
      return;
    }
    
    // Pour l'instant, on ne peut pas faire d'offre directement sur un item
    // Il faut d'abord créer une transaction/conversation
    // On va afficher un message d'information
    alert('Pour faire une offre, veuillez d\'abord contacter le vendeur.');
    closeOfferModal();
  };
  
  submitBtn.addEventListener('click', handleSubmit);
  cancelBtn.addEventListener('click', closeOfferModal);
  closeBtn.addEventListener('click', closeOfferModal);
  offerModal.addEventListener('click', (e) => {
    if (e.target === offerModal) closeOfferModal();
  });
  
  priceInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleSubmit();
    }
  });
  
  setTimeout(() => priceInput.focus(), 100);
}

/**
 * Charge la conversation pour un produit
 * @param {string|number} itemId - ID du produit
 * @param {string|number} userId - ID du vendeur
 * @param {HTMLElement} modal - Élément modal parent
 * @param {Object} item - Données du produit
 */
async function loadConversationForItem(itemId, userId, modal, item) {
  const conversationContainer = modal.querySelector(`#vinted-item-conversation-${itemId}`);
  if (!conversationContainer) return;
  
  try {
    // Chercher une conversation existante dans l'inbox
    const inbox = await fetchInbox(1, 50);
    const conversations = inbox.conversations || [];
    
    // Trouver une conversation liée à cet item
    let conversation = conversations.find(conv => {
      return conv.item?.id === parseInt(itemId) || 
             conv.item?.id === itemId ||
             (conv.opposite_user?.id === parseInt(userId) && conv.item);
    });
    
    if (conversation) {
      // Charger les détails de la conversation
      const conversationDetails = await fetchConversation(conversation.id);
      renderConversation(conversationContainer, conversationDetails, itemId, item);
    } else {
      // Aucune conversation trouvée - ne rien afficher (pas de message de chargement)
      // La conversation sera chargée uniquement si l'utilisateur clique sur "Contacter le vendeur"
      conversationContainer.style.display = 'none';
    }
  } catch (error) {
    console.error("[Vinted Item] Erreur lors du chargement de la conversation:", error);
    // Ne pas afficher d'erreur non plus si aucune conversation n'existe
    conversationContainer.style.display = 'none';
  }
}

/**
 * Affiche la conversation pour un produit
 * @param {string|number} itemId - ID du produit
 * @param {string|number} userId - ID du vendeur
 * @param {HTMLElement} modal - Élément modal parent
 * @param {Object} item - Données du produit
 */
async function showConversationForItem(itemId, userId, modal, item) {
  const conversationContainer = modal.querySelector(`#vinted-item-conversation-${itemId}`);
  if (!conversationContainer) return;
  
  // Afficher le conteneur s'il était caché
  conversationContainer.style.display = 'block';
  
  await loadConversationForItem(itemId, userId, modal, item);
}

/**
 * Rend une conversation dans le conteneur
 * @param {HTMLElement} container - Conteneur de conversation
 * @param {Object} conversation - Données de la conversation
 * @param {string|number} itemId - ID du produit
 * @param {Object} item - Données du produit
 */
function renderConversation(container, conversation, itemId, item) {
  const oppositeUserId = conversation.opposite_user?.id;
  if (!oppositeUserId) {
    container.innerHTML = '<div class="vinted-item-conversation-error">Erreur: Impossible de charger la conversation.</div>';
    return;
  }
  
  let currentUserId = oppositeUserId;
  for (const msg of conversation.messages || []) {
    if (msg.entity_type === 'message' && msg.entity?.user_id && msg.entity.user_id !== oppositeUserId) {
      currentUserId = msg.entity.user_id;
      break;
    }
  }
  
  const conversationUrl = conversation.conversation_url || `https://www.vinted.fr/inbox/${conversation.id}`;
  const transaction = conversation.transaction || null;
  
  // Fonction pour formater les messages
  const formatMessage = (msg, userId, url, trans) => {
    const isCurrentUser = msg.entity?.user_id === userId;
    const messageClass = isCurrentUser ? 'vinted-msg-current-user' : 'vinted-msg-other-user';
    const timeAgo = msg.created_time_ago || (msg.created_at_ts ? new Date(msg.created_at_ts * 1000).toLocaleString('fr-FR') : '');
    
    if (msg.entity_type === 'message') {
      return `
        <div class="vinted-msg-item ${messageClass}">
          <div class="vinted-msg-body">${escapeHtml(msg.entity.body)}</div>
          <div class="vinted-msg-time">${escapeHtml(timeAgo)}</div>
        </div>
      `;
    }
    return '';
  };
  
  const messagesHtml = (conversation.messages || []).map(msg => 
    formatMessage(msg, currentUserId, conversationUrl, transaction)
  ).join('');
  
  container.innerHTML = `
    <div class="vinted-item-conversation-content">
      <div class="vinted-item-messages-list">
        ${messagesHtml}
      </div>
      <div class="vinted-item-messages-input-container">
        <input type="text" 
               class="vinted-item-messages-input" 
               placeholder="Tapez votre message..."
               maxlength="1000">
        <button class="vinted-item-messages-send" aria-label="Envoyer">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  `;
  
  // Gestionnaire d'envoi de message
  const input = container.querySelector('.vinted-item-messages-input');
  const sendBtn = container.querySelector('.vinted-item-messages-send');
  
  const handleSend = async () => {
    const messageText = input.value.trim();
    if (!messageText) return;
    
    input.disabled = true;
    sendBtn.disabled = true;
    sendBtn.style.opacity = '0.5';
    
    try {
      // Si on a une conversation, envoyer le message
      if (conversation.id) {
        await sendMessage(conversation.id, messageText);
        // Recharger la conversation
        const updatedConversation = await fetchConversation(conversation.id);
        renderConversation(container, updatedConversation, itemId, item);
      } else {
        // Créer une nouvelle conversation (nécessite l'API Vinted)
        alert('Pour envoyer un message, veuillez d\'abord contacter le vendeur depuis la page du produit.');
      }
      
      input.value = '';
      setTimeout(() => {
        const messagesList = container.querySelector('.vinted-item-messages-list');
        if (messagesList) {
          messagesList.scrollTop = messagesList.scrollHeight;
        }
      }, 100);
    } catch (error) {
      console.error("[Vinted Item] Erreur lors de l'envoi:", error);
      alert("Erreur lors de l'envoi du message. Veuillez réessayer.");
    } finally {
      input.disabled = false;
      sendBtn.disabled = false;
      sendBtn.style.opacity = '1';
      input.focus();
    }
  };
  
  sendBtn.addEventListener('click', handleSend);
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });
  
  // Faire défiler vers le bas
  setTimeout(() => {
    const messagesList = container.querySelector('.vinted-item-messages-list');
    if (messagesList) {
      messagesList.scrollTop = messagesList.scrollHeight;
    }
  }, 100);
}

/**
 * Rend une conversation vide avec la barre d'envoi
 * @param {HTMLElement} container - Conteneur de conversation
 * @param {string|number} userId - ID du vendeur
 * @param {string|number} itemId - ID du produit
 * @param {Object} item - Données du produit
 */
function renderEmptyConversation(container, userId, itemId, item) {
  container.innerHTML = `
    <div class="vinted-item-conversation-content">
      <div class="vinted-item-messages-list">
        <div class="vinted-item-no-messages">Aucun message. Commencez la conversation !</div>
      </div>
      <div class="vinted-item-messages-input-container">
        <input type="text" 
               class="vinted-item-messages-input" 
               placeholder="Tapez votre message..."
               maxlength="1000">
        <button class="vinted-item-messages-send" aria-label="Envoyer">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  `;
  
  // Pour l'instant, on ne peut pas créer de conversation directement
  // L'utilisateur devra utiliser le bouton "Contacter le vendeur" sur la page Vinted
  const input = container.querySelector('.vinted-item-messages-input');
  const sendBtn = container.querySelector('.vinted-item-messages-send');
  
  sendBtn.addEventListener('click', () => {
    alert('Pour envoyer un message, veuillez d\'abord contacter le vendeur depuis la page du produit.');
  });
}

/**
 * Échappe le HTML pour éviter les XSS
 * @param {string} text - Texte à échapper
 * @returns {string} - Texte échappé
 */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Variable pour éviter les doubles clics
let isModalOpen = false;

/**
 * Initialise l'interception des clics sur les produits
 */
function initItemClickInterceptor() {
  // Intercepter les clics sur les liens de produits
  document.addEventListener('click', async (e) => {
    // Éviter les doubles clics
    if (isModalOpen) return;
    
    const link = e.target.closest('a[href*="/items/"]');
    if (!link) return;
    
    const url = link.href || link.getAttribute('href');
    if (!url || !url.includes('/items/')) return;
    
    const itemInfo = extractItemInfoFromUrl(url);
    if (!itemInfo || !itemInfo.id) return;
    
    // Empêcher la redirection
    e.preventDefault();
    e.stopPropagation();
    
    // Marquer comme ouvert
    isModalOpen = true;
    
    // Afficher les détails dans le modal
    await showItemDetails(itemInfo.id, itemInfo.slug);
  }, true); // Utiliser capture pour intercepter avant que le lien ne soit suivi
}

// ==========================================
// Gestion des items épinglés
// ==========================================

const PINNED_ITEMS_STORAGE_KEY = 'vinted_pinned_items';

/**
 * Récupère les items épinglés depuis le stockage
 * @returns {Array} - Liste des items épinglés
 */
function getPinnedItems() {
  try {
    const stored = localStorage.getItem(PINNED_ITEMS_STORAGE_KEY);
    return stored ? JSON.parse(stored) : [];
  } catch (e) {
    return [];
  }
}

/**
 * Sauvegarde les items épinglés
 * @param {Array} items - Liste des items épinglés
 */
function savePinnedItems(items) {
  try {
    localStorage.setItem(PINNED_ITEMS_STORAGE_KEY, JSON.stringify(items));
  } catch (e) {
    console.error("[Vinted Item] Erreur lors de la sauvegarde des items épinglés:", e);
  }
}

/**
 * Vérifie si un item est épinglé
 * @param {string|number} itemId - ID de l'item
 * @returns {boolean}
 */
function isItemPinned(itemId) {
  const pinned = getPinnedItems();
  return pinned.some(item => String(item.id) === String(itemId));
}

/**
 * Épingle ou désépingle un item
 * @param {Object} item - Données de l'item
 */
function togglePinItem(item) {
  const pinned = getPinnedItems();
  const itemId = String(item.id);
  const index = pinned.findIndex(p => String(p.id) === itemId);
  
  if (index >= 0) {
    // Désépingler
    pinned.splice(index, 1);
  } else {
    // Épingler - utiliser la première photo formatée
    const photos = item.photos || [];
    let photoUrl = '';
    if (photos.length > 0) {
      const firstPhoto = photos[0];
      const url = typeof firstPhoto === 'string' ? firstPhoto : (firstPhoto.url || '');
      photoUrl = url.replace(/\/\d+x\d+\//, '/f800/');
    }
    
    pinned.push({
      id: itemId,
      title: item.title,
      price: item.price,
      currency: item.currency || 'EUR',
      photo: photoUrl,
      url: `https://www.vinted.fr/items/${itemId}${item.slug ? '-' + item.slug : ''}`,
      slug: item.slug || ''
    });
  }
  
  savePinnedItems(pinned);
  renderPinnedItemsBar();
}

/**
 * Supprime un item épinglé
 * @param {string|number} itemId - ID de l'item
 */
function unpinItem(itemId) {
  const pinned = getPinnedItems();
  const filtered = pinned.filter(item => String(item.id) !== String(itemId));
  savePinnedItems(filtered);
  renderPinnedItemsBar();
}

/**
 * Rend la barre des items épinglés
 */
function renderPinnedItemsBar() {
  const pinned = getPinnedItems();
  
  // Supprimer l'ancienne barre si elle existe
  const existingBar = document.getElementById('vinted-pinned-items-bar');
  if (existingBar) {
    existingBar.remove();
  }
  
  if (pinned.length === 0) return;
  
  // Créer la barre
  const bar = document.createElement('div');
  bar.id = 'vinted-pinned-items-bar';
  bar.className = 'vinted-pinned-items-bar';
  bar.innerHTML = `
    <div class="vinted-pinned-items-container">
      ${pinned.map(item => `
        <div class="vinted-pinned-item" data-item-id="${item.id}">
          <img src="${item.photo || ''}" alt="${escapeHtml(item.title)}" class="vinted-pinned-item-photo">
          <button class="vinted-pinned-item-unpin" data-item-id="${item.id}" title="Désépingler">×</button>
        </div>
      `).join('')}
    </div>
  `;
  
  // Insérer après la navbar de Vinted
  const header = document.querySelector('header, .l-header, [class*="header"]');
  if (header) {
    header.insertAdjacentElement('afterend', bar);
  } else {
    document.body.insertBefore(bar, document.body.firstChild);
  }
  
  // Gestionnaires d'événements
  bar.querySelectorAll('.vinted-pinned-item').forEach(itemEl => {
    itemEl.addEventListener('click', async (e) => {
      if (e.target.classList.contains('vinted-pinned-item-unpin')) return;
      const itemId = itemEl.dataset.itemId;
      const item = pinned.find(p => String(p.id) === itemId);
      if (item) {
        await showItemDetails(itemId, item.slug);
      }
    });
  });
  
  bar.querySelectorAll('.vinted-pinned-item-unpin').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const itemId = btn.dataset.itemId;
      unpinItem(itemId);
    });
  });
}

// Initialiser quand le DOM est prêt
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    initItemClickInterceptor();
    renderPinnedItemsBar();
  });
} else {
  initItemClickInterceptor();
  renderPinnedItemsBar();
}

// Gérer le style de la barre lors du scroll (fond sombre et padding)
let lastScrollTop = 0;
window.addEventListener('scroll', () => {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  const bar = document.getElementById('vinted-pinned-items-bar');
  
  if (bar) {
    // Ajouter la classe 'scrolled' si on a scrollé plus de 50px
    if (scrollTop > 50) {
      bar.classList.add('scrolled');
      // Forcer le fond bleu marine avec style inline pour s'assurer qu'il s'applique
      bar.style.background = '#0f172a';
      bar.style.backgroundColor = '#0f172a';
    } else {
      bar.classList.remove('scrolled');
      // Remettre transparent quand on revient en haut
      bar.style.background = 'transparent';
      bar.style.backgroundColor = 'transparent';
    }
    
    // Réafficher la barre si nécessaire
    if (Math.abs(scrollTop - lastScrollTop) > 50) {
      bar.style.display = 'block';
    }
  }
  
  lastScrollTop = scrollTop;
});


  
  // ==========================================
  // Initialization
  // ==========================================
  
  // Point d'entrée pour le système de notifications de messages
// Ce fichier est chargé sur toutes les pages Vinted


// Fonction pour vérifier si on est sur une vraie page Vinted (pas une iframe ou autre)
function isMainVintedPage() {
  return window.top === window.self && window.location.hostname === 'www.vinted.fr';
}

// Fonction d'initialisation
function initMessageNotifications() {
  // Vérifier qu'on est sur la page principale
  if (!isMainVintedPage()) {
    console.log("[Vinted Messages] Pas sur la page principale, notifications désactivées");
    return;
  }

  // Vérifier que le système n'est pas déjà initialisé
  if (window.__VINTED_MESSAGE_NOTIFIER_INITIALIZED__) {
    console.log("[Vinted Messages] Système déjà initialisé");
    return;
  }

  // Marquer comme initialisé
  window.__VINTED_MESSAGE_NOTIFIER_INITIALIZED__ = true;

  // Attendre que la page soit prête
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      startSystem();
    });
  } else {
    startSystem();
  }
}

function startSystem() {
  try {
    console.log("[Vinted Messages] 🔔 Démarrage du système de notifications");
    console.log("[Vinted Messages] Intervalle: 10 secondes");
    
    // Démarrer les notifications (toutes les 10 secondes)
    startMessageNotifications(10000);
    
    // Initialiser l'interception des clics sur les produits
    if (typeof initItemClickInterceptor === 'function') {
      initItemClickInterceptor();
      console.log("[Vinted Item] ✅ Interception des clics sur les produits activée");
    }
    
    console.log("[Vinted Messages] ✅ Système démarré avec succès");
  } catch (error) {
    console.error("[Vinted Messages] ❌ Erreur lors du démarrage:", error);
  }
}

// Démarrer l'initialisation
initMessageNotifications();


  
})();
